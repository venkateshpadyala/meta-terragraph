"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[297],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>c});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),d=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=d(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),m=d(n),c=r,h=m["".concat(s,".").concat(c)]||m[c]||u[c]||l;return n?a.createElement(h,i(i({ref:t},p),{},{components:n})):a.createElement(h,i({ref:t},p))}));function c(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,i=new Array(l);i[0]=m;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var d=2;d<l;d++)i[d]=n[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},4757:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>u,frontMatter:()=>l,metadata:()=>o,toc:()=>d});var a=n(7462),r=(n(7294),n(3905));const l={},i="Troubleshooting",o={unversionedId:"runbook/Troubleshooting",id:"runbook/Troubleshooting",title:"Troubleshooting",description:"This document includes troubleshooting steps and addresses frequently asked",source:"@site/../docs/runbook/Troubleshooting.md",sourceDirName:"runbook",slug:"/runbook/Troubleshooting",permalink:"/docs/runbook/Troubleshooting",draft:!1,editUrl:"https://github.com/terragraph/meta-terragraph/edit/main/docs/../docs/runbook/Troubleshooting.md",tags:[],version:"current",frontMatter:{},sidebar:"runbookSidebar",previous:{title:"Testing and Measurements",permalink:"/docs/runbook/Testing"},next:{title:"Appendix",permalink:"/docs/runbook/Appendix"}},s={},d=[{value:"Basic Network Debugging",id:"basic-network-debugging",level:2},{value:"Checking controller status",id:"checking-controller-status",level:3},{value:"Checking network status",id:"checking-network-status",level:3},{value:"All nodes are offline",id:"all-nodes-are-offline",level:3},{value:"PoP nodes are online, and remaining nodes/links are offline",id:"pop-nodes-are-online-and-remaining-nodeslinks-are-offline",level:3},{value:"A specific node is offline",id:"a-specific-node-is-offline",level:3},{value:"A specific link is offline",id:"a-specific-link-is-offline",level:3},{value:"Terragraph unit is unresponsive or not powered",id:"terragraph-unit-is-unresponsive-or-not-powered",level:3},{value:"Fiber is connected to Terragraph, but remote switch/router indicates no link integrity",id:"fiber-is-connected-to-terragraph-but-remote-switchrouter-indicates-no-link-integrity",level:3},{value:"Ethernet is connected to Terragraph, but Ethernet device indicates no link integrity",id:"ethernet-is-connected-to-terragraph-but-ethernet-device-indicates-no-link-integrity",level:3},{value:"Basic Node Debugging",id:"basic-node-debugging",level:2},{value:"First Steps",id:"first-steps",level:3},{value:"Manual Link Bring-Up",id:"manual-link-bring-up",level:3},{value:"Routing",id:"routing",level:2},{value:"Triage",id:"triage",level:3},{value:"Background",id:"background",level:3},{value:"Basic Checks",id:"basic-checks",level:3},{value:"Link Discovery",id:"link-discovery",level:3},{value:"Neighbor Discovery",id:"neighbor-discovery",level:3},{value:"Key-Value Store (<code>KvStore</code>)",id:"key-value-store-kvstore",level:3},{value:"Peers",id:"peers",level:4},{value:"Consistency",id:"consistency",level:4},{value:"Link-State Database (<code>Lsdb</code>)",id:"link-state-database-lsdb",level:3},{value:"Route Computation",id:"route-computation",level:3},{value:"Route Programming",id:"route-programming",level:3},{value:"Logs",id:"logs",level:2},{value:"Log Descriptions",id:"log-descriptions",level:3},{value:"Automatically-Generated Logs",id:"automatically-generated-logs",level:3},{value:"Logs Generated Manually",id:"logs-generated-manually",level:3},{value:"Firmware",id:"firmware",level:2},{value:"What are the signs of firmware crashes?",id:"what-are-the-signs-of-firmware-crashes",level:3},{value:"What are the possible causes of firmware crashes?",id:"what-are-the-possible-causes-of-firmware-crashes",level:3},{value:"What are signs that a node has rebooted unexpectedly?",id:"what-are-signs-that-a-node-has-rebooted-unexpectedly",level:3},{value:"Why can&#39;t a wireless link be established?",id:"why-cant-a-wireless-link-be-established",level:3},{value:"Why is throughput lower than expected?",id:"why-is-throughput-lower-than-expected",level:3},{value:"Change log levels of firmware modules",id:"change-log-levels-of-firmware-modules",level:3},{value:"Watchdog",id:"watchdog",level:2},{value:"Watchdog Logs",id:"watchdog-logs",level:3},{value:"Watchdog Fault Tables",id:"watchdog-fault-tables",level:3},{value:"Disabling the Watchdog",id:"disabling-the-watchdog",level:3},{value:"Manual Upgrades",id:"manual-upgrades",level:2},{value:"Manual Upgrade Steps",id:"manual-upgrade-steps",level:3},{value:"Manual Reverts",id:"manual-reverts",level:2}],p={toc:d};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"troubleshooting"},"Troubleshooting"),(0,r.kt)("p",null,"This document includes troubleshooting steps and addresses frequently asked\nquestions related to Terragraph deployments."),(0,r.kt)("a",{id:"troubleshooting-basic-network"}),(0,r.kt)("h2",{id:"basic-network-debugging"},"Basic Network Debugging"),(0,r.kt)("p",null,"This section describes the workflow for debugging general network issues."),(0,r.kt)("h3",{id:"checking-controller-status"},"Checking controller status"),(0,r.kt)("p",null,"Verify that the ",(0,r.kt)("inlineCode",{parentName:"p"},"e2e_controller")," service is active and running without any\ncritical errors."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"For Docker Swarm installations, use the ",(0,r.kt)("inlineCode",{parentName:"li"},"docker service ls")," and\n",(0,r.kt)("inlineCode",{parentName:"li"},"docker service logs")," commands to show the service state and logs,\nrespectively."),(0,r.kt)("li",{parentName:"ul"},"For legacy systemd installations, use the following commands:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Print the systemd service status\n$ systemctl status e2e_controller\n\n# Stream the controller logs\n$ journalctl -u e2e_controller -f\n")),(0,r.kt)("p",null,"If something appears wrong, verify the controller configuration (see ",(0,r.kt)("a",{parentName:"p",href:"/docs/runbook/Deployment"},"Deployment\nand Installation"),")."),(0,r.kt)("h3",{id:"checking-network-status"},"Checking network status"),(0,r.kt)("p",null,"Run the following commands on the controller to find the current status of all\nnodes and links in the network:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Print topology information, including node/link status\n$ tg2 topology ls\n\n# Print node IPv6 addresses and software versions\n$ tg2 controller status\n")),(0,r.kt)("p",null,"In a healthy network, the status of all DNs should be ",(0,r.kt)("inlineCode",{parentName:"p"},"ONLINE_INITITATOR"),", and\nall CNs should be ",(0,r.kt)("inlineCode",{parentName:"p"},"ONLINE"),". There should be a status report for every node in\nthe network."),(0,r.kt)("h3",{id:"all-nodes-are-offline"},"All nodes are offline"),(0,r.kt)("p",null,"If all nodes are offline, including PoP nodes, check the routing from the PoP\nnodes to the controller."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Check that the PoP node has been configured correctly (see\n",(0,r.kt)("a",{parentName:"li",href:"/docs/runbook/Deployment"},"Deployment and Installation"),")."),(0,r.kt)("li",{parentName:"ul"},"Verify that firewall rules are not blocking communication. Disabling\n",(0,r.kt)("inlineCode",{parentName:"li"},"firewalld")," is recommended to ensure no restrictions are in place. Otherwise,\nsee ",(0,r.kt)("a",{parentName:"li",href:"/docs/runbook/Deployment"},"Deployment and Installation")," for a list of ports used by\nthe cloud services.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ systemctl stop firewalld\n$ systemctl disable firewalld\n\n# If NMS is installed on the same host, restart Docker as well to re-add its iptables rules\n$ systemctl restart docker\n")),(0,r.kt)("h3",{id:"pop-nodes-are-online-and-remaining-nodeslinks-are-offline"},"PoP nodes are online, and remaining nodes/links are offline"),(0,r.kt)("p",null,"Check the status of a PoP node with the ",(0,r.kt)("inlineCode",{parentName:"p"},"tg2 topology ls")," command:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ONLINE")," - The PoP node is unable to ignite the network due to GPS issues.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Check the GPS lock on each PoP node using the command below. There should\nbe a 3D fix and ideally 16 GPS satellites locked to each Terragraph\ndevice.")))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'$ tg2 stats driver-if | grep -e "tgd.gpsStat.fixType" -e "tgd.gpsStat.fixNumSat"\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ONLINE_INITIATOR")," - There is likely a routing issue from all other nodes.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Check the route on the gateway or controller towards the Terragraph\nnetwork for the Terragraph prefix."),(0,r.kt)("li",{parentName:"ul"},"Check that BGP is working. Use the command below to print the default\nroutes on the PoP node; there should be a default route towards nic2.")))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ ip -6 route\ndefault via fe80::66d1:54ff:feeb:a863 dev nic2 proto zebra metric 1024 pref medium\n")),(0,r.kt)("h3",{id:"a-specific-node-is-offline"},"A specific node is offline"),(0,r.kt)("p",null,"If the controller sees a node as ",(0,r.kt)("inlineCode",{parentName:"p"},"OFFLINE"),", but it can be reached in-band, check\nthe following items:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Verify that the node ID (MAC address) in the topology file matches the one on\nthe node. This can be printed on the node using the following command:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ get_hw_info NODE_ID\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Verify that the controller URL on the node is correct:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'$ cat /tmp/mynetworkinfo | grep e2eCtrlUrl\n  "e2eCtrlUrl": "tcp://[2001::1]:7007",\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Verify that the minion is running and attempting to report to the controller:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ tail -f /var/log/e2e_minion/current\nI0419 13:12:50.506603  3202 StatusApp.cpp:744] Reporting status to controller\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Try to ping the controller from node. If the controller is pingable, check\nif TCP port 7007 is open (as described in an earlier section)."),(0,r.kt)("li",{parentName:"ul"},"Verify that the default route (",(0,r.kt)("inlineCode",{parentName:"li"},"::/0"),') in the routing table points to the\nPoP node. Refer to the "Routing" section for additional troubleshooting steps.')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ breeze fib list\n...\n> ::/0\nvia fe80::250:43ff:fe59:a9c5@nic2\n")),(0,r.kt)("h3",{id:"a-specific-link-is-offline"},"A specific link is offline"),(0,r.kt)("p",null,"If a link is down and is not being ignited, check the following items:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},'Verify that "auto-ignition" on the controller is not disabled for the link or\nthe entire network.')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ tg ignition state\n14:19:23 [INFO]: IgnitionState(\n    ...\n    igParams=IgnitionParams(\n        enable=True,\n        ...\n        linkAutoIgnite={}))\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If there are continuously increasing ",(0,r.kt)("em",{parentName:"li"},"ignition attempts")," (as seen in\n",(0,r.kt)("inlineCode",{parentName:"li"},"tg2 topology ls"),"), check the failure reason or look for any error messages in\nthe minion or firmware logs. Refer to the\n",(0,r.kt)("a",{parentName:"li",href:"/docs/runbook/Troubleshooting#troubleshooting-fw"},"Firmware")," section for additional\ntroubleshooting steps.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'# See LinkDownCause in DriverMessage.thrift\n$ tg2 stats driver-if | grep "linkDown.cause"\n')),(0,r.kt)("h3",{id:"terragraph-unit-is-unresponsive-or-not-powered"},"Terragraph unit is unresponsive or not powered"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Verify that the unit has power.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Unscrew the power cable gland."),(0,r.kt)("li",{parentName:"ul"},"Verify that the power connector for the primary sector is securely\ninserted."),(0,r.kt)("li",{parentName:"ul"},"Use a digital multimeter to verify that the Terragraph power terminal\nblock has the correct DC voltage and polarity."))),(0,r.kt)("li",{parentName:"ul"},"Power cycle the unit. Remove and reseat the power connector, or disconnect\npower to the power supply, then reconnect it."),(0,r.kt)("li",{parentName:"ul"},"If the problem persists, replace the unit.")),(0,r.kt)("h3",{id:"fiber-is-connected-to-terragraph-but-remote-switchrouter-indicates-no-link-integrity"},"Fiber is connected to Terragraph, but remote switch/router indicates no link integrity"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Verify that the device at the other end of the fiber is powered on and\nconfigured correctly."),(0,r.kt)("li",{parentName:"ul"},"Verify that the fiber settings at both sides of the connection match, and\nare set as follows:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Fiber type: Single or Multi-mode"),(0,r.kt)("li",{parentName:"ul"},"SFPs: Single or Multi-mode"),(0,r.kt)("li",{parentName:"ul"},"Speed: 1Gb or 10Gb"))),(0,r.kt)("li",{parentName:"ul"},"Verify that the fiber cable polarity is plugged in correctly at both ends.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Near side SFP - RX/TX connects to far side SFP - TX/RX."))),(0,r.kt)("li",{parentName:"ul"},"Using a fiber cable tester, verify that the fiber running to the Terragraph\nunit has received light power."),(0,r.kt)("li",{parentName:"ul"},"Plug the fiber cable into a known good SFP module."),(0,r.kt)("li",{parentName:"ul"},"Plug the known good SFP module into the Terragraph unit."),(0,r.kt)("li",{parentName:"ul"},"If the problem persists, replace the unit.")),(0,r.kt)("h3",{id:"ethernet-is-connected-to-terragraph-but-ethernet-device-indicates-no-link-integrity"},"Ethernet is connected to Terragraph, but Ethernet device indicates no link integrity"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Verify that the Ethernet device is powered on and configured correctly."),(0,r.kt)("li",{parentName:"ul"},"If the Ethernet device is powered by PoE, verify that it is connected to the\nunit."),(0,r.kt)("li",{parentName:"ul"},"Test the Ethernet cable from the Terragraph unit on a known good laptop."),(0,r.kt)("li",{parentName:"ul"},"Remove the Ethernet cable from the Terragraph unit and use a cable tester to\nverify the cable integrity."),(0,r.kt)("li",{parentName:"ul"},"If the problem persists, replace the unit.")),(0,r.kt)("a",{id:"troubleshooting-basic-node"}),(0,r.kt)("h2",{id:"basic-node-debugging"},"Basic Node Debugging"),(0,r.kt)("p",null,"This section lists steps for triaging node-level issues, mainly useful during\ndevelopment or initial hardware bring-up."),(0,r.kt)("h3",{id:"first-steps"},"First Steps"),(0,r.kt)("p",null,"The commands below provide a starting point for debugging and are not meant to\nbe comprehensive."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Check the node configuration.")," Look for any modifications in the node\nconfiguration file and understand why they are there.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ diff_node_config\n$ cat /data/cfg/node_config.json\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Check software/firmware versions.")," Are there matching or compatible\nversions running on all nodes?")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ tg2 version          # show versions for several components\n$ cat /etc/tgversion   # show Terragraph build version\n$ get_fw_version       # show firmware version number\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Verify hardware information.")," In particular, check that MAC addresses are\nas expected (radio MAC addresses may depend on the node configuration field\n",(0,r.kt)("inlineCode",{parentName:"li"},"envParams.VPP_USE_EEPROM_MACS"),").")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ cat /tmp/node_info\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Look for core dumps.")," If anything crashed, understand why.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ ls -al /var/volatile/cores/\n$ ls /data/kernel_crashes/vmcore.*\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Use CLIs.")," Use CLI commands to check the state of important services.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# -- e2e_minion --\n$ tg2 minion status\n$ tg2 minion links\n$ tg2 stats driver-if\n$ tg2 stats system --dump\n$ tg2 tech-support\n# -- openr --\n$ breeze lm links\n$ breeze kvstore adj\n$ breeze fib list\n$ breeze tech-support\n# -- vpp --\n$ vppctl show int\n$ vppctl show int addr\n$ vppctl show ip6 fib\n# -- exabgp --\n$ exabgpcli show neighbor summary\n$ exabgpcli show adj-rib in\n$ exabgpcli show adj-rib out\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Check service logs.")," Make sure important services are running properly. See\n",(0,r.kt)("a",{parentName:"li",href:"/docs/runbook/Troubleshooting#troubleshooting-logs"},"Logs")," for descriptions of log files.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ tail -F /var/log/e2e_minion/current\n$ tail -F /var/log/vpp/current\n$ tail -F /var/log/vpp/vnet.log\n...\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Check kernel logs.")," Terragraph driver logs can be seen in syslog files or\n",(0,r.kt)("inlineCode",{parentName:"li"},"dmesg"),".")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ dmesg -w\n$ tail -F /var/log/kern.log\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Check firmware logs.")," If possible, enable firmware logs using the node\nconfiguration field ",(0,r.kt)("inlineCode",{parentName:"li"},"envParams.FW_LOGGING_ENABLED"),". See\n",(0,r.kt)("a",{parentName:"li",href:"/docs/runbook/Troubleshooting#troubleshooting-fw"},"Firmware")," for troubleshooting steps\nand instructions on configuring the log verbosity.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ tail -f /var/log/wil6210/wil6210_*_fw_*.txt\n")),(0,r.kt)("h3",{id:"manual-link-bring-up"},"Manual Link Bring-Up"),(0,r.kt)("p",null,"To establish a single Terragraph link manually using only the E2E minion, follow\nthe short list of steps below."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Generate a new node configuration file using default values.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ mv /data/cfg/node_config.json /data/cfg/node_config.json.bak\n$ config_get_base /data/cfg/node_config.json\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Only if a GPS fix is unavailable (or there is no GPS module present), disable\nthe GPS sync check in firmware on the initiator node.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ config_set -i radioParamsBase.fwParams.forceGpsDisable 1\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Reboot the node.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ reboot\n")),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},"Wait for the E2E minion to initialize and then show the radio MAC addresses.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ tg2 minion status\n")),(0,r.kt)("ol",{start:5},(0,r.kt)("li",{parentName:"ol"},"Enable GPS sync.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ tg2 minion gps_enable\n")),(0,r.kt)("ol",{start:6},(0,r.kt)("li",{parentName:"ol"},"Set the wireless channel (e.g. channel 2).")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ tg2 minion set_params -c 2\n")),(0,r.kt)("ol",{start:7},(0,r.kt)("li",{parentName:"ol"},"Associate the link from the initiator node using radio MAC addresses above.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ tg2 minion assoc -i <initiator_mac> -m <responder_mac> -n dn\n")),(0,r.kt)("p",null,"At this point, verify that all expected components are working:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"tg2 minion links")," shows the link established at the driver/firmware layer."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"breeze lm links")," shows the link established at the routing layer."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ping6 ff02::1%terraX"),' (find "X" from output above) shows "DUP" responses\nconfirming link-local connectivity.'),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"vppctl show int"),' shows incrementing "vpp-terraX" interface counters.')),(0,r.kt)("a",{id:"troubleshooting-routing"}),(0,r.kt)("h2",{id:"routing"},"Routing"),(0,r.kt)("h3",{id:"triage"},"Triage"),(0,r.kt)("p",null,"Run the command below to print debug information for an engineer to examine."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ breeze tech-support\n")),(0,r.kt)("h3",{id:"background"},"Background"),(0,r.kt)("p",null,"Every link-state routing protocol incorporates the following steps and\ncomponents:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Link discovery")," - Learn the underlying system's link information,\nincluding name, status, and addresses."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Neighbor discovery")," - Discover neighbors on the VLAN of each link."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Link-state database")," - Record the neighbor and prefix information for each\nnode."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Route computation")," - Use the global link-state database to compute a route to\neach destination."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Route programming")," - Program routes onto the underlying system.")),(0,r.kt)("p",null,"Routing can fail if a problem occurs in any of these stages. It is always\nrecommended to troubleshoot issues serially."),(0,r.kt)("h3",{id:"basic-checks"},"Basic Checks"),(0,r.kt)("p",null,"Verify that Open/R is running ",(0,r.kt)("em",{parentName:"p"},"and not crashing"),". To do so, run the following\ncommand several times and check that the process ID has not changed:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ ps -A | grep openr\n")),(0,r.kt)("p",null,"If applicable, do the same for the ",(0,r.kt)("inlineCode",{parentName:"p"},"fib_vpp")," process."),(0,r.kt)("h3",{id:"link-discovery"},"Link Discovery"),(0,r.kt)("p",null,"Use the following command to list all links known to Open/R's ",(0,r.kt)("inlineCode",{parentName:"p"},"LinkMonitor"),"\nmodule:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ breeze lm links\n\n== Node Overload: NO  ==\n\nInterface  Status  Overloaded  Metric Override  ifIndex  Addresses\n---------  ------  ----------  ---------------  -------  ------------------------\nnic1       Up                                         3  fe80::250:43ff:fe46:dbbb\nnic2       Up                                         4  fe80::250:c2ff:fec9:9e9a\n")),(0,r.kt)("p",null,"Any interface on the system must be seen by Open/R before neighbor discovery can\nbe performed. Look for the following issues:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},'Make sure all expected links are listed with the correct status ("Up" or "Down")\nand address.'),(0,r.kt)("li",{parentName:"ul"},'If a link status is "Down", check if a lower layer is down (L2 or driver issue).'),(0,r.kt)("li",{parentName:"ul"},"If a link is not listed, then the link is not configured on the system (driver\nissue)."),(0,r.kt)("li",{parentName:"ul"},"A node or interface should ",(0,r.kt)("em",{parentName:"li"},"not"),' be "overloaded" unless undergoing a drain\noperation. If the "overload" flag is incorrectly set, run the appropriate\ncommand to unset it:')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ breeze lm unset-node-overload\n$ breeze lm unset-link-overload <interface>\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If pinging any of the link-local addresses is unsuccessful, then either a\nproblem exists in the underlying driver/lower layer or the other end of the\nlink is not ignited correctly.")),(0,r.kt)("h3",{id:"neighbor-discovery"},"Neighbor Discovery"),(0,r.kt)("p",null,"Use the following command to list the adjacencies that have propagated to\nOpen/R's ",(0,r.kt)("inlineCode",{parentName:"p"},"KvStore"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ breeze kvstore adj\n\n> node-01.02.03.04.05.06's adjacencies, version: 3, Node  Label: 1064, Overloaded?: False\nNeighbor                Local Interface    Remote  Interface      Metric    Weight    Adj Label  NextHop-v4     NextHop-v6                   Uptime\nnode-00.00.00.10.0e.45  terra0              terra0                     1         1            0   0.0.0.0       fe80::200:ff:fe10:e45        8d1h\nnode-00.00.00.10.0e.47  nic2                nic2                       1         1            0   0.0.0.0       fe80::250:c2ff:fec9:9c5d     8d1h\n")),(0,r.kt)("p",null,"If an expected neighbor is missing over a working link, then go through the\nfollowing steps:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Verify that link-local multicast packets are received from the neighboring\nnode.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ tcpdump -i terra0 udp port 6666\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on terra0, link-type EN10MB (Ethernet), capture size 262144 bytes\n15:17:25.350335 IP6 fe80::200:ff:fe10:e45.6666 > ip6-allnodes.6666: UDP, length 189\n15:17:26.189291 IP6 fe80::3a3a:21ff:feb0:29d.6666 > ip6-allnodes.6666: UDP, length  189\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If the link-local multicast packets are not received, check if the ",(0,r.kt)("inlineCode",{parentName:"li"},"MULTICAST"),"\nconfiguration is set on the interface.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ ip link show terra0\n12: terra0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000\n    link/ether 00:00:00:10:0b:47 brd ff:ff:ff:ff:ff:ff\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},'If packets are going through but no adjacencies are formed, verify that both\nends of the link are using the same domain. Open/R will not form adjacencies\nbetween nodes with different domains. The domain is set in the Open/R\nconfiguration file ("domain" field in ',(0,r.kt)("inlineCode",{parentName:"li"},"/var/run/openr_config.json"),").")),(0,r.kt)("h3",{id:"key-value-store-kvstore"},"Key-Value Store (",(0,r.kt)("inlineCode",{parentName:"h3"},"KvStore"),")"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"KvStore")," provides a data bus for distributed computing, as it enables all nodes\nto have the same view of the network."),(0,r.kt)("h4",{id:"peers"},"Peers"),(0,r.kt)("p",null,"Every neighbor listed in the adjacencies database should be added as a ",(0,r.kt)("inlineCode",{parentName:"p"},"KvStore"),"\npeer. Use the following command to list all peers:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ breeze kvstore peers\n\n== node-01.02.03.04.05.06's peers  ==\n\n> node-00.00.00.10.0e.45\ncmd via tcp://[fe80::200:ff:fe10:e45%terra0]:60002\n\n> node-00.00.00.10.0e.47\ncmd via tcp://[fe80::250:c2ff:fec9:9c5d%nic2]:60002\n")),(0,r.kt)("p",null,"If the same neighbor appears over multiple links, it is added only once into\n",(0,r.kt)("inlineCode",{parentName:"p"},"KvStore"),". This could happen when, for instance, two PoP sites have a wireless\nlink between them along with a wired link (required for PoP nodes). Open/R will\ntypically sync on the wired link, and the wireless link will never be used for\nany traffic. A Terragraph watchdog monitors all wireless links to check if any\ndata is flowing, and will restart the E2E minion if no data is passed for a few\nminutes. ",(0,r.kt)("strong",{parentName:"p"},"This should be prevented in Terragraph by not allowing wireless links\nbetween PoP sites.")),(0,r.kt)("h4",{id:"consistency"},"Consistency"),(0,r.kt)("p",null,"In steady state and under stable network conditions, all nodes should report the\nsame keys and hashes for each. This can be seen using the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ breeze kvstore keys\n")),(0,r.kt)("h3",{id:"link-state-database-lsdb"},"Link-State Database (",(0,r.kt)("inlineCode",{parentName:"h3"},"Lsdb"),")"),(0,r.kt)("p",null,"Every node in the network contributes two major pieces of information to\n",(0,r.kt)("inlineCode",{parentName:"p"},"KvStore")," with the following key format:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"adj:<node-name>")," - The node's adjacency information."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"prefix:<node-name>")," - The network prefix owned/proxied by the node.")),(0,r.kt)("p",null,"Use the following command to dump all keys:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ breeze kvstore keys\n\n== Available keys in KvStore  ==\n\nKey                            OriginatorId              Version  Hash\n-----------------------------  ----------------------  ---------  ----------\nadj:node-00.00.00.10.0e.42     node-00.00.00.10.0e.42          4  3845919268\nallocprefix:188                node-00.00.00.10.0e.42          1  3527252845\nprefix:node-00.00.00.10.0e.42  node-00.00.00.10.0e.42          9  520548462\n...\n")),(0,r.kt)("p",null,"Verify that the ",(0,r.kt)("inlineCode",{parentName:"p"},"prefix")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"adj")," keys are present for all nodes. Otherwise,\nfollow these steps to troubleshoot:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If prefixes are missing, check that the Open/R prefix allocator is enabled\n(i.e. either ",(0,r.kt)("inlineCode",{parentName:"li"},"OPENR_ALLOC_PREFIX")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"OPENR_STATIC_PREFIX_ALLOC")," is set in the\nconfiguration file). The following command lists the prefixes advertised by\nall nodes:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ breeze kvstore prefixes --nodes all\n")),(0,r.kt)("h3",{id:"route-computation"},"Route Computation"),(0,r.kt)("p",null,"Open/R's ",(0,r.kt)("inlineCode",{parentName:"p"},"Decision")," module consumes the global link-state database from\n",(0,r.kt)("inlineCode",{parentName:"p"},"KvStore")," and, on each node, computes the best path to all other prefixes and\ngenerates routing information. Along with the best paths, Loop-Free Alternates\n(LFAs) are also programmed."),(0,r.kt)("p",null,"Use the following command to request the routing table from ",(0,r.kt)("inlineCode",{parentName:"p"},"Decision")," module:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ breeze decision routes\n\n== Routes for node-00.00.00.10.0b.47  ==\n\n> 2001:a:b:c::/64\nvia fe80::200:ff:fe10:b4c@terra0 metric 2\n\n...\n\n> ::/0\nvia fe80::250:43ff:fe59:a9c5@nic2 metric 4\nvia fe80::250:43ff:fef2:130a@nic2 metric 5\n")),(0,r.kt)("p",null,"When troubleshooting routes to a particular prefix, verify that a route has been\ncomputed and that the metric values are correct for the best next-hops (lower is\nmore preferable)."),(0,r.kt)("h3",{id:"route-programming"},"Route Programming"),(0,r.kt)("p",null,"Routes computed by the ",(0,r.kt)("inlineCode",{parentName:"p"},"Decision")," module are then programmed by the ",(0,r.kt)("inlineCode",{parentName:"p"},"Fib")," agent\n(ex. ",(0,r.kt)("inlineCode",{parentName:"p"},"fib_vpp"),") via Thrift APIs."),(0,r.kt)("p",null,"Use the following command to print all routes on the ",(0,r.kt)("inlineCode",{parentName:"p"},"Fib")," agent:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ breeze fib list\n\n== node-00.00.00.10.0b.47's FIB routes by client 786  ==\n\n> 2001:a:b:c::/64\nvia fe80::200:ff:fe10:b4c@terra0\n\n...\n\n> ::/0\nvia fe80::250:43ff:fe59:a9c5@nic2\n")),(0,r.kt)("p",null,"When troubleshooting routes to a particular prefix, verify that the intended\nnext-hop is programmed. Otherwise, follow these steps to troubleshoot:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If a route is missing but was reported by the ",(0,r.kt)("inlineCode",{parentName:"li"},"Decision")," module, then it is\na sync error that may be resolved by restarting the ",(0,r.kt)("inlineCode",{parentName:"li"},"openr")," service."),(0,r.kt)("li",{parentName:"ul"},"If applicable, check that routes are programmed correctly into the VPP FIB\nby running the command below.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ vppctl show ip6 fib\n")),(0,r.kt)("a",{id:"troubleshooting-logs"}),(0,r.kt)("h2",{id:"logs"},"Logs"),(0,r.kt)("p",null,"This section describes important logs generated on Terragraph nodes."),(0,r.kt)("h3",{id:"log-descriptions"},"Log Descriptions"),(0,r.kt)("p",null,"The table below provides a non-exhaustive list of log files."),(0,r.kt)("p",null,"Note that the logs in ",(0,r.kt)("inlineCode",{parentName:"p"},"/var")," are archived to flash on each reboot and also\nperiodically, so a longer continuous log history is often available."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Log"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/data/log/reboot_history")),(0,r.kt)("td",{parentName:"tr",align:null},'Time and reason for each reboot. These are rotated (older file is suffixed ".2").')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/data/format_data.log")),(0,r.kt)("td",{parentName:"tr",align:null},"Contains the timestamp when the /data partition required re-formatting and re-initialization. The reformat attempts to preserve some configuration, but not logs.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/e2e_minion/current")),(0,r.kt)("td",{parentName:"tr",align:null},"E2E minion logs.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/e2e_minion/process_history")),(0,r.kt)("td",{parentName:"tr",align:null},"E2E minion startup history, created the first time that the minion restarts.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/e2e_controller/current")),(0,r.kt)("td",{parentName:"tr",align:null},"E2E controller logs (when running the controller on a TG node).")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/stats_agent/current")),(0,r.kt)("td",{parentName:"tr",align:null},"Stats agent logs.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/fluent-bit/current")),(0,r.kt)("td",{parentName:"tr",align:null},"Fluent Bit (log daemon) logs.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/openr/current")),(0,r.kt)("td",{parentName:"tr",align:null},"Open/R (routing daemon) logs.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/fib_vpp/current")),(0,r.kt)("td",{parentName:"tr",align:null},"Open/R VPP FIB agent logs.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/exabgp/current")),(0,r.kt)("td",{parentName:"tr",align:null},"ExaBGP (BGP daemon) logs.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/gpsd/current")),(0,r.kt)("td",{parentName:"tr",align:null},"gpsd (GPS daemon) logs.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/vpp/current")),(0,r.kt)("td",{parentName:"tr",align:null},"VPP startup logs.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/vpp/vnet.log")),(0,r.kt)("td",{parentName:"tr",align:null},"VPP and DPDK logs, including ",(0,r.kt)("inlineCode",{parentName:"td"},"wil6210")," and ",(0,r.kt)("inlineCode",{parentName:"td"},"dpaa2")," Poll Mode Driver (PMD) logs.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/vpp-debug.log")),(0,r.kt)("td",{parentName:"tr",align:null},"VPP CLI (",(0,r.kt)("inlineCode",{parentName:"td"},"vppctl"),") command history.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/vpp_chaperone/current")),(0,r.kt)("td",{parentName:"tr",align:null},"VPP configuration service logs.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/wil6210/")),(0,r.kt)("td",{parentName:"tr",align:null},"Directory containing firmware and microcode logs when using the node configuration field ",(0,r.kt)("inlineCode",{parentName:"td"},"envParams.FW_LOGGING_ENABLED"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/kern.log")),(0,r.kt)("td",{parentName:"tr",align:null},"Kernel and TG driver logs.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/dmesg")),(0,r.kt)("td",{parentName:"tr",align:null},"Recent items in ",(0,r.kt)("inlineCode",{parentName:"td"},"kern.log"),", also accessible via the ",(0,r.kt)("inlineCode",{parentName:"td"},"dmesg")," command.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Linux crash (panic) logs"),(0,r.kt)("td",{parentName:"tr",align:null},"Panic logs and kernel context are saved in a dedicated flash partition. On Puma, the kernel message log is saved to ",(0,r.kt)("inlineCode",{parentName:"td"},"/data/kernel_crashes/vmcore.<date>"),". Note that the node will reboot within 3 minutes of a kernel crash.")))),(0,r.kt)("p",null,"If the software watchdog is enabled, the following logs will also be generated:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Log"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/wdog_repair_history")),(0,r.kt)("td",{parentName:"tr",align:null},'Log of every watchdog-initiated repair since the last reboot. These are rotated (older file is suffixed ".2").')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/openr/openr_debug.log")),(0,r.kt)("td",{parentName:"tr",align:null},"Periodic traceroute logs collected by the watchdog when no PoP node was reachable. The log also shows the times when PoP nodes were unknown. This log is rotated, and the older version has a suffix.")))),(0,r.kt)("h3",{id:"automatically-generated-logs"},"Automatically-Generated Logs"),(0,r.kt)("p",null,"Certain log files are collected continuously on the temporary filesystem in the\n",(0,r.kt)("inlineCode",{parentName:"p"},"/var/log/")," directory. These include logs for Terragraph software as well as\nsystem state. The files in this directory are archived and rotated to the flash\nin ",(0,r.kt)("inlineCode",{parentName:"p"},"/data/log/logs.x.tar.gz")," (with x=1 being the latest), both periodically and\nbefore reboots. Note that some less frequently updated logs only exist on the\nflash within ",(0,r.kt)("inlineCode",{parentName:"p"},"/data/log/")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"/data/"),"."),(0,r.kt)("h3",{id:"logs-generated-manually"},"Logs Generated Manually"),(0,r.kt)("p",null,"An extensive system dump archive can be created manually in\n",(0,r.kt)("inlineCode",{parentName:"p"},"/tmp/sysdump-<date>.tgz")," using the ",(0,r.kt)("inlineCode",{parentName:"p"},"sys_dump")," command."),(0,r.kt)("a",{id:"troubleshooting-fw"}),(0,r.kt)("h2",{id:"firmware"},"Firmware"),(0,r.kt)("p",null,"This section contains frequently asked questions relating to firmware issues."),(0,r.kt)("h3",{id:"what-are-the-signs-of-firmware-crashes"},"What are the signs of firmware crashes?"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The node has no RF links."),(0,r.kt)("li",{parentName:"ul"},"A radio displays unknown status:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ tg2 minion status\n\nRadio MAC           Status           GPS Sync\n------------------  ---------------  ---------\n00:00:00:10:0b:47   N/A (crashed?)   false\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"There are firmware core dumps present.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ ls -al /var/volatile/cores/wil6210_fw_core_*\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The E2E minion logs indicate that a Wigig device is down:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ tail -f /var/log/e2e_minion/current\nI0305 00:06:12.570667  3342 StatusApp.cpp:1196] <00:00:00:10:0b:47> Device status: DOWN\n")),(0,r.kt)("h3",{id:"what-are-the-possible-causes-of-firmware-crashes"},"What are the possible causes of firmware crashes?"),(0,r.kt)("p",null,"Firmware-related error messages are printed out by the wil6210 Poll Mode Driver\n(PMD) in VPP logs which are found in ",(0,r.kt)("inlineCode",{parentName:"p"},"/var/log/vpp/vnet.log"),". Causes include the\nfollowing:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The initialization of the firmware failed. The VPP logs show messages such as:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Firmware not ready after x ms\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"A firmware assert occurred. Assert codes can be used to identify specific\nfirmware errors. The VPP logs show messages such as:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Firmware error detected, assert codes FW <hex fw assert code>, UCODE <hex ucode assert code>\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The node is not configured as an RF node. This fundamental setting is\ncontrolled by a variable read from EEPROM, ",(0,r.kt)("inlineCode",{parentName:"li"},"tg_if2if"),", which must be set to 0\nfor RF nodes.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'# Check if configured as an IF node\n$ get_hw_info TG_IF2IF\n1\n# Switch between RF/IF node\n$ db_eeprom=$(fdtget /sys/firmware/fdt /chosen eeprom)\n$ fdtput -p "$db_eeprom" -t i /board tg-if2if <0|1>\n')),(0,r.kt)("h3",{id:"what-are-signs-that-a-node-has-rebooted-unexpectedly"},"What are signs that a node has rebooted unexpectedly?"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Unexpected reboots are logged in the file ",(0,r.kt)("inlineCode",{parentName:"li"},"/data/log/reboot_history"),'. If the\n"dirty" tag appears ',(0,r.kt)("em",{parentName:"li"},"by itself"),' on any line, it indicates an abnormal reboot\nwhich was not initiated by the "reboot" command or the watchdog.')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ cat /data/log/reboot_history\nup 1523315537 Mon, 09 Apr 2018 16:12:17 -0700 dirty\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Linux crashes will create logs in a dedicated flash partition. On Puma, the\nkernel message log is saved to ",(0,r.kt)("inlineCode",{parentName:"li"},"/data/kernel_crashes/vmcore.<date>"),".")),(0,r.kt)("h3",{id:"why-cant-a-wireless-link-be-established"},"Why can't a wireless link be established?"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Verify that at least one end of the link is in the ",(0,r.kt)("inlineCode",{parentName:"li"},"ONLINE_INITIATOR")," state.\nTypically, it should take less than a minute for a sector to transition from\n",(0,r.kt)("inlineCode",{parentName:"li"},"ONLINE")," to ",(0,r.kt)("inlineCode",{parentName:"li"},"ONLINE_INITIATOR"),". If the node remains only ",(0,r.kt)("inlineCode",{parentName:"li"},"ONLINE"),", then it\nhas not acquired GPS timing and cannot initiate a wireless link. This can be\nverified via the firmware stat ",(0,r.kt)("inlineCode",{parentName:"li"},"tgf.<mac_addr>.tsf.syncModeGps"),", which will\nbe 0 (instead of 1).",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"There are potential issues if the following firmware stats are increasing:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"tgf.<mac_addr>.gps.numMissedSec"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"tgf.<mac_addr>.gps.numPpsErr")))),(0,r.kt)("li",{parentName:"ul"},"Check the following stats to see why the GPS chip may not be able to\nestimate time (and position):",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"tgd.gpsStat.fixNumSat")," - Must be at least 1, or at least 4 if the\nsite location is missing from the topology."))),(0,r.kt)("li",{parentName:"ul"},"Check the list of all satellites visible to the GPS chip:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"tgd.gpsStat.<id>.used")," - Whether this satellite is in use."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"tgd.gpsStat.<id>.snr")," - Usable satellites would typically have SNR\ngreater than 25."))))),(0,r.kt)("li",{parentName:"ul"},"Verify that beamforming (BF) messages (Tx/Rx) are being successfully\nexchanged using the commands below. On the initiator node, the\n",(0,r.kt)("inlineCode",{parentName:"li"},"tgf.MAC.mgmtTx.bfTrainingReq")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"tgf.MAC.mgmtRx.bfTrainingRsp")," stats\nshould be non-zero. On the responder node, the ",(0,r.kt)("inlineCode",{parentName:"li"},"tgf.MAC.mgmtRx.bfTrainingReq"),"\nand ",(0,r.kt)("inlineCode",{parentName:"li"},"tgf.MAC.mgmtTx.bfTrainingRsp")," stats should be non-zero. If this is not\nthe case, then check for misalignment between the nodes.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'$ tg2 stats driver-if | grep -e "bfTrainingReq" -e "bfTrainingRsp"\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The node configuration for over-the-air (OTA) encryption should match on\nboth ends of the link. Verify that the ",(0,r.kt)("inlineCode",{parentName:"li"},"wsecEnable")," config field is the same\non both nodes, as well as 802.1X parameters if applicable."),(0,r.kt)("li",{parentName:"ul"},'Verify that the interface stats for "RX packets" and "TX packets" are\nincreasing, which indicates that the link is active.')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ ifconfig terra0\nterra0 Link encap:Ethernet HWaddr 02:08:02:00:01:00\ninet6 addr: fe80::8:2ff:fe00:100/64 Scope:Link\n UP BROADCAST RUNNING MULTICAST MTU:7800 Metric:1\nRX packets:7260 errors:0 dropped:0 overruns:0 frame:0\n TX packets:7264 errors:0 dropped:0 overruns:0 carrier:0\ncollisions:0 txqueuelen:1000\n RX bytes:1429692 (1.3 MiB) TX bytes:1428796 (1.3 MiB)\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Initiate a ping on both nodes, either using the other end's IPv6 address as\nthe destination or doing a multicast ping on the link's interface. If this\nping succeeds, then the link is active.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Ping the destination IPv6 address\n$ ping6 fe80::8:2ff:fe00:103%terra0\n# Ping the multicast address\n$ ping6 ff02::1%terra0\n")),(0,r.kt)("h3",{id:"why-is-throughput-lower-than-expected"},"Why is throughput lower than expected?"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Check the firmware stats for PER (",(0,r.kt)("inlineCode",{parentName:"li"},"tgf.<mac_addr>.staPkt.perE6"),") and MCS\n(",(0,r.kt)("inlineCode",{parentName:"li"},"tgf.<mac_addr>.staPkt.mcs"),"). The PER should be close to 0%. The MCS should\nbe greater than 9 for high throughput.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'$ tg2 stats driver-if | grep -e "staPkt.mcs" -e "staPkt.perE6"\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Check the CPU usage on the Linux host and the firmware. The host CPU usage is\ntracked via the system stat ",(0,r.kt)("inlineCode",{parentName:"li"},"cpu.util"),". The firmware CPU usage can be viewed\nvia the stat ",(0,r.kt)("inlineCode",{parentName:"li"},"tgf.<mac_addr>.miscSys.cpuLoadAvg"),", which captures the ",(0,r.kt)("em",{parentName:"li"},"idle"),"\nCPU as a percentage; if this stat drops to 3 or less, then the firmware is\noverloaded.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'$ tg2 stats driver-if | grep "cpuLoadAvg"\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Make sure that firmware info logs are disabled. Running the command below\nwill enable only error logging:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ tg2 minion fw_set_log_config -l error\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Check that firmware is not in BF responder mode, which reserves the Rx BF\nslots and reduces maximum throughput by roughly 50%. If a sector is in\nresponder mode, the following firmware stats will indicate the Rx BF slot\ncount incrementing while the Tx BF slot count remains constant.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'$ tg2 stats driver-if | grep -e "slot.numOfRxBfSlotsPgmrd" -e "slot.numOfTxBfSlotsPgmrd"\n')),(0,r.kt)("h3",{id:"change-log-levels-of-firmware-modules"},"Change log levels of firmware modules"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Show all supported firmware modules and logging levels:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ tg2 minion fw_set_log_config --help\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Change the logging level:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# set logging level to 'info' for all fw modules\n$ tg2 minion fw_set_log_config -l info\n# set logging level to 'debug' for a specific node and specific fw modules\n$ tg2 minion fw_set_log_config -m la_tpc -m framer -m tpc -l debug\n")),(0,r.kt)("a",{id:"troubleshooting-watchdog"}),(0,r.kt)("h2",{id:"watchdog"},"Watchdog"),(0,r.kt)("p",null,"The Terragraph watchdog is a collection of monitors that observes different\naspects of a node's health. These monitors perform various repair actions,\nincluding reboots when necessary."),(0,r.kt)("h3",{id:"watchdog-logs"},"Watchdog Logs"),(0,r.kt)("p",null,"All watchdog actions are timestamped and logged to the following locations:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"/var/log/wdog_repair_history")," - Log of every watchdog-initiated repair\nsince the last reboot."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"/data/log/reboot_history")," - Reason for each reboot, including reboots that\nwere not initiated by the watchdog.")),(0,r.kt)("p",null,"Both of the above logs are rotated, and the older rotations are renamed with a\nnumeric suffix. Copies of ",(0,r.kt)("inlineCode",{parentName:"p"},"wdog_repair_history")," are archived to flash in\n",(0,r.kt)("inlineCode",{parentName:"p"},"/data/log/")," at least once before rebooting."),(0,r.kt)("h3",{id:"watchdog-fault-tables"},"Watchdog Fault Tables"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The tables below list all detected faults."),(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"/var/log/")," files mentioned in the fault tables are also archived to flash\nin ",(0,r.kt)("inlineCode",{parentName:"li"},"/data/log/")," on reboot.")),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Fault Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"),(0,r.kt)("th",{parentName:"tr",align:null},"Repair Action"),(0,r.kt)("th",{parentName:"tr",align:null},"Keyword in repair/reboot history"),(0,r.kt)("th",{parentName:"tr",align:null},"Fault-specific logs and comments"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"POP"),(0,r.kt)("td",{parentName:"tr",align:null},"No PoP node was reachable for 1 hour"),(0,r.kt)("td",{parentName:"tr",align:null},"Reboot"),(0,r.kt)("td",{parentName:"tr",align:null},"pop_unreachable"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("ul",null,(0,r.kt)("li",null,"Traceroute logs are saved in ",(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/openr")," every few minutes when PoP is unreachable.")," ",(0,r.kt)("li",null,"The log also indicates the times when the PoP nodes were unknown.")," ",(0,r.kt)("li",null,"Use the ",(0,r.kt)("inlineCode",{parentName:"td"},"get_pop_ip")," command to find the PoP nodes currently known to the unit.")))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"UPG"),(0,r.kt)("td",{parentName:"tr",align:null},"On first boot of an upgrade image, E2E minion was unable to connect to the controller for several minutes"),(0,r.kt)("td",{parentName:"tr",align:null},"Revert to previous TG image and reboot"),(0,r.kt)("td",{parentName:"tr",align:null},"testcode-timed-out"),(0,r.kt)("td",{parentName:"tr",align:null},"n/a")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"LINK"),(0,r.kt)("td",{parentName:"tr",align:null},"No RF link formed for some minutes (default 15) on a baseband card that was healthy at least once since the last e2e_minion startup."),(0,r.kt)("td",{parentName:"tr",align:null},"Reload FW on all baseband cards and restart E2E minion"),(0,r.kt)("td",{parentName:"tr",align:null},"prog-","[macAddress]","-nolink"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("ul",null,(0,r.kt)("li",null,"The reported mac address is the first baseband card on which the fault was detected."),(0,r.kt)("li",null,"The actual timeout is a determined by the ",(0,r.kt)("inlineCode",{parentName:"td"},"radioParamsBase.fwParams.noLinkTimeout")," config parameter."),(0,r.kt)("li",null,(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/fwdumps/RF/")," (rotated log archives)")))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"FW"),(0,r.kt)("td",{parentName:"tr",align:null},"Firmware has crashed, or the datapath from FW to Linux is dead on a baseband card that was healthy at least once since the last e2e_minion startup."),(0,r.kt)("td",{parentName:"tr",align:null},"Reload FW on all baseband cards and restart E2E minion"),(0,r.kt)("td",{parentName:"tr",align:null},"prog-","[macAddress]","-timeout"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("ul",null,(0,r.kt)("li",null,"The reported mac address is the first baseband card on which the fault was detected.")," ",(0,r.kt)("li",null,(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/fwdumps/RF/")," (rotated log archives)")))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"BBINIT"),(0,r.kt)("td",{parentName:"tr",align:null},"None of the baseband cards was initialized with a mac address for 1 minute after the last e2e_minion restart, or internal error."),(0,r.kt)("td",{parentName:"tr",align:null},"Reload FW on all baseband cards and restart E2E minion"),(0,r.kt)("td",{parentName:"tr",align:null},"prog-init"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/fwdumps/RF/")," (rotated log archives)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"PEER"),(0,r.kt)("td",{parentName:"tr",align:null},"Some RF links are up, but none reached its peer for 1 minute"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("ul",null,(0,r.kt)("li",null,"Reload FW on all baseband cards and restart E2E minion"))),(0,r.kt)("td",{parentName:"tr",align:null},"link_monit.sh"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/log/fwdumps/RF/")," (rotated log archives)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"E2E"),(0,r.kt)("td",{parentName:"tr",align:null},"Failed to restart E2E minion"),(0,r.kt)("td",{parentName:"tr",align:null},"Reboot"),(0,r.kt)("td",{parentName:"tr",align:null},"e2e_minion_restart_failed_prog, e2e_minion_restart_failed_link"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("ul",null,(0,r.kt)("li",null,"Restarting e2e minion also reloads the FW, reloads drivers, and initializes the FW.")," ",(0,r.kt)("li",null,"The suffix (",(0,r.kt)("inlineCode",{parentName:"td"},"_prog")," and ",(0,r.kt)("inlineCode",{parentName:"td"},"_link"),") identifies the specific health monitor that failed to restart e2e minion.")))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"GPS"),(0,r.kt)("td",{parentName:"tr",align:null},"GPS is in a bad or unlocked state continuously for 30 minutes (the timeout persists across reboots)."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("ul",null,(0,r.kt)("li",null,"Log the fault without repairing it"))),(0,r.kt)("td",{parentName:"tr",align:null},"gps"),(0,r.kt)("td",{parentName:"tr",align:null},"n/a")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"CFG1"),(0,r.kt)("td",{parentName:"tr",align:null},"A unit running with an new/unverified config did not connect to the controller for about 7 minutes."),(0,r.kt)("td",{parentName:"tr",align:null},"Reboot and fall back to the previous, working configuration"),(0,r.kt)("td",{parentName:"tr",align:null},"config-fallback-timed-out"),(0,r.kt)("td",{parentName:"tr",align:null},"n/a")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"CFG2"),(0,r.kt)("td",{parentName:"tr",align:null},"A unit with a config change since startup, rebooted before connecting to the controller, and also before the deadline to do so expired."),(0,r.kt)("td",{parentName:"tr",align:null},"Start up with the unverified new config"),(0,r.kt)("td",{parentName:"tr",align:null},"config-unverified-new-config"),(0,r.kt)("td",{parentName:"tr",align:null},"Some config changes only take effect after a re-start, so we allow one re-start with an unverified new config.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"CFG3"),(0,r.kt)("td",{parentName:"tr",align:null},"A unit that booted up with an unverified new config, rebooted before connecting to the controller, and also before the deadline to do so expired."),(0,r.kt)("td",{parentName:"tr",align:null},"Reboot and fall back to the previous, working configuration"),(0,r.kt)("td",{parentName:"tr",align:null},"config-fallback"),(0,r.kt)("td",{parentName:"tr",align:null},"n/a")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"DATA"),(0,r.kt)("td",{parentName:"tr",align:null},"/data flash partition is full"),(0,r.kt)("td",{parentName:"tr",align:null},"Reboot and clean up /data"),(0,r.kt)("td",{parentName:"tr",align:null},"fsys-data-full"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("ul",null,(0,r.kt)("li",null,"The reboot history may be truncated.")," ",(0,r.kt)("li",null,"When ",(0,r.kt)("inlineCode",{parentName:"td"},"/data"),' is completely full, the "fsys-data-full" reboot reason may not show up in the reboot history.'),(0,r.kt)("li",null,"Only the ",(0,r.kt)("inlineCode",{parentName:"td"},"/data/log")," directory is cleaned up.")))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"TMP"),(0,r.kt)("td",{parentName:"tr",align:null},"/tmp is full"),(0,r.kt)("td",{parentName:"tr",align:null},"Reboot and also clean up /data if necessary"),(0,r.kt)("td",{parentName:"tr",align:null},"fsys-tmp-full"),(0,r.kt)("td",{parentName:"tr",align:null},"n/a")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"VPP"),(0,r.kt)("td",{parentName:"tr",align:null},"The vpp cli (",(0,r.kt)("inlineCode",{parentName:"td"},"vppctl"),") has deadlocked"),(0,r.kt)("td",{parentName:"tr",align:null},"Restart vpp"),(0,r.kt)("td",{parentName:"tr",align:null},"vpp_cli"),(0,r.kt)("td",{parentName:"tr",align:null},"n/a")))),(0,r.kt)("h3",{id:"disabling-the-watchdog"},"Disabling the Watchdog"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Some watchdogs can be temporarily disabled during troubleshooting to avoid\nundesirable repair actions and reboots."),(0,r.kt)("li",{parentName:"ul"},"The maximum watchdog disable period is one day."),(0,r.kt)("li",{parentName:"ul"},"The watchdogs that monitor the filesystem, revert upgrades, and revert config\ncannot be disabled.")),(0,r.kt)("p",null,"The watchdog CLI provides the following commands for disabling watchdogs:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Disable all non-critical watchdogs for 45 minutes (max 1440 minutes, or 1 day)\n/etc/init.d/watchdog.sh dis 45\n\n# Re-enable all watchdogs\n/etc/init.d/watchdog.sh en\n")),(0,r.kt)("a",{id:"troubleshooting-upgrades"}),(0,r.kt)("h2",{id:"manual-upgrades"},"Manual Upgrades"),(0,r.kt)("p",null,"Software upgrades on Terragraph nodes should normally be performed using the NMS\nUI or TG CLI (see ",(0,r.kt)("a",{parentName:"p",href:"/docs/runbook/Maintenance"},"Maintenance and Configuration"),"). If this is\nnot possible, then manual upgrades can be performed ",(0,r.kt)("strong",{parentName:"p"},"but should only be used as\na last resort"),". The Terragraph upgrade image, ",(0,r.kt)("inlineCode",{parentName:"p"},"tg-update-qoriq.bin"),",\nis a self-extracting binary file."),(0,r.kt)("h3",{id:"manual-upgrade-steps"},"Manual Upgrade Steps"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Sanity check the release/version of the TG upgrade binary. This can be done\nin a Bash shell before copying the image to the node, or afterwards on the\nnode (following step 3).")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'$ ./tg-update-qoriq.bin -m\n{\n"version":"Facebook Terragraph Release RELEASE_M70-0-g1ad294cc0 michaelcallahan@devvm4933 2021-03-05T17:21:02",\n"md5":"d0149fe85367780989ea642fe0bd480b",\n"model":"NXP TG Board",\n"hardwareBoardIds":["NXP_LS1048A_PUMA"]\n}\n')),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Temporarily disable watchdogs to ensure that the node will not reboot during\nthe upgrade.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Disable watchdogs for 20 minutes\n$ /etc/init.d/watchdog.sh dis 20\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Copy the upgrade image to the ",(0,r.kt)("inlineCode",{parentName:"li"},"/tmp/")," directory on the node, replacing the\nIP address in the command below with the correct IP. Check that the\nexecutable permission was preserved (SCP should do this automatically).")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ scp tg-update-qoriq.bin root@[2001::1]:/tmp/\n")),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},"Write the new image to the flash, then boot it up.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ /tmp/tg-update-qoriq.bin -wrt\n")),(0,r.kt)("ol",{start:5},(0,r.kt)("li",{parentName:"ol"},"Log back into the node after it has rebooted, and sanity check the new image\nversion.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ cat /etc/tgversion\nFacebook Terragraph Release RELEASE_M70-0-g1ad294cc0 michaelcallahan@devvm4933 2021-03-05T17:21:02\n")),(0,r.kt)("ol",{start:6},(0,r.kt)("li",{parentName:"ol"},'Finalize the upgrade. Step 4 boots the node into a "test" state in which a\nreboot for any reason causes an automatic fallback to the old image;\nfinalization cancels this "test" state.')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# This command also prints info about the flash partitions,\n# and it is safe to use when there is no new image to finalize.\n$ testcode c\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Note:")," If the new image is not finalized within 6 minutes, ",(0,r.kt)("em",{parentName:"p"},"and")," the E2E\nminion is enabled, ",(0,r.kt)("em",{parentName:"p"},"and"),' it is unable to connect to the E2E controller, then\nthe watchdog will trigger a reboot and revert to the previous image. The\n"test" state and the reversion are safety features that prevent bricking\nthe node in all stages of the upgrade process. The "test" upgrade state can be\nskipped if absolutely necessary by issuing a different command in Step 4:'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ /tmp/tg-update-qoriq.bin -ur\n")),(0,r.kt)("a",{id:"troubleshooting-reverts"}),(0,r.kt)("h2",{id:"manual-reverts"},"Manual Reverts"),(0,r.kt)("p",null,'It is sometimes convenient to manually revert to the inactive/secondary boot\nimage. This can only be done when the unit is not in the middle of an upgrade,\nand not in the "test" state described in the "Manual Upgrades" section above.'),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Sanity check the TG version of the secondary boot image. Make sure that it\nis what you expect.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ testcode v\nTG version in secondary boot partition (/dev/mmcblk0p2)\nFacebook Terragraph Release RELEASE_M70-0-g1ad294cc0 michaelcallahan@devvm4933 2021-03-05T17:21:02\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Swap the roles of the primary and secondary boot partitions.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ testcode x\nSwapping the roles of the primary (/dev/mmcblk0p1) and\nthe secondary (/dev/mmcblk0p2) boot partitions.\nDone\nReboot now to activate the new primary image!\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Reboot to activate the newly designated primary image.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ reboot\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Note:")," You can undo the revert request between Steps 2 and 3 as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ testcode c\n")))}u.isMDXComponent=!0}}]);