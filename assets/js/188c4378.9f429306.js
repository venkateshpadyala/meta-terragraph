"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[3078],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>u});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),d=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=d(e.components);return a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},k=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),k=d(n),u=r,g=k["".concat(s,".").concat(u)]||k[u]||m[u]||l;return n?a.createElement(g,i(i({ref:t},p),{},{components:n})):a.createElement(g,i({ref:t},p))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,i=new Array(l);i[0]=k;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var d=2;d<l;d++)i[d]=n[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}k.displayName="MDXCreateElement"},8277:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>m,frontMatter:()=>l,metadata:()=>o,toc:()=>d});var a=n(7462),r=(n(7294),n(3905));const l={},i="Deployment and Installation",o={unversionedId:"runbook/Deployment",id:"runbook/Deployment",title:"Deployment and Installation",description:"This document describes the installation procedure for the E2E controller and",source:"@site/../docs/runbook/Deployment.md",sourceDirName:"runbook",slug:"/runbook/Deployment",permalink:"/docs/runbook/Deployment",draft:!1,editUrl:"https://github.com/terragraph/meta-terragraph/edit/main/docs/../docs/runbook/Deployment.md",tags:[],version:"current",frontMatter:{},sidebar:"runbookSidebar",previous:{title:"Network Planning",permalink:"/docs/runbook/Planning"},next:{title:"Maintenance and Configuration",permalink:"/docs/runbook/Maintenance"}},s={},d=[{value:"Cloud Services",id:"cloud-services",level:2},{value:"Docker Swarm Installation",id:"docker-swarm-installation",level:3},{value:"System Requirements",id:"system-requirements",level:4},{value:"Partitioning Scheme",id:"partitioning-scheme",level:4},{value:"Installation",id:"installation",level:4},{value:"Deploying Additional Networks",id:"deploying-additional-networks",level:4},{value:"Legacy Installation",id:"legacy-installation",level:3},{value:"E2E Services",id:"e2e-services",level:4},{value:"Container Requirements",id:"container-requirements",level:5},{value:"Reserved Ports",id:"reserved-ports",level:6},{value:"Pre-Installation",id:"pre-installation",level:5},{value:"Installation",id:"installation-1",level:5},{value:"High Availability",id:"high-availability",level:5},{value:"NMS Post-Installation",id:"nms-post-installation",level:3},{value:"Setup Options",id:"setup-options",level:4},{value:"Self-Hosting Map Tiles Using OpenStreetMaps",id:"self-hosting-map-tiles-using-openstreetmaps",level:4},{value:"Identity and Access Management Configuration",id:"identity-and-access-management-configuration",level:3},{value:"Installing and Enabling Keycloak",id:"installing-and-enabling-keycloak",level:4},{value:"Logging into the NMS for the first time",id:"logging-into-the-nms-for-the-first-time",level:4},{value:"Configuring User Access to Terragraph NMS",id:"configuring-user-access-to-terragraph-nms",level:4},{value:"Authorization and Roles",id:"authorization-and-roles",level:4},{value:"Nodes",id:"nodes",level:2},{value:"Node Information",id:"node-information",level:3},{value:"First PoP Configuration",id:"first-pop-configuration",level:3},{value:"GPS Configuration",id:"gps-configuration",level:3},{value:"SSH Configuration",id:"ssh-configuration",level:3},{value:"Kafka Configuration",id:"kafka-configuration",level:3},{value:"Fluentd Configuration",id:"fluentd-configuration",level:3},{value:"Time Configuration",id:"time-configuration",level:3},{value:"DNS Configuration",id:"dns-configuration",level:3},{value:"WPA-Enterprise (802.1X) Configuration",id:"wpa-enterprise-8021x-configuration",level:3},{value:"Channel Configuration",id:"channel-configuration",level:3},{value:"Disabling Linux Serial Console",id:"disabling-linux-serial-console",level:3},{value:"DHCP, PD, and DS-Lite",id:"dhcp-pd-and-ds-lite",level:3},{value:"DS-Lite Architecture",id:"ds-lite-architecture",level:4},{value:"Configuration",id:"configuration",level:4},{value:"Nodes with CPEs (DHCP)",id:"nodes-with-cpes-dhcp",level:5},{value:"PoP Nodes (BGP)",id:"pop-nodes-bgp",level:5},{value:"Terragraph Network Security",id:"terragraph-network-security",level:2},{value:"Inbound",id:"inbound",level:3},{value:"Outbound",id:"outbound",level:3}],p={toc:d};function m(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"deployment-and-installation"},"Deployment and Installation"),(0,r.kt)("p",null,"This document describes the installation procedure for the E2E controller and\nconfiguring nodes for communication with the controller."),(0,r.kt)("a",{id:"deployment-cloud"}),(0,r.kt)("h2",{id:"cloud-services"},"Cloud Services"),(0,r.kt)("p",null,"This section describes the installation and initial configuration of the full\nTerragraph cloud suite, including E2E services and the NMS backend. The\nTerragraph cloud suite is deployed as a Docker Swarm."),(0,r.kt)("a",{id:"deployment-cloud-docker-swarm-installation"}),(0,r.kt)("h3",{id:"docker-swarm-installation"},"Docker Swarm Installation"),(0,r.kt)("p",null,"Since Terragraph uses the Docker ecosystem, it would be helpful to be familiar\nwith ",(0,r.kt)("a",{parentName:"p",href:"https://docs.docker.com/engine/docker-overview/"},"Docker")," and ",(0,r.kt)("a",{parentName:"p",href:"https://docs.docker.com/engine/swarm/"},"Docker Swarm"),"."),(0,r.kt)("h4",{id:"system-requirements"},"System Requirements"),(0,r.kt)("p",null,"Docker Swarm recommends at least 3 (Docker) hosts for redundancy. If redundancy\nis not required, the cloud suite can be run on a single host. To support a\nnetwork composed of roughly 512 sectors, each Docker host must meet the\nfollowing specifications."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Ubuntu 18.04"),(0,r.kt)("li",{parentName:"ul"},"4 vCPU"),(0,r.kt)("li",{parentName:"ul"},"16GB of RAM"),(0,r.kt)("li",{parentName:"ul"},"200GB of disk space"),(0,r.kt)("li",{parentName:"ul"},"Globally addressable IPv6 and private (or global) IPv4"),(0,r.kt)("li",{parentName:"ul"},"A unique and static hostname for each Docker node")),(0,r.kt)("h4",{id:"partitioning-scheme"},"Partitioning Scheme"),(0,r.kt)("p",null,"Below is a suggested filesystem partitioning scheme for the Docker hosts. By\ndefault, all of the Terragraph-specific data is stored in ",(0,r.kt)("inlineCode",{parentName:"p"},"/opt/terragraph"),"."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Partition"),(0,r.kt)("th",{parentName:"tr",align:null},"Size"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/opt")),(0,r.kt)("td",{parentName:"tr",align:null},"130GB"),(0,r.kt)("td",{parentName:"tr",align:null},"Storage for all Terragraph data")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/var/lib/docker")),(0,r.kt)("td",{parentName:"tr",align:null},"50GB"),(0,r.kt)("td",{parentName:"tr",align:null},"Storage for all Docker data")))),(0,r.kt)("h4",{id:"installation"},"Installation"),(0,r.kt)("p",null,"Terragraph comes with an installer that deploys and configures the Terragraph\ncloud suite. The installer is a PEX file which packages together Ansible, a\nPython CLI, and all of their dependencies into a single executable. An\ninstallation host that has SSH access to all the Docker hosts is necessary to\nrun the installer. The installation host can be one of the Docker hosts."),(0,r.kt)("p",null,"For up-to-date installation instructions, see the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/terragraph/tgnms"},"Terragraph NMS")," repository."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Download the installer (",(0,r.kt)("inlineCode",{parentName:"li"},"nms"),") on the installation host.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ wget https://github.com/terragraph/tgnms/releases/latest/download/nms\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Make the ",(0,r.kt)("inlineCode",{parentName:"li"},"nms")," binary executable.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ chmod +x nms\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Install Python 3.8 (",(0,r.kt)("inlineCode",{parentName:"li"},"python3.8"),") on the installation host, and optionally\ninstall ",(0,r.kt)("inlineCode",{parentName:"li"},"ssh-pass")," if password-based SSH is used to access the Docker hosts.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ sudo apt-get install python3-distutils-extra\n$ sudo apt-get install python3.8\n")),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},"Create the config file.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ ./nms show-defaults > config.yml\n")),(0,r.kt)("ol",{start:5},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Open and edit ",(0,r.kt)("inlineCode",{parentName:"p"},"config.yml"),'. The config options are documented within the\nconfig file. Replace the "NMS Web Login" credentials and change\n',(0,r.kt)("inlineCode",{parentName:"p"},"ansible_user")," to be the username on the installation host. If identity and\naccess management is desired (recommended), follow the steps in the section\n",(0,r.kt)("a",{parentName:"p",href:"#deployment-keycloak-configuration"},"Identity and Access Management Configuration"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Run the installer. ",(0,r.kt)("inlineCode",{parentName:"p"},"tg-docker-host-XX")," are placeholders for the IP addresses\nor hostnames of the Docker hosts. All Docker hosts must be provided to the\n",(0,r.kt)("inlineCode",{parentName:"p"},"install")," command. Include the private key and SSL certificate file for the\nNginx server as arguments and set ",(0,r.kt)("inlineCode",{parentName:"p"},"ext_nms_hostname")," to configure the\nlocation of the certs in the Docker path."))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ ./nms install -f config.yml -k <ssl-key-file> -C <ssl-cert-file> \\\n  -h tg-docker-host-01 [-h tg-docker-host-02] [-h tg-docker-host-03]\n")),(0,r.kt)("ol",{start:7},(0,r.kt)("li",{parentName:"ol"},'Open a web browser and navigate to the IP address of any of the Docker hosts\nto load the NMS UI. Select the "Network Config" menu, then select the\n"Controller" tab and change the configuration fields listed in the table\nbelow. Be sure to change ',(0,r.kt)("inlineCode",{parentName:"li"},"<network>")," to the name of the network (under\n",(0,r.kt)("inlineCode",{parentName:"li"},"controllers_list")," in the ",(0,r.kt)("inlineCode",{parentName:"li"},"nms")," installer config file).")),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Key"),(0,r.kt)("th",{parentName:"tr",align:null},"Value"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"flags.stats_agent_input_sock_url")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},'"tcp://stats_agent-<network>:4231"'))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"statsAgentParams.endpointParams.kafkaParams.config.brokerEndpointList")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},'"PLAINTEXT://kafka:9092"'))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"statsAgentParams.sources.controller.zmq_url")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},'"tcp://e2e_controller-<network>:28989"'))))),(0,r.kt)("h4",{id:"deploying-additional-networks"},"Deploying Additional Networks"),(0,r.kt)("p",null,"To add additional networks to a Docker Swarm deployment (i.e. networks managed\nby the same NMS instance), edit the ",(0,r.kt)("inlineCode",{parentName:"p"},"config.yml")," file and add new entries to\n",(0,r.kt)("inlineCode",{parentName:"p"},"controllers_list"),", then re-run the ",(0,r.kt)("inlineCode",{parentName:"p"},"install")," command above. Note that this will\ncause some downtime to running services, including those for existing networks."),(0,r.kt)("h3",{id:"legacy-installation"},"Legacy Installation"),(0,r.kt)("p",null,"Legacy Terragraph deployments make use of systemd for running the E2E stack.\nThe NMS stack can no longer be installed with this method."),(0,r.kt)("h4",{id:"e2e-services"},"E2E Services"),(0,r.kt)("p",null,"The installation steps for services contained within the E2E software image are\ndescribed below."),(0,r.kt)("h5",{id:"container-requirements"},"Container Requirements"),(0,r.kt)("p",null,"The following specifications support a network with roughly 512 sectors."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"CentOS 7 or Ubuntu 17+"),(0,r.kt)("li",{parentName:"ul"},"2 vCPU"),(0,r.kt)("li",{parentName:"ul"},"12GB of RAM"),(0,r.kt)("li",{parentName:"ul"},"40GB of disk space")),(0,r.kt)("h6",{id:"reserved-ports"},"Reserved Ports"),(0,r.kt)("p",null,"The cloud services use the following ports by default to communicate with each\nother and the Terragraph nodes:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Port"),(0,r.kt)("th",{parentName:"tr",align:null},"External"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"6881")),(0,r.kt)("td",{parentName:"tr",align:null},"Yes"),(0,r.kt)("td",{parentName:"tr",align:null},"Used by libtorrent to seed upgrade images.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"6969")),(0,r.kt)("td",{parentName:"tr",align:null},"Yes"),(0,r.kt)("td",{parentName:"tr",align:null},"Opentracker serves the torrent tracker on this port.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"7007")),(0,r.kt)("td",{parentName:"tr",align:null},"Yes"),(0,r.kt)("td",{parentName:"tr",align:null},"Management communication port between E2E controller and nodes.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"8002")),(0,r.kt)("td",{parentName:"tr",align:null},"Yes"),(0,r.kt)("td",{parentName:"tr",align:null},"NMS aggregator listens on this port for stats from nodes.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"8080")),(0,r.kt)("td",{parentName:"tr",align:null},"Yes"),(0,r.kt)("td",{parentName:"tr",align:null},"API service runs on this port.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"55555")),(0,r.kt)("td",{parentName:"tr",align:null},"Yes"),(0,r.kt)("td",{parentName:"tr",align:null},"Used by primary and backup controller to send and receive HA messages.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"17077")),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"Used for communication between various E2E controller apps.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"17078")),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"Used for streaming from the controller to API service, currently disabled.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"18100")),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"Used for communication between various NMS aggregator apps.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"27007")),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"Used by controller to publish stats to cloud-based stats agent.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"28989")),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"Used by controller to publish stats to cloud-based stats agent.")))),(0,r.kt)("p",null,"The external column indicates whether or not that port must be externally\naccessible. Note that ",(0,r.kt)("inlineCode",{parentName:"p"},"17077")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"18100")," may have to be externally accessible\nif API service is not in the same network."),(0,r.kt)("h5",{id:"pre-installation"},"Pre-Installation"),(0,r.kt)("p",null,"Have the following information available before installing the E2E controller:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"An IPv6 network prefix that will be used to address the Terragraph nodes. This\nprefix will need to be reachable from the E2E controller when it is installed."),(0,r.kt)("li",{parentName:"ul"},"A route (possibly via a default) from a PoP node to the E2E controller\nmachine(s). This can be static or learned from BGP."),(0,r.kt)("li",{parentName:"ul"},"A copy of the Terragraph E2E image (x86).")),(0,r.kt)("h5",{id:"installation-1"},"Installation"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Note: The following installation steps have been tested on Ubuntu 17.10. Some\ncommands and paths may differ for CentOS.")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Copy the Terragraph E2E image to the server and extract it to ",(0,r.kt)("inlineCode",{parentName:"li"},"/opt/rootfs"),"\n(or another directory).")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ scp e2e-image-tgx86.tar.gz my-e2e-controller01:/tmp/\n$ mkdir /opt/rootfs\n$ tar xvzf e2e-image-tgx86.tar.gz -C /opt/rootfs\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Create the environment file in ",(0,r.kt)("inlineCode",{parentName:"li"},"/etc/default/tg_services"),". See\n",(0,r.kt)("inlineCode",{parentName:"li"},"/etc/tg_systemd_config/README.md")," for additional details.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'$ cat /etc/default/tg_services\nE2E_ROOTFS="/opt/rootfs"\nAPI_ROOTFS="/opt/rootfs"\nNMS_ROOTFS="/opt/rootfs"\nAGENT_ROOTFS="/opt/rootfs"\nDATA_DIR="/root/data"\n# Relative to DATA_DIR\nE2E_TOPOLOGY_FILE="/e2e-topology.conf"\nE2E_CONFIG_FILE="/cfg/controller_config.json"\nNMS_CONFIG_FILE="/cfg/aggregator_config.json"\n# Additional CLI flags\nAPI_ARGS="-http_port 8080"\n')),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},'Create the external "data" directory (',(0,r.kt)("inlineCode",{parentName:"li"},"DATA_DIR")," in the environment file).")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ mkdir /root/data\n")),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},"Install and enable the systemd service scripts.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ cp /opt/rootfs/etc/tg_systemd_config/*.service /lib/systemd/system/\n$ systemctl daemon-reload\n# E2E controller\n$ systemctl enable e2e_controller\n$ systemctl enable opentracker\n# NMS aggregator\n$ systemctl enable nms_aggregator\n# API Service\n$ systemctl enable api_service\n# Stats agent\n$ systemctl enable stats_agent\n")),(0,r.kt)("ol",{start:5},(0,r.kt)("li",{parentName:"ol"},"Create an empty topology file (",(0,r.kt)("inlineCode",{parentName:"li"},"E2E_TOPOLOGY_FILE"),' in the environment file)\nwithin the "data" directory.')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ touch /root/data/e2e-topology.conf\n")),(0,r.kt)("ol",{start:6},(0,r.kt)("li",{parentName:"ol"},"Copy the default E2E controller configuration file into the actual file\nlocation (",(0,r.kt)("inlineCode",{parentName:"li"},"E2E_CONFIG_FILE")," in the environment file). If needed, change\n",(0,r.kt)("inlineCode",{parentName:"li"},"statsAgentParams.endpointParams.kafkaParams.config.brokerEndpointList")," to\nthe list of Kafka broker URLs. See\n",(0,r.kt)("inlineCode",{parentName:"li"},"/etc/e2e_config/controller_config_metadata.json")," for additional details.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ cp /opt/rootfs/etc/e2e_config/controller_config_default.json \\\n    /root/data/cfg/controller_config.json\n")),(0,r.kt)("ol",{start:7},(0,r.kt)("li",{parentName:"ol"},"Copy the default NMS aggregator configuration file into the actual file\nlocation (",(0,r.kt)("inlineCode",{parentName:"li"},"NMS_CONFIG_FILE")," in the environment file). If needed, change\n",(0,r.kt)("inlineCode",{parentName:"li"},"dataEndpoints.nms.host")," to the URL prefix of the desired data endpoint.\nSee ",(0,r.kt)("inlineCode",{parentName:"li"},"/etc/stats_config/aggregator_config_metadata.json")," for additional\ndetails.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ cp /opt/rootfs/etc/stats_config/aggregator_config_default.json \\\n    /root/data/cfg/aggregator_config.json\n")),(0,r.kt)("h5",{id:"high-availability"},"High Availability"),(0,r.kt)("p",null,"The E2E controller can be installed in High Availability (HA) mode, where a\nbackup E2E controller runs passively on a separate machine and takes over if the\nprimary controller fails. HA mode is ",(0,r.kt)("em",{parentName:"p"},"strongly recommended"),", as Terragraph\nheavily relies on the E2E controller for normal network operation."),(0,r.kt)("p",null,"To enable HA mode, follow the installation steps above on both machines, with\nthe following changes:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"In the E2E controller configuration file (",(0,r.kt)("inlineCode",{parentName:"li"},"E2E_CONFIG_FILE"),"), additional flags\nmust be set. ",(0,r.kt)("inlineCode",{parentName:"li"},"bstar_primary"),' should be "true" on the primary controller and\n"false" on the backup controller.')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "flags": {\n    "bstar_peer_host": "<hostname or IPv6 address of the other controller>",\n    "bstar_primary": "true"\n  }\n}\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"In the environment file (",(0,r.kt)("inlineCode",{parentName:"li"},"/etc/default/tg_services"),"), set a different value\nfor ",(0,r.kt)("inlineCode",{parentName:"li"},"AGENT_MAC")," on the backup controller, as shown below.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"AGENT_MAC=0:0:0:0:0:1\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Do not enable the nms_aggregator systemd service on the backup machine.")),(0,r.kt)("h3",{id:"nms-post-installation"},"NMS Post-Installation"),(0,r.kt)("p",null,"Post-installation configuration steps for the Terragraph NMS are described\nbelow."),(0,r.kt)("a",{id:"deployment-nms-setup-options"}),(0,r.kt)("h4",{id:"setup-options"},"Setup Options"),(0,r.kt)("p",null,"NMS parameters can be configured by editing the file\n",(0,r.kt)("inlineCode",{parentName:"p"},"/opt/terragraph/gfs/nms/env/nms_custom.env"),". All available parameters are\ndescribed in the table below."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Key"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"API_REQUEST_TIMEOUT")),(0,r.kt)("td",{parentName:"tr",align:null},"integer"),(0,r.kt)("td",{parentName:"tr",align:null},"When NMS makes an external API request, the request will be canceled if the response takes longer than ",(0,r.kt)("inlineCode",{parentName:"td"},"API_REQUEST_TIMEOUT")," milliseconds. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"5000"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"COMMIT_DATE")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Commit date for the NMS build. Use this to show the user the release date of the NMS. This is normally set automatically. This can be in any format as it's merely displayed in the UI.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"COMMIT_HASH")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Commit hash for the NMS build. Use this to show the user the exact source control commit that this build was generated from. This is normally set automatically. This can be in any format as it's merely displayed in the UI.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"E2E_DL_URL")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"The URL sent to the E2E controller to download node images uploaded via the UI. The format is ",(0,r.kt)("inlineCode",{parentName:"td"},"<SCHEMA>://<IP OR HOST>"),", ex.",(0,r.kt)("inlineCode",{parentName:"td"},"http://nms-domain"),". Do not leave a trailing ",(0,r.kt)("inlineCode",{parentName:"td"},"/"),". If the E2E controller and the UI run on the same host, use ",(0,r.kt)("inlineCode",{parentName:"td"},"http://localhost"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"http_proxy")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Send external HTTP requests to the following URL. Note that this environment variable is ",(0,r.kt)("em",{parentName:"td"},"lowercase")," due to the hosting environment.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"ISSUES_URL")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"URL to a bug tracker for logging issues with the NMS.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"LOG_LEVEL")),(0,r.kt)("td",{parentName:"tr",align:null},"enum (debug, info, warning, error)"),(0,r.kt)("td",{parentName:"tr",align:null},'NMS logs information to the console with varying degrees of verbosity. Higher verbosity log levels also show messages from less verbose levels. The most verbose is "debug", the least verbose is "error". ',(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"info"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"NODE_ENV")),(0,r.kt)("td",{parentName:"tr",align:null},"enum (development, production)"),(0,r.kt)("td",{parentName:"tr",align:null},"Which mode to run the NMS process in. Development mode will reload the server when files change and enable logging to the console. Production mode will generate a static build and will log JSON to standard out. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"production"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Alerting (BETA)")),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"ALARMS_ENABLED")),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"Enables the unified alarm configuration UI. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Depends on:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"ALERTMANAGER_CONFIG_URL"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"ALERTMANAGER_URL"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"PROMETHEUS_CONFIG_URL"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"TG_ALARM_URL"),"  ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"false"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"ALERTMANAGER_CONFIG_URL")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"URL of the Alertmanager configuration service. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"http://alertmanager_configurer:9101"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"ALERTMANAGER_URL")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"URL of the Prometheus Alertmanager. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"http://alertmanager:9093"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"PROMETHEUS_CONFIG_URL")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"URL of the Prometheus configuration service. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"http://prometheus_configurer:9100"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"TG_ALARM_URL")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Hostname of the Terragraph event alarms service. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"http://alarms:40000"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Authentication")),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"CLIENT_ROOT_URL")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Base URL of the NMS. This should be the user-visible URL to access the NMS homepage (i.e. what a user would see in their browser address bar).")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"KEYCLOAK_CLIENT_ID")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Keycloak client ID to use. This must be retrieved from Keycloak if set manually.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"KEYCLOAK_CLIENT_SECRET")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Keycloak client secret to use. This must be retrieved from Keycloak if set manually.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"KEYCLOAK_HOST")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"URL of the Keycloak server to authenticate with. Full URLs are allowed here for cases where Keycloak is not served under the root hostname.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"KEYCLOAK_HTTP_PROXY")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Send all Keycloak-related HTTP requests through this proxy. There are occasions where most services are hosted within an internal network behind a proxy, but the Keycloak authorization server may be on the public internet. In this case, Keycloak related requests must be sent through a different proxy than the default HTTP proxy. If this variable is not set, this falls back to http_proxy. If neither is set, this is n/a.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"KEYCLOAK_REALM")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Keycloak realm to authenticate the user with. This must be retrieved from Keycloak if set manually.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"LOGIN_ENABLED")),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"Enables authentication for NMS. Authentication is handled by integrating with Keycloak. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Depends on:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"CLIENT_ROOT_URL"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"KEYCLOAK_HOST"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"KEYCLOAK_REALM"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"KEYCLOAK_CLIENT_ID"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"KEYCLOAK_CLIENT_SECRET")," ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"false"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"SESSION_MAX_AGE_MS")),(0,r.kt)("td",{parentName:"tr",align:null},"integer"),(0,r.kt)("td",{parentName:"tr",align:null},"How long a user's login cookie will last. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"86400000"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"SSO_ENABLED")),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"Enables Single Sign-On (SSO) functionality through Keycloak. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Depends on:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"CLIENT_ROOT_URL"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"KEYCLOAK_HOST"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"KEYCLOAK_REALM"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"KEYCLOAK_CLIENT_ID"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"KEYCLOAK_CLIENT_SECRET")," ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"false"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Mapbox")),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"MAPBOX_ACCESS_TOKEN")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Access token for the Mapbox account.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"TILE_STYLE")),(0,r.kt)("td",{parentName:"tr",align:null},"comma separated strings"),(0,r.kt)("td",{parentName:"tr",align:null},"A comma separated list of tile names and URLs to display in the UI in the format ",(0,r.kt)("inlineCode",{parentName:"td"},"<NAME>=<TILE STYLES URL>,..."),". If specified, at least one style must be listed or the UI will default to ",(0,r.kt)("strong",{parentName:"td"},(0,r.kt)("a",{parentName:"strong",href:"https://www.mapbox.com/"},"Mapbox"))," styles.  ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Example:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"Night View=night.maptiles.org,Day View=day.maptiles.org"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"MySQL (or MariaDB)")),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"MYSQL_DB")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"The MySQL database to connect to. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"cxl"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"MYSQL_HOST")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"The hostname or IP address of the MySQL server to use. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"127.0.0.1"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"MYSQL_PASS")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"The MySQL password to connect to the database with.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"MYSQL_PORT")),(0,r.kt)("td",{parentName:"tr",align:null},"integer"),(0,r.kt)("td",{parentName:"tr",align:null},"The TCP port of the MySQL server to use. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"3306"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"MYSQL_USER")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"The MySQL user to connect to the database as. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"root"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Software Portal")),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"SOFTWARE_PORTAL_API_ID")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"ID of the Terragraph software portal API token. This will be generated when creating the API token. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"tgdev"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"SOFTWARE_PORTAL_API_TOKEN")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"API token for the Terragraph software portal.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"SOFTWARE_PORTAL_URL")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"URL to the central Terragraph software portal. This is where official Terragraph releases are stored. Setting this variable will enable the software portal feature. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"https://sw.terragraph.link"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Stats")),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"GRAFANA_URL")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Absolute or relative URL to the Grafana UI. This is used to link to certain Grafana dashboards. By default Grafana is hosted under CLIENT_ROOT_URL/grafana. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"grafana"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"PROMETHEUS")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"URL of the Prometheus service. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"http://prometheus:9090"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"STATS_ALLOWED_DELAY_SEC")),(0,r.kt)("td",{parentName:"tr",align:null},"integer"),(0,r.kt)("td",{parentName:"tr",align:null},"Allowed delay in stats pipeline when showing availability. This is used for stats derived from the Kafka stats stream. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"120"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Experimental Features")),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"KAFKA_HOSTS")),(0,r.kt)("td",{parentName:"tr",align:null},"comma separated strings"),(0,r.kt)("td",{parentName:"tr",align:null},"Comma separated list of Kafka hosts to pull node events from (see ",(0,r.kt)("inlineCode",{parentName:"td"},"NOTIFICATION_MENU_ENABLED"),"). ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Example:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"[2001::1]:9092,[2001::2]:9092"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"SERVICE_AVAILABILITY_ENABLED")),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"Enables the service availability display in the overview panel. Service availability represents the link's ability to carry real traffic at layer 4. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"false"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"NOTIFICATION_MENU_ENABLED")),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"Enables the notification menu for streaming events from  Kafka in realtime. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Depends on:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"KAFKA_HOSTS")," ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"false"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"DEFAULT_ROUTES_HISTORY_ENABLED")),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"Enables the default routes history feature. ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Depends on:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"DEFAULT_ROUTES_HISTORY_HOST")," ",(0,r.kt)("br",null)," ",(0,r.kt)("strong",{parentName:"td"},"Default:")," ",(0,r.kt)("inlineCode",{parentName:"td"},"false"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"NETWORKTEST_HOST")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Hostname of the Terragraph Network Test service.")))),(0,r.kt)("h4",{id:"self-hosting-map-tiles-using-openstreetmaps"},"Self-Hosting Map Tiles Using OpenStreetMaps"),(0,r.kt)("p",null,"If fetching remote map data in the NMS UI is not possible, the\n",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("a",{parentName:"strong",href:"https://www.openstreetmap.org/"},"OpenStreetMaps"))," tiles can be generated locally and hosted in a Docker\ntile server container."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Follow the ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/openmaptiles/openmaptiles/blob/master/QUICKSTART.md"},"OpenMapTiles quick-start instructions"),".")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ git clone https://github.com/openmaptiles/openmaptiles.git\n$ cd openmaptiles\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Edit the ",(0,r.kt)("inlineCode",{parentName:"li"},".env")," file and change ",(0,r.kt)("inlineCode",{parentName:"li"},"QUICKSTART_MAX_ZOOM")," to ",(0,r.kt)("inlineCode",{parentName:"li"},"14"),". Then run the\n",(0,r.kt)("inlineCode",{parentName:"li"},"quickstart.sh")," script to generate tiles. Generating tiles for a specific\nregion is possible by adding the ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/julien-noblet/download-geofabrik#list-of-elements"},"region name")," as the first parameter.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ ./quickstart.sh <REGION NAME>\n$ make start-tileserver\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The tile server will now be running on port 8080 via ",(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("a",{parentName:"strong",href:"https://docs.docker.com/compose/install/#install-compose"},"docker-compose")),"."),(0,r.kt)("li",{parentName:"ul"},"Specify the ",(0,r.kt)("inlineCode",{parentName:"li"},"TILE_STYLE")," parameter by following the\n",(0,r.kt)("a",{parentName:"li",href:"#deployment-nms-setup-options"},"Setup Options")," for the UI.")),(0,r.kt)("a",{id:"deployment-keycloak-configuration"}),(0,r.kt)("h3",{id:"identity-and-access-management-configuration"},"Identity and Access Management Configuration"),(0,r.kt)("p",null,"Access management is handled by ",(0,r.kt)("a",{parentName:"p",href:"https://www.keycloak.org/"},"Keycloak"),", an open source Identity and Access\nManagement (IAM) system. Keycloak is capable of integrating with many identity\nproviders such as Facebook and Google, as well as storing users inside its own\ndatabase."),(0,r.kt)("h4",{id:"installing-and-enabling-keycloak"},"Installing and Enabling Keycloak"),(0,r.kt)("p",null,"The following variables must be set in\n",(0,r.kt)("a",{parentName:"p",href:"#deployment-cloud-docker-swarm-installation"},"config.yml"),":"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"keycloak_enabled")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"nms_username")," - The username of the default NMS administrator."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"nms_password")," - The password of the default NMS administrator."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ext_nms_hostname")," - Must be set to the externally visible NMS hostname\n(whatever a user would type into their browser's address bar). An\nIP address is also acceptable."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"keycloak_root_user")," - The username of the default Keycloak administrator."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"keycloak_root_password")," - The password of the default Keycloak administrator."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"keycloak_db_user")," - The username of the Keycloak MySQL user."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"keycloak_db_password")," - The password of the Keycloak MySQL user.")),(0,r.kt)("p",null,"It is recommended to change ",(0,r.kt)("inlineCode",{parentName:"p"},"keycloak_root_password")," and\n",(0,r.kt)("inlineCode",{parentName:"p"},"keycloak_db_password")," from their defaults."),(0,r.kt)("h4",{id:"logging-into-the-nms-for-the-first-time"},"Logging into the NMS for the first time"),(0,r.kt)("p",null,"After successfully running the Ansible installer, visit the URL set in\n",(0,r.kt)("inlineCode",{parentName:"p"},"ext_nms_hostname")," in a web browser. The user will be shown a login page."),(0,r.kt)("p",{align:"center"},(0,r.kt)("img",{src:"/nms/nms_signin.png",width:"360"})),(0,r.kt)("p",null,"Enter the ",(0,r.kt)("inlineCode",{parentName:"p"},"nms_username")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"nms_password")," variables from\n",(0,r.kt)("a",{parentName:"p",href:"#deployment-cloud-docker-swarm-installation"},"config.yml")," as the username and password.\nUser access to Terragraph NMS may be configured by following the instructions\nin the section below."),(0,r.kt)("a",{id:"deployment-configuring-keycloak"}),(0,r.kt)("h4",{id:"configuring-user-access-to-terragraph-nms"},"Configuring User Access to Terragraph NMS"),(0,r.kt)("p",null,"User authentication may be handled directly by Keycloak or by an external\nIdentity Provider such as Facebook or Google. This guide will detail how to add\na new user to Keycloak directly. Please consult the Keycloak documentation for\ninstructions on configuring an external Identity Provider."),(0,r.kt)("p",null,"First, the user must sign in to the Keycloak administration dashboard by\nvisiting ",(0,r.kt)("inlineCode",{parentName:"p"},"/auth")," in a browser."),(0,r.kt)("p",{align:"center"},(0,r.kt)("img",{src:"/nms/keycloak_homepage.png",width:"1000"})),(0,r.kt)("p",null,'Click on the "Administration Console" link. Enter the username and password used\nas the ',(0,r.kt)("inlineCode",{parentName:"p"},"keycloak_root_user")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"keycloak_root_password")," variables in\nconfig.yml."),(0,r.kt)("p",null,'Once logged in to the Keycloak administration dashboard, select the "TGNMS"\nrealm from the dropdown at the upper-left of the screen. Click the "Users" link\non the left sidebar. To view the users in the "TGNMS" realm, search for a user\nusing the search bar or click the "View all users" button.'),(0,r.kt)("p",{align:"center"},(0,r.kt)("img",{src:"/nms/keycloak_users.png",width:"1000"})),(0,r.kt)("p",null,'To give a new user access to Terragraph NMS, click the "Add user" button at the\nupper-right corner of the users table. Input a username for the user.\nIt is also recommended to set a valid email address so the user may reset\ntheir own password using Keycloak. Optionally, select some\n"Required User Actions" for the user to perform when they sign-in. For example,\nthe administrator may require a user to set a new password and verify their\nemail.'),(0,r.kt)("p",{align:"center"},(0,r.kt)("img",{src:"/nms/keycloak_create_user.png",width:"1000"})),(0,r.kt)("p",null,'Click the "Save" button to create the user. The newly created user must now\nbe given authorization to access the Terragraph NMS. User authorization is\nconfigured by assigning Keycloak Roles to a user. Click on the\n"Role Mappings" tab. To assign roles to a user, select the desired role in the\n"Available Roles menu" and click the "Add selected" button. The user\'s new roles\nwill take effect after their next sign-in.'),(0,r.kt)("p",{align:"center"},(0,r.kt)("img",{src:"/nms/keycloak_role_mappings.png",width:"1000"})),(0,r.kt)("p",null,'Note that the "tg_all_read" and "tg_all_write" roles are called\n"Composite Roles". These are roles which contain multiple other roles. For\nexample, if a user needs full read-access to the NMS, assign them the\n"tg_all_read" role and all corresponding read roles will be assigned to them.\nThis can be demonstrated by assigning either composite role to a user and then\nlooking at the "Effective Roles" menu on the right side of the "Role Mappings"\nscreen.'),(0,r.kt)("h4",{id:"authorization-and-roles"},"Authorization and Roles"),(0,r.kt)("p",null,'Roles are used to protect E2E API endpoints, as well as hide UI components in\nthe Terragraph NMS. Descriptions of each role can be viewed by selecting the\n"Roles" link on the left sidebar. The roles required to access each E2E API\nendpoint are listed in the E2E API Documentation.'),(0,r.kt)("p",null,"A role's name is broken up into two main parts: category and level. For example,\nthe ",(0,r.kt)("inlineCode",{parentName:"p"},"tg_ignition_read"),' role has a category of "ignition" and a level of "read".\nIf a user has the ',(0,r.kt)("inlineCode",{parentName:"p"},"tg_ignition_write"),' role, they are also able to access APIs\nin the same category that require the "read" level (write access implies\nread access). A user with the composite role ',(0,r.kt)("inlineCode",{parentName:"p"},"tg_all_write")," has full\nread-write access to all endpoints and UI components."),(0,r.kt)("a",{id:"deployment-nodes"}),(0,r.kt)("h2",{id:"nodes"},"Nodes"),(0,r.kt)("p",null,"Some important node deployment steps are highlighted in the sections below."),(0,r.kt)("a",{id:"node-information"}),(0,r.kt)("h3",{id:"node-information"},"Node Information"),(0,r.kt)("p",null,"On Puma hardware, the MAC address and serial number of each node are encoded in\na QR code on the back of the device. This is parsed as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"SN:<serial number>:M60:<MAC address>\n\nExample:\n    SN:TG100P05241700057:M60:746FF7CA1A76\n       ^^^^^^^^^^^^^^^^^     ^^^^^^^^^^^^\n    Serial number   =>  TG100P05241700057\n    MAC address     =>  74:6F:F7:CA:1A:76\n")),(0,r.kt)("a",{id:"deployment-first-pop-configuration"}),(0,r.kt)("h3",{id:"first-pop-configuration"},"First PoP Configuration"),(0,r.kt)("p",null,"The configuration of Terragraph nodes is handled automatically by the E2E\nservice. However, the first PoP node must be configured manually since\nconnectivity to the E2E controller has not yet been established."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Add the PoP site and node to the network topology (refer to\n",(0,r.kt)("a",{parentName:"p",href:"/docs/runbook/Monitoring#monitoring-map-editing"},"Monitoring and Alerting")," for details).")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create the PoP node configuration (refer to\n",(0,r.kt)("a",{parentName:"p",href:"/docs/runbook/Maintenance#maintenance-pop-node-config"},"PoP Node Config")," for details).")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Generate the full PoP node configuration JSON using one of these methods:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Via NMS:")," Select the ",(0,r.kt)("strong",{parentName:"p"},"Node Config"),' icon from the left-hand toolbar,\nclick on the "Node" tab on the top bar, then select the PoP node in the\nleft-hand column. Click ',(0,r.kt)("strong",{parentName:"p"},"Show Full Configuration")," on the bottom-left,\nmake sure the correct versions are selected, then click ",(0,r.kt)("strong",{parentName:"p"},"Copy"),".")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Via TG CLI:")," Run the following command (be sure to substitute the correct\nversion details):"))))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ tg config get node -n pop-node-name full \\\n  --version RELEASE_M61 \\\n  --hardware NXP_LS1048A_PUMA \\\n  --firmware 10.12.0\n")),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Deploy the configuration to the PoP node using one of these methods:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Via SSH (requires a signed SSH key):")," Log into the node and write the\nfull configuration JSON (obtained above) to the path\n",(0,r.kt)("inlineCode",{parentName:"li"},"/data/cfg/node_config.json"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Via web portal (must be enabled through ",(0,r.kt)("inlineCode",{parentName:"em"},"envParams.WEBUI_ENABLED"),"):")," On\nhardware that supports Wi-Fi for administrative access, connect to the\nnode's Wi-Fi network and submit the full configuration JSON (obtained\nabove) using the web portal."))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Reboot the PoP node. Connectivity to the E2E controller should be established\nwhen the node comes back up."))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ reboot\n")),(0,r.kt)("h3",{id:"gps-configuration"},"GPS Configuration"),(0,r.kt)("p",null,"When deploying a test network with poor GPS visibility (e.g. indoors), nodes\nmust be configured to disable the GPS synchronization check during link\nignition. If this is applicable, add a network override for the\n",(0,r.kt)("inlineCode",{parentName:"p"},"radioParamsBase.fwParams.forceGpsDisable")," config to ",(0,r.kt)("inlineCode",{parentName:"p"},"1")," (see\n",(0,r.kt)("a",{parentName:"p",href:"/docs/runbook/Maintenance#maintenance-config"},"Maintenance and Configuration"),")."),(0,r.kt)("a",{id:"deployment-ssh-configuration"}),(0,r.kt)("h3",{id:"ssh-configuration"},"SSH Configuration"),(0,r.kt)("p",null,"SSH access to Terragraph nodes is controlled through SSH certificate authorities\n(CAs). The CAs that Terragraph nodes trust are managed via node configuration\n(see ",(0,r.kt)("a",{parentName:"p",href:"/docs/runbook/Maintenance#maintenance-config"},"Maintenance and Configuration"),"). These\nCAs can be used to sign user SSH keys."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"To generate a CA key, use ",(0,r.kt)("inlineCode",{parentName:"li"},"ssh-keygen"),". It is recommended to use the ed25519\nencryption scheme when generating CA and user keys.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ ssh-keygen -f ~/.ssh/tg-CA -t ed25519\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Configure nodes to trust the newly generated CA by adding the contents of\n",(0,r.kt)("inlineCode",{parentName:"li"},"~/.ssh/tg-CA.pub")," to ",(0,r.kt)("inlineCode",{parentName:"li"},"sysParams.sshTrustedUserCAKeys"),".")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ cat ~/.ssh/tg-CA.pub\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Optionally, disable the default Terragraph CA on the nodes\n(",(0,r.kt)("inlineCode",{parentName:"li"},"/etc/ssh/tg-CA.bak"),") by setting ",(0,r.kt)("inlineCode",{parentName:"li"},"sysParams.allowFactoryCA")," to ",(0,r.kt)("inlineCode",{parentName:"li"},"false"),".")),(0,r.kt)("a",{id:"deployment-kafka-configuration"}),(0,r.kt)("h3",{id:"kafka-configuration"},"Kafka Configuration"),(0,r.kt)("p",null,"Stats, events, and other data can be pushed from nodes to a ",(0,r.kt)("a",{parentName:"p",href:"https://kafka.apache.org/"},"Kafka")," broker. To\nenable this, add a network override for the\n",(0,r.kt)("inlineCode",{parentName:"p"},"statsAgentParams.endpointParams.kafkaParams.config.brokerEndpointList")," config\nto the list of Kafka broker URLs.\nExample:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "statsAgentParams": {\n    "endpointParams": {\n      "kafkaParams": {\n        "config": {\n          "brokerEndpointList": "PLAINTEXT://[2001::1]:9096,PLAINTEXT://[2001::2]:9096,PLAINTEXT://[2001::3]:9096",\n        }\n      }\n    }\n  }\n}\n')),(0,r.kt)("p",null,"When running in a Docker environment, please note that the node configuration\nmust use port 9096 (by default), which will differ from the controller\nconfiguration's port 9092 (by default)."),(0,r.kt)("a",{id:"deployment-fluentd-configuration"}),(0,r.kt)("h3",{id:"fluentd-configuration"},"Fluentd Configuration"),(0,r.kt)("p",null,"Log files can be pushed from nodes to ",(0,r.kt)("a",{parentName:"p",href:"https://www.fluentd.org/"},"Fluentd")," servers via a ",(0,r.kt)("a",{parentName:"p",href:"https://fluentbit.io/"},"Fluent Bit"),"\nclient. To enable this, add a network override for the ",(0,r.kt)("inlineCode",{parentName:"p"},"fluentdParams.endpoints"),"\nconfig.\nExample:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "fluentdParams": {\n    "endpoints": {\n      "exampleServer": {\n        "host": "1111:2222:3333::ffff",\n        "port": 24224\n      }\n    }\n  }\n}\n')),(0,r.kt)("h3",{id:"time-configuration"},"Time Configuration"),(0,r.kt)("p",null,"The NTP servers that Terragraph nodes use for system clock synchronization are\nmanaged via node configuration (see\n",(0,r.kt)("a",{parentName:"p",href:"/docs/runbook/Maintenance#maintenance-config"},"Maintenance and Configuration"),"). By default,\nnodes will connect to ",(0,r.kt)("inlineCode",{parentName:"p"},"time.facebook.com"),". To use custom NTP servers instead, set\na network override for the ",(0,r.kt)("inlineCode",{parentName:"p"},"sysParams.ntpServers")," config. Note that the server\nmust have IPv6 (unless NAT64 or IPv4 are supported).\nExample:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "sysParams": {\n    "ntpServers": {\n      "ntp1": "1.pool.ntp.org",\n      "ntp2": "2.pool.ntp.org"\n    }\n  }\n}\n')),(0,r.kt)("p",null,"The timezone on Terragraph nodes is set using ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/localtime"),". This can point\nat any valid ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Tz_database"},"tz database")," entry. By default, Terragraph nodes use the ",(0,r.kt)("inlineCode",{parentName:"p"},"UTC"),"\ntimezone. To change this for all nodes, set a network override for the\n",(0,r.kt)("inlineCode",{parentName:"p"},"envParams.TIMEZONE")," config (see\n",(0,r.kt)("a",{parentName:"p",href:"/docs/runbook/Maintenance#maintenance-config"},"Maintenance and Configuration"),")."),(0,r.kt)("h3",{id:"dns-configuration"},"DNS Configuration"),(0,r.kt)("p",null,"The DNS servers that Terragraph nodes use for DNS resolution are managed via\nnode configuration (see\n",(0,r.kt)("a",{parentName:"p",href:"/docs/runbook/Maintenance#maintenance-config"},"Maintenance and Configuration"),"). By default,\nnodes will use Google's public DNS servers (",(0,r.kt)("inlineCode",{parentName:"p"},"2001:4860:4860::8888")," and\n",(0,r.kt)("inlineCode",{parentName:"p"},"2001:4860:4860::8844"),"). To use additional DNS servers, add their IPv6 addresses\nto ",(0,r.kt)("inlineCode",{parentName:"p"},"sysParams.dnsServers"),".\nExample:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "sysParams": {\n    "dnsServers": {\n      "exampleServer": "1234:1234:ffff::1234"\n    }\n  }\n}\n')),(0,r.kt)("h3",{id:"wpa-enterprise-8021x-configuration"},"WPA-Enterprise (802.1X) Configuration"),(0,r.kt)("p",null,"Terragraph supports 802.1X for link authentication for enterprise-grade\nsecurity. This requires a RADIUS server to be available and reachable from the\nnodes, and all Terragraph nodes must contain signed certificates. To enable\n802.1X, set a network override for the config keys\n",(0,r.kt)("inlineCode",{parentName:"p"},"radioParamsBase.fwParams.wsecEnable")," (to ",(0,r.kt)("inlineCode",{parentName:"p"},"2"),") and ",(0,r.kt)("inlineCode",{parentName:"p"},"eapolParams"),", as shown below:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "radioParamsBase": {\n    "fwParams": {\n      "wsecEnable": 2\n    }\n  },\n  "eapolParams": {\n    "ca_cert_path": "/data/secure/keys/ca.pem",\n    "client_cert_path": "/data/secure/keys/client.pem",\n    "private_key_path": "/data/secure/keys/client.key",\n    "radius_server_ip": "1234:5678:9abc::def",\n    "radius_server_port": 1812,\n    "radius_user_identity": "some-user",\n    "secrets": {\n      "private_key_password": "some-passphrase",\n      "radius_server_shared_secret": "some-secret",\n      "radius_user_password": "some-password"\n    }\n  }\n}\n')),(0,r.kt)("p",null,"By default, 802.1X is disabled, and links are authenticated using WPA-PSK."),(0,r.kt)("h3",{id:"channel-configuration"},"Channel Configuration"),(0,r.kt)("p",null,"The wireless channel can be manually configured for each node or assigned\nacross the entire network. For automatic assignment, only channel 2 is enabled\nby default but the set of enabled channels can be configured via the\n",(0,r.kt)("inlineCode",{parentName:"p"},"topologyParams.enabledChannels")," controller configuration field."),(0,r.kt)("h3",{id:"disabling-linux-serial-console"},"Disabling Linux Serial Console"),(0,r.kt)("p",null,"The Linux serial console (",(0,r.kt)("inlineCode",{parentName:"p"},"/dev/ttyS0"),") is enabled on nodes by default. To\ndisable it (e.g. for security reasons), set the\n",(0,r.kt)("inlineCode",{parentName:"p"},"envParams.SERIAL_CONSOLE_DISABLE")," config to ",(0,r.kt)("inlineCode",{parentName:"p"},"1")," (see ",(0,r.kt)("a",{parentName:"p",href:"/docs/runbook/Maintenance#maintenance-config"},"Maintenance and\nConfiguration"),"). Please be aware this may\nmake it impossible to recover a node."),(0,r.kt)("h3",{id:"dhcp-pd-and-ds-lite"},"DHCP, PD, and DS-Lite"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Please note these features are only supported on the Rev5 platform.")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/rfc6333"},"Dual-Stack Lite")," (or DS-Lite) allows IPv4 to work natively in an IPv6 access\nnetwork. Terragraph supports DS-Lite as a solution for dual-stack deployments.\nDS-Lite involves two network services: AFTR (Address Family Transition Router)\nand B4 (Basic Bridging BroadBand). The IPv6 address of the AFTR is required for\nsetup. The CPE will run the B4 function as long as it supports DS-Lite."),(0,r.kt)("h4",{id:"ds-lite-architecture"},"DS-Lite Architecture"),(0,r.kt)("p",{align:"center"},(0,r.kt)("img",{src:"/figures/dslite_architecture.svg",width:"512"})),(0,r.kt)("p",null,"DS-Lite requires DHCP prefix delegation. Terragraph Rev5 nodes run ",(0,r.kt)("a",{parentName:"p",href:"https://kea.isc.org/"},"Kea")," as a\nDHCP server with all the required configuration options."),(0,r.kt)("p",null,"The figure below shows an example Terragraph network with DS-Lite."),(0,r.kt)("p",{align:"center"},(0,r.kt)("img",{src:"/figures/dslite_tg_example.svg",width:"1000"})),(0,r.kt)("h4",{id:"configuration"},"Configuration"),(0,r.kt)("p",null,"The following section describes the node configuration options for setting up\nDHCP prefix delegation and DS-Lite."),(0,r.kt)("h5",{id:"nodes-with-cpes-dhcp"},"Nodes with CPEs (DHCP)"),(0,r.kt)("p",null,"The table below lists the configuration options in ",(0,r.kt)("inlineCode",{parentName:"p"},"dhcpParams"),"."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Config"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"dhcpInterface")),(0,r.kt)("td",{parentName:"tr",align:null},"Interface for DHCP (usually same as CPE interface)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"dhcpPdDelegatedLen")),(0,r.kt)("td",{parentName:"tr",align:null},"Length of prefix to be delegated to CPEs")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"dhcpPdPool")),(0,r.kt)("td",{parentName:"tr",align:null},"Network pool from which prefixes will be delegated (must be larger than ",(0,r.kt)("inlineCode",{parentName:"td"},"dhcpPdDelegatedLen"),", or else only one prefix can be delegated)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"dhcpPreferredLifetime")),(0,r.kt)("td",{parentName:"tr",align:null},"DHCP lease preferred lifetime; once this expires, the lease should not be used for new communications")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"dhcpRenewTimer")),(0,r.kt)("td",{parentName:"tr",align:null},"DHCP renew timer (T1), usually set to 50% of the preferred lease time")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"dhcpRebindTimer")),(0,r.kt)("td",{parentName:"tr",align:null},"DHCP rebind timer (T2), usually set to 87.5% of the preferred lease time")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"dhcpValidLifetime")),(0,r.kt)("td",{parentName:"tr",align:null},"Length of time that an address remains in the valid state, during which the address can be used for new or existing communications; when the valid-lifetime expires, the address becomes invalid and can no longer be used")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"dhcpRangeMin")),(0,r.kt)("td",{parentName:"tr",align:null},"Start address for regular leases")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"dhcpRangeMax")),(0,r.kt)("td",{parentName:"tr",align:null},"Max address for regular leases")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"keaEnabled")),(0,r.kt)("td",{parentName:"tr",align:null},"Boolean flag to enable or disable Kea (enabling Kea disables isc-dhcpd)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"optionData")),(0,r.kt)("td",{parentName:"tr",align:null},"Map of DHCP options, with names as the keys and data as the values (refer to the ",(0,r.kt)("a",{parentName:"td",href:"https://downloads.isc.org/isc/kea/cur/doc/kea-guide.html#dhcp6-std-options-list"},"DHCPv6 options list"),")")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"prefixSplitEnabled")),(0,r.kt)("td",{parentName:"tr",align:null},"If enabled, splits prefix down to /64 before pushing to hardware (please only enable on Marvell hardware)")))),(0,r.kt)("p",null,"Note that ",(0,r.kt)("inlineCode",{parentName:"p"},"dhcpPdPool")," is an optional parameter. If it is not set, Kea will try\nto split the address allocated to the node for delegation, if possible."),(0,r.kt)("p",null,"DS-Lite auto-configuration will not work without prefix delegation. To disable\nprefix delegation entirely, leave both ",(0,r.kt)("inlineCode",{parentName:"p"},"dhcpPdDelegatedLen")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"dhcpPdPool"),"\nunset. Please note that the DHCP server is only supported in the Rev5 platform.\nOn the newer VPP-based platforms, CPE provisioning with DHCPv6 is enabled via a\nDHCP relay."),(0,r.kt)("h5",{id:"pop-nodes-bgp"},"PoP Nodes (BGP)"),(0,r.kt)("p",null,"The table below lists the configuration options in ",(0,r.kt)("inlineCode",{parentName:"p"},"bgpParams"),"."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Config"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"cpeNetworkPrefix")),(0,r.kt)("td",{parentName:"tr",align:null},"Entire prefix used for prefix delegation in a deployment")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"delegatedNetworkPrefixes")),(0,r.kt)("td",{parentName:"tr",align:null},"Comma-separated list of specific prefixes desired to be routed from nearby CPEs (defined in ",(0,r.kt)("inlineCode",{parentName:"td"},"dhcpParams.dhcpPdPool"),")")))),(0,r.kt)("a",{id:"deployment-security-network"}),(0,r.kt)("h2",{id:"terragraph-network-security"},"Terragraph Network Security"),(0,r.kt)("p",null,"It is essential to implement proper access control list (ACL) rules to keep the\nTerragraph network infrastructure secure. Running Terragraph without any ACL\nrules upstream may expose security vulnerabilities. As such, it is critical that\nthe ",(0,r.kt)("inlineCode",{parentName:"p"},"e2e-network-prefix")," which the nodes are using be protected from the\nInternet by the application of ACL rules upstream."),(0,r.kt)("h3",{id:"inbound"},"Inbound"),(0,r.kt)("p",null,"There is no requirement for connections that must be initiated from the Internet\ntowards a Terragraph node under regular operation."),(0,r.kt)("p",null,"A Terragraph node exposed to inbound connections from the internet allows for\nvulnerabilities such as:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"SSH access by unauthorized users (by default, trusts the CA in\n",(0,r.kt)("inlineCode",{parentName:"li"},"/etc/ssh/tg-CA.bak"),")"),(0,r.kt)("li",{parentName:"ul"},"NTP amplification attacks"),(0,r.kt)("li",{parentName:"ul"},"Route hijacking via BGP (if node is a PoP)")),(0,r.kt)("h3",{id:"outbound"},"Outbound"),(0,r.kt)("p",null,"Terragraph nodes may require the following outbound connections (depending on\ntheir configuration):"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"DNS -> Google DNS6"),(0,r.kt)("li",{parentName:"ul"},"NTP -> ",(0,r.kt)("inlineCode",{parentName:"li"},"time.facebook.com")),(0,r.kt)("li",{parentName:"ul"},"E2E minion -> E2E controller on TCP port 7007"),(0,r.kt)("li",{parentName:"ul"},"Fluent Bit -> configured Fluentd endpoint (TCP)"),(0,r.kt)("li",{parentName:"ul"},"Stats agent -> configured Kafka endpoint (TCP)"),(0,r.kt)("li",{parentName:"ul"},"Stats agent -> NMS aggregator on TCP port 8002 (",(0,r.kt)("em",{parentName:"li"},"off by default"),")"),(0,r.kt)("li",{parentName:"ul"},"HTTPS -> ",(0,r.kt)("inlineCode",{parentName:"li"},"https://graph.facebook.com")," (for logging stats, ",(0,r.kt)("em",{parentName:"li"},"off by default"),")")))}m.isMDXComponent=!0}}]);