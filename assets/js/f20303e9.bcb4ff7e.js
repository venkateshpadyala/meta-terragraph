"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[7250],{3905:(t,e,a)=>{a.d(e,{Zo:()=>p,kt:()=>m});var n=a(7294);function r(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}function i(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,n)}return a}function o(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?i(Object(a),!0).forEach((function(e){r(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}function l(t,e){if(null==t)return{};var a,n,r=function(t,e){if(null==t)return{};var a,n,r={},i=Object.keys(t);for(n=0;n<i.length;n++)a=i[n],e.indexOf(a)>=0||(r[a]=t[a]);return r}(t,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(n=0;n<i.length;n++)a=i[n],e.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(t,a)&&(r[a]=t[a])}return r}var s=n.createContext({}),d=function(t){var e=n.useContext(s),a=e;return t&&(a="function"==typeof t?t(e):o(o({},e),t)),a},p=function(t){var e=d(t.components);return n.createElement(s.Provider,{value:e},t.children)},h={inlineCode:"code",wrapper:function(t){var e=t.children;return n.createElement(n.Fragment,{},e)}},c=n.forwardRef((function(t,e){var a=t.components,r=t.mdxType,i=t.originalType,s=t.parentName,p=l(t,["components","mdxType","originalType","parentName"]),c=d(a),m=r,u=c["".concat(s,".").concat(m)]||c[m]||h[m]||i;return a?n.createElement(u,o(o({ref:e},p),{},{components:a})):n.createElement(u,o({ref:e},p))}));function m(t,e){var a=arguments,r=e&&e.mdxType;if("string"==typeof t||r){var i=a.length,o=new Array(i);o[0]=c;var l={};for(var s in e)hasOwnProperty.call(e,s)&&(l[s]=e[s]);l.originalType=t,l.mdxType="string"==typeof t?t:r,o[1]=l;for(var d=2;d<i;d++)o[d]=a[d];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},7889:(t,e,a)=>{a.r(e),a.d(e,{assets:()=>s,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>l,toc:()=>d});var n=a(7462),r=(a(7294),a(3905));const i={},o="Watchdog",l={unversionedId:"developer/Watchdog",id:"developer/Watchdog",title:"Watchdog",description:"This document describes the design and implementation of scripts and helper",source:"@site/../docs/developer/Watchdog.md",sourceDirName:"developer",slug:"/developer/Watchdog",permalink:"/docs/developer/Watchdog",draft:!1,editUrl:"https://github.com/terragraph/meta-terragraph/edit/main/docs/../docs/developer/Watchdog.md",tags:[],version:"current",frontMatter:{},sidebar:"developerManualSidebar",previous:{title:"Service Scripts",permalink:"/docs/developer/Service_Scripts"},next:{title:"High Availability",permalink:"/docs/developer/High_Availability"}},s={},d=[{value:"General Watchdog Concepts",id:"general-watchdog-concepts",level:2},{value:"Hardware watchdog",id:"hardware-watchdog",level:3},{value:"Software watchdog",id:"software-watchdog",level:3},{value:"Watchdog CLI script",id:"watchdog-cli-script",level:3},{value:"Test/repair scripts",id:"testrepair-scripts",level:3},{value:"Terragraph Watchdog",id:"terragraph-watchdog",level:2},{value:"CPU core affinity",id:"cpu-core-affinity",level:3},{value:"Configuration",id:"configuration",level:3},{value:"Scripts and helper applications",id:"scripts-and-helper-applications",level:3},{value:"E2E software interaction with the watchdog",id:"e2e-software-interaction-with-the-watchdog",level:3},{value:"Platform software interaction with the watchdog",id:"platform-software-interaction-with-the-watchdog",level:3},{value:"Locks",id:"locks",level:3},{value:"Watchdog state",id:"watchdog-state",level:3},{value:"Test/repair scripting considerations",id:"testrepair-scripting-considerations",level:3},{value:"Don&#39;t write to stdout (or stderr) from the test/repair scripts",id:"dont-write-to-stdout-or-stderr-from-the-testrepair-scripts",level:4},{value:"Set a timeout for commands that may take a while in test/repair scripts",id:"set-a-timeout-for-commands-that-may-take-a-while-in-testrepair-scripts",level:4},{value:"Debugging the watchdog",id:"debugging-the-watchdog",level:3},{value:"Monitor test/repair script errors",id:"monitor-testrepair-script-errors",level:4},{value:"Use the debug logs",id:"use-the-debug-logs",level:4},{value:"Observe the operator watchdog logs and the watchdog state",id:"observe-the-operator-watchdog-logs-and-the-watchdog-state",level:4},{value:"Test entry points",id:"test-entry-points",level:3},{value:"Puma watchdog test entry points",id:"puma-watchdog-test-entry-points",level:4},{value:"Resources",id:"resources",level:2}],p={toc:d};function h(t){let{components:e,...a}=t;return(0,r.kt)("wrapper",(0,n.Z)({},p,a,{components:e,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"watchdog"},"Watchdog"),(0,r.kt)("p",null,"This document describes the design and implementation of scripts and helper\napplications that implement unit-level, autonomous state of health monitoring in\nTerragraph nodes. This monitoring system detects, repairs, and logs various\nfaults."),(0,r.kt)("h2",{id:"general-watchdog-concepts"},"General Watchdog Concepts"),(0,r.kt)("h3",{id:"hardware-watchdog"},"Hardware watchdog"),(0,r.kt)("p",null,"The hardware watchdog is a feature of ARM, NXP, and most other CPUs. When\nenabled, a watchdog register is decremented every clock cycle, and when it\nreaches zero or rolls over, the processor resets."),(0,r.kt)("p",null,'To prevent the hardware watchdog from resetting, software needs to keep writing\nto it. This reset prevention is called "kicking the watchdog". Normally the\nwatchdog kicks are deliberately stopped to ensure a certain reset, but sometimes\nLinux crashes, resulting in a surprise reset. Terragraph detects and logs\n"dirty" resets, and also collects context logs.'),(0,r.kt)("h3",{id:"software-watchdog"},"Software watchdog"),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"https://sourceforge.net/projects/watchdog/"},"software watchdog")," (i.e. watchdog daemon) is a fairly standard Linux\napplication that kicks the hardware watchdog every second. Other ",(0,r.kt)("a",{parentName:"p",href:"https://linux.die.net/man/8/watchdog"},"software\nwatchdog actions"),' include monitoring memory, disk space, temperature, ping, etc.\n(refer to the "man" pages in the software watchdog distribution). If the\nsoftware watchdog detects an unrepairable failure, it kills all processes,\nunmounts all partitions, and stops kicking the hardware watchdog in order to\nensure a certain reset.'),(0,r.kt)("p",null,"The watchdog daemon can also execute user-defined test/repair scripts, and\nTerragraph uses this feature to perform platform-specific monitoring. The daemon\nuses the exit code from the test scripts to decide what action to take."),(0,r.kt)("h3",{id:"watchdog-cli-script"},"Watchdog CLI script"),(0,r.kt)("p",null,"The watchdog CLI, ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/init.d/watchdog.sh"),", is a Bash script that starts and\nstops the watchdog daemon, and also performs Terragraph-specific watchdog state\nchanges. It is based on the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/openembedded/openembedded-core/blob/master/meta/recipes-extended/watchdog/watchdog/wd_keepalive.init"},"wd_keepalive.init")," Yocto init script."),(0,r.kt)("h3",{id:"testrepair-scripts"},"Test/repair scripts"),(0,r.kt)("p",null,"The test/repair scripts are located in ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/watchdog.d/"),", and are executed\nconcurrently by the watchdog daemon every second. There are four Terragraph\ntest/repair scripts (some of these execute several tests sequentially):"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"link_monit.sh")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"pop_reachable_monit.sh")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"progress_monit.sh"))),(0,r.kt)("p",null,"The daemon invokes each test/repair script with the following arguments: ",(0,r.kt)("inlineCode",{parentName:"p"},"test"),"\nor ",(0,r.kt)("inlineCode",{parentName:"p"},"repair <error_code>"),"."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"test")," invocation of the scripts return 0 to indicate success, or a\nnon-zero error code to indicate failure."),(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"repair")," invocation of the monitoring scripts only happens on errors."),(0,r.kt)("li",{parentName:"ul"},"The watchdog daemon passes the error code from the ",(0,r.kt)("inlineCode",{parentName:"li"},"test")," invocation to the\n",(0,r.kt)("inlineCode",{parentName:"li"},"repair")," invocation."),(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"repair")," invocation can request a reboot by exiting with a non-zero value.")),(0,r.kt)("h2",{id:"terragraph-watchdog"},"Terragraph Watchdog"),(0,r.kt)("h3",{id:"cpu-core-affinity"},"CPU core affinity"),(0,r.kt)("p",null,"The watchdog daemon and the scripts that it invokes all run on one particular\nCPU core selected explicitly in the ",(0,r.kt)("inlineCode",{parentName:"p"},"startdaemon()")," function in the\n",(0,r.kt)("inlineCode",{parentName:"p"},"watchdog.sh")," CLI script."),(0,r.kt)("h3",{id:"configuration"},"Configuration"),(0,r.kt)("p",null,"Watchdog-related configuration files are shown in the table below."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Config File"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/etc/monit_config.sh")),(0,r.kt)("td",{parentName:"tr",align:null},"Parameters for each Terragraph watchdog test (e.g. deadlines, indicator file names).")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/etc/watchdog.conf")),(0,r.kt)("td",{parentName:"tr",align:null},"Linux watchdog daemon configuration (e.g. timeouts for the test and repair phases, invocation interval). Note that if a test/repair script blocks for too long, the daemon reboots.")))),(0,r.kt)("h3",{id:"scripts-and-helper-applications"},"Scripts and helper applications"),(0,r.kt)("p",null,"Other watchdog-related scripts and applications are shown in the table below."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Script/Application"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"get_pop_ip")),(0,r.kt)("td",{parentName:"tr",align:null},"Lua"),(0,r.kt)("td",{parentName:"tr",align:null},"Get the IP of every known PoP node from Open/R's KvStore.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"link_monit.sh")),(0,r.kt)("td",{parentName:"tr",align:null},"Bash"),(0,r.kt)("td",{parentName:"tr",align:null},"Test/repair script that performs multiple tests.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"monit_init.sh")),(0,r.kt)("td",{parentName:"tr",align:null},"Bash"),(0,r.kt)("td",{parentName:"tr",align:null},"Reset the watchdog state on reboot and on e2e_minion restart.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"monit_utils.sh")),(0,r.kt)("td",{parentName:"tr",align:null},"Bash"),(0,r.kt)("td",{parentName:"tr",align:null},"Helper functions.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"monotonic-touch")),(0,r.kt)("td",{parentName:"tr",align:null},"C"),(0,r.kt)("td",{parentName:"tr",align:null},"Set and retrieve ",(0,r.kt)("inlineCode",{parentName:"td"},"CLOCK_MONOTONIC_RAW")," file timestamps.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"pop_reachable_monit.sh")),(0,r.kt)("td",{parentName:"tr",align:null},"Bash"),(0,r.kt)("td",{parentName:"tr",align:null},"Test/repair script that performs multiple tests.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"progress_monit.sh")),(0,r.kt)("td",{parentName:"tr",align:null},"Bash"),(0,r.kt)("td",{parentName:"tr",align:null},"Test/repair script that performs multiple tests.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"persist_event_cache.sh")),(0,r.kt)("td",{parentName:"tr",align:null},"Bash"),(0,r.kt)("td",{parentName:"tr",align:null},"Save/load untransmitted events persisted in flash (including watchdog events).")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"persist_reboot_history.sh")),(0,r.kt)("td",{parentName:"tr",align:null},"Bash"),(0,r.kt)("td",{parentName:"tr",align:null},"Manage ",(0,r.kt)("inlineCode",{parentName:"td"},"/data/log/reboot_history")," log.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"persist_remaining_gps_timeout.sh")),(0,r.kt)("td",{parentName:"tr",align:null},"Bash"),(0,r.kt)("td",{parentName:"tr",align:null},"Save/load the remaining GPS fault timeout in flash.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"pop_unreachable_cmd.py")),(0,r.kt)("td",{parentName:"tr",align:null},"Python"),(0,r.kt)("td",{parentName:"tr",align:null},"Collect traceroute logs when no PoP node is reachable.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"restart_e2e_minion.sh")),(0,r.kt)("td",{parentName:"tr",align:null},"Bash"),(0,r.kt)("td",{parentName:"tr",align:null},"Start and stop e2e_minion with retries.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"testcode")),(0,r.kt)("td",{parentName:"tr",align:null},"Bash"),(0,r.kt)("td",{parentName:"tr",align:null},'Manage the "testcode" upgrade state, and display TG image info.')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"tg_shutdown")),(0,r.kt)("td",{parentName:"tr",align:null},"Bash"),(0,r.kt)("td",{parentName:"tr",align:null},"Invokes persist_xxx scripts at shutdown and rotates logs.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"watchdog.sh")),(0,r.kt)("td",{parentName:"tr",align:null},"Bash"),(0,r.kt)("td",{parentName:"tr",align:null},"CLI for watchdog daemon and Terragraph tests")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"/usr/sbin/watchdog")),(0,r.kt)("td",{parentName:"tr",align:null},"C"),(0,r.kt)("td",{parentName:"tr",align:null},"The linux watchdog daemon.")))),(0,r.kt)("h3",{id:"e2e-software-interaction-with-the-watchdog"},"E2E software interaction with the watchdog"),(0,r.kt)("p",null,"The E2E minion interacts with the watchdog as shown in the table below."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"E2E minion module"),(0,r.kt)("th",{parentName:"tr",align:null},"Watchdog interaction"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"WatchdogUtils")," helper class"),(0,r.kt)("td",{parentName:"tr",align:null},"Encapsulates watchdog functionality (set empty ",(0,r.kt)("inlineCode",{parentName:"td"},"--watchdog_path")," flag to disable minion/watchdog interactions)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"Progress")," helper class"),(0,r.kt)("td",{parentName:"tr",align:null},"Sets file timestamps of indicator files to the current monotonic time, using the same clock (",(0,r.kt)("inlineCode",{parentName:"td"},"CLOCK_MONOTONIC_RAW"),") as the monotonic-touch watchdog helper application. Creates the indicator files when necessary.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"Minion")," main event loop"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("ul",null,(0,r.kt)("li",null,"Reports event loop progress."),(0,r.kt)("li",null,"If the e2e_minion event loop is dead, then the watchdog does not intervene when firmware health messages cease, and lets the runsv services monitor restart e2e_minon (and reload the baseband firmware)."),(0,r.kt)("li",null,"If the e2e_minion event loop is running ",(0,r.kt)("em",{parentName:"td"},"and")," firmware health messages cease, then the watchdog assumes that the baseband firmware has crashed, or the datapath from the firmware to Linux is dead - and the watchdog intervenes, collects logs, and restarts e2e_minion (along with the baseband firmware). See the Watchdog Fault Table for more details.")))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"ArmDriverIf")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"processFwHealthyMessage()")," reports firmware and gps health to the watchdog.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"StatusApp")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("ul",null,(0,r.kt)("li",null,(0,r.kt)("inlineCode",{parentName:"td"},"processRebootNode()"),' rejects unforced reboot command in the "testcode" upgrade states. Reboot in this state could cause a surprise image rollback. Note that the "testcode" states are monitored by the watchdog.'),(0,r.kt)("li",null,(0,r.kt)("inlineCode",{parentName:"td"},"processStatusReportAck()"),' reports controller status acknowledgments to the watchdog. These indicate that the node is "connected" to the controller.')))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"UpgradeApp")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"processMessage()")," temporarily disables most Terragraph watchdogs during each upgrade phase. This reduces the possibility of dangerous flash corruptions (e.g. during bootloader update), and also avoids losing upgrade states. Note that the watchdog automatically re-enables itself when the disable period expires.")))),(0,r.kt)("h3",{id:"platform-software-interaction-with-the-watchdog"},"Platform software interaction with the watchdog"),(0,r.kt)("p",null,"The platform software interacts with the watchdog as shown in the table below."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Platform software"),(0,r.kt)("th",{parentName:"tr",align:null},"Watchdog interaction"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Wi-Fi (Puma) message server"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"messageHandler()")," temporarily disables most Terragraph watchdogs while processing commands. Wireless command messages include a field for the watchdog disable time period. There is also a standalone wireless command (",(0,r.kt)("inlineCode",{parentName:"td"},"WATCHDOG"),") to temporarily disable or re-enable the watchdog. Note that the watchdog automatically re-enables itself when the disable time period expires.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"flash_mtd.sh")," startup script"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("ul",null,(0,r.kt)("li",null,"Kicks off configuration fallback monitoring when the current startup/reboot was ",(0,r.kt)("em",{parentName:"td"},"required")," to apply the new configuration."),(0,r.kt)("li",null,"Performs configuration rollback in different image fallback states:",(0,r.kt)("ol",null,(0,r.kt)("li",null,"No upgrade or fallback is in progress."),(0,r.kt)("li",null,'The current startup/reboot reverted the upgrade image, and need to roll back to the pre-upgrade configuration. See the Watchdog Fault Table for more information about "testcode" faults.')),(0,r.kt)("li",null,"Note that the primary function of the ",(0,r.kt)("inlineCode",{parentName:"td"},"flash_mtd.sh")," startup script is to (re)initialize and mount the ",(0,r.kt)("inlineCode",{parentName:"td"},"/data")," flash partition."))))))),(0,r.kt)("h3",{id:"locks"},"Locks"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"http://man7.org/linux/man-pages/man1/flock.1.html"},"flock")," is used by the watchdog for the following purposes:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Ensure that repair actions don't run concurrently."),(0,r.kt)("li",{parentName:"ul"},"Ensure that only one watchdog thread/script shuts down."),(0,r.kt)("li",{parentName:"ul"},"Synchronize state updates which can happen from different contexts. For\nexample, the watchdog can be disabled for a fixed time period by a user and\nalso by the E2E minion during upgrades; config rollback states are set by the\nwatchdog and also by the ",(0,r.kt)("inlineCode",{parentName:"li"},"ConfigApp")," in the E2E minion.")),(0,r.kt)("p",null,"Indicator files are used for the following purposes:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Prevent the re-execution of a test script before the corresponding repair\ninvocation is done (this is a feature/bug in the watchdog daemon)."),(0,r.kt)("li",{parentName:"ul"},'Skip the testing logic by returning 0 ("OK") to the daemon when a\nshutdown/reboot is in progress.')),(0,r.kt)("h3",{id:"watchdog-state"},"Watchdog state"),(0,r.kt)("p",null,"The runtime state of the watchdog is comprised of indicator files and a few data\nfiles in ",(0,r.kt)("inlineCode",{parentName:"p"},"/var/volatile/progress"),". The state is mostly a collection of\ntimestamps of various past events, and some deadlines. File timestamps are used\nto keep event/deadline times using a monotonic clock (",(0,r.kt)("inlineCode",{parentName:"p"},"CLOCK_MONOTONIC_RAW"),").\nScripts use the ",(0,r.kt)("inlineCode",{parentName:"p"},"monotonic_touch"),' helper application to "touch" indicator\nfiles with current or future monotonic time.'),(0,r.kt)("p",null,"Some watchdog state (e.g. remaining GPS timeout, unsent watchdog events) needs\nto be persisted across reboots, and is saved temporarily in ",(0,r.kt)("inlineCode",{parentName:"p"},"/data")," at shutdown."),(0,r.kt)("h3",{id:"testrepair-scripting-considerations"},"Test/repair scripting considerations"),(0,r.kt)("h4",{id:"dont-write-to-stdout-or-stderr-from-the-testrepair-scripts"},"Don't write to stdout (or stderr) from the test/repair scripts"),(0,r.kt)("p",null,'Most of the test/repair functions write "0" or "1" to stdout to indicate\nsuccess/failure. Random output by linux commands can result in surprise test\nfailures and repair failures causing a reboot.'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Unsafe\nsv restart fib_nss\n\n# Safe\nsv restart fib_nss >/dev/null 2>/dev/null\n")),(0,r.kt)("h4",{id:"set-a-timeout-for-commands-that-may-take-a-while-in-testrepair-scripts"},"Set a timeout for commands that may take a while in test/repair scripts"),(0,r.kt)("p",null,"The test and repair phases both have deadlines set in ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/watchdog.conf"),".\nThe watchdog daemon reboots when these deadlines are exceeded."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Unsafe\nsave_gps_version.sh /dev/ttyS1\n\n# Safe (timeout values here are only examples)\ntimeout -k 1 10 save_gps_version.sh /dev/ttyS1\nif [ $? -ne 0 ]; then\n  # Oops. Timed out. Handle timeout explicitly.\nfi\n")),(0,r.kt)("h3",{id:"debugging-the-watchdog"},"Debugging the watchdog"),(0,r.kt)("p",null,"Three methods for debugging the watchdog are described below."),(0,r.kt)("h4",{id:"monitor-testrepair-script-errors"},"Monitor test/repair script errors"),(0,r.kt)("p",null,"Error logs are kept for both the test and the repair phases\nin ",(0,r.kt)("inlineCode",{parentName:"p"},"/var/log/watchdog"),". These error log files are normally empty, which means\nthat there were no script errors."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ ls -l /var/log/watchdog/\ntotal 4\n-rw-r--r-- 1 root root   0 Jun 30 20:57 repair-bin.stderr\n-rw-r--r-- 1 root root   0 Jun 30 20:57 repair-bin.stdout\n-rw-r--r-- 1 root root   0 Jun 30 20:57 test-bin.stderr\n-rw-r--r-- 1 root root   0 Jun 30 20:41 test-bin.stdout\n")),(0,r.kt)("h4",{id:"use-the-debug-logs"},"Use the debug logs"),(0,r.kt)("p",null,"The test/repair scripts report internal states on every invocation. This\ndebug logging functionality is implemented by ",(0,r.kt)("inlineCode",{parentName:"p"},"monit_debug()")," in\n",(0,r.kt)("inlineCode",{parentName:"p"},"monit_config.sh"),". The debug logs are test-script specific, have a monotonic\ntimestamp, and appear in ",(0,r.kt)("inlineCode",{parentName:"p"},"/data/log/wdog"),". Note that these logs are not rotated\nand ",(0,r.kt)("strong",{parentName:"p"},"can fill up the flash"),"."),(0,r.kt)("p",null,"Debug logging can be enabled/disabled in two ways:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Enable/disable debug logging until the next reboot\n$ /etc/init.d/watchdog.sh en_logs\n$ /etc/init.d/watchdog.sh dis_logs\n\n# Enable/disable debug logging permanently\n$ touch /data/log/wdog/wdog_log_enable\n$ rm -f /data/log/wdog/wdog_log_enable\n")),(0,r.kt)("h4",{id:"observe-the-operator-watchdog-logs-and-the-watchdog-state"},"Observe the operator watchdog logs and the watchdog state"),(0,r.kt)("p",null,"The normal reboot and watchdog logs are helpful for debugging issues:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"/var/log/wdog_repair_history")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"/var/log/wdog_repair_history.2")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"/data/log/reboot_history")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"/data/log/reboot_history.2"))),(0,r.kt)("p",null,"To observe most of the runtime state, execute the following command (note that\n",(0,r.kt)("inlineCode",{parentName:"p"},"monotonic-touch -t")," prints the current monotonic time):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ watch -n 1 'monotonic-touch -t; for f in $(find /var/volatile/progress -type f | sort); \\\n  do echo -n \"$f \";stat -c %Y $f; done'\n")),(0,r.kt)("h3",{id:"test-entry-points"},"Test entry points"),(0,r.kt)("p",null,'The "entry point" is the name of the main bash function for each test. Note that\nsome tests have helper functions, and others are implemented by test logic\nembedded in the main ',(0,r.kt)("inlineCode",{parentName:"p"},"test_xxx()"),' function that is called when the test script\nis invoked with the "test" argument by the watchdog daemon.'),(0,r.kt)("h4",{id:"puma-watchdog-test-entry-points"},"Puma watchdog test entry points"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Description"),(0,r.kt)("th",{parentName:"tr",align:null},"Script"),(0,r.kt)("th",{parentName:"tr",align:null},"Bash Function"),(0,r.kt)("th",{parentName:"tr",align:null},"Notes"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},'Monitor the "testcode" upgrade state.'),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"progress_monit.sh")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"test_testcode_fallback()")),(0,r.kt)("td",{parentName:"tr",align:null},'In the "testcode" state, the unit is running ("testing") an upgrade image from the secondary boot partition. A reboot for any reason will cause a rollback to the original image in the primary boot partition. This watchdog reboots if the new image (specifically, ',(0,r.kt)("inlineCode",{parentName:"td"},"e2e_minion"),") fails to connect to the controller by a deadline.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Re-enable the disabled watchdogs."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"progress_monit.sh")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"timed_enable_tgscripts()")),(0,r.kt)("td",{parentName:"tr",align:null},"Most watchdogs can be disabled safely for a fixed period of time via the CLI by running ",(0,r.kt)("inlineCode",{parentName:"td"},"/etc/init.d/watchdog.sh dis <minutes>"),". This watchdog re-enables the disabled watchdogs at the deadline set by the CLI.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Monitor GPS sanity."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"progress_monit.sh")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"test_gps()")),(0,r.kt)("td",{parentName:"tr",align:null},"See the Watchdog Fault Table for details.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"A baseband card was unable to form RF links for about 15 minutes."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"progress_monit.sh")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"test_prog()")),(0,r.kt)("td",{parentName:"tr",align:null},"See the Watchdog Fault Table for details.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Baseband firmware or datapath timeout/crash."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"progress_monit.sh")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"test_prog()")),(0,r.kt)("td",{parentName:"tr",align:null},"There are two different failure modes. See the Watchdog Fault Table for details.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Monitor ",(0,r.kt)("inlineCode",{parentName:"td"},"/tmp")," full."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"pop_reachable_monit.sh")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"test_fsys()")),(0,r.kt)("td",{parentName:"tr",align:null},"n/a")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Monitor ",(0,r.kt)("inlineCode",{parentName:"td"},"/data")," full."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"pop_reachable_monit.sh")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"test_fsys()")),(0,r.kt)("td",{parentName:"tr",align:null},"n/a")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Roll back bad configuration (specifically, new node configuration that prevents connecting to the controller)."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"pop_reachable_monit.sh")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"test_config_fallback()")),(0,r.kt)("td",{parentName:"tr",align:null},"There are several different failure modes. See the Watchdog Fault Table for details.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Test PoP node reachability."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"pop_reachable_monit.sh")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"test_pop_reachable()")),(0,r.kt)("td",{parentName:"tr",align:null},"See the Watchdog Fault Table for details.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"No RF peer is reachable, although some RF links are up."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"link_monit.sh")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"test_link()")),(0,r.kt)("td",{parentName:"tr",align:null},"n/a")))),(0,r.kt)("h2",{id:"resources"},"Resources"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://sourceforge.net/projects/watchdog/"},"software watchdog")," - Linux software watchdog"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://linux.die.net/man/8/watchdog"},"software watchdog actions")," - Linux software watchdog actions"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/openembedded/openembedded-core/blob/master/meta/recipes-extended/watchdog/watchdog/wd_keepalive.init"},"wd_keepalive.init")," - Yocto watchdog keepalive daemon manager"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"http://man7.org/linux/man-pages/man1/flock.1.html"},"flock")," - Manage locks from shell scripts")))}h.isMDXComponent=!0}}]);