<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-developer/Driver_Stack">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="search" type="application/opensearchdescription+xml" title="Terragraph" href="/opensearch.xml">
<link rel="stylesheet" href="/katex/katex.min.css"><title data-rh="true">Driver Stack | Terragraph</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://terragraph.com/logo/terragraph-logo-full-RGB.png"><meta data-rh="true" name="twitter:image" content="https://terragraph.com/logo/terragraph-logo-full-RGB.png"><meta data-rh="true" property="og:url" content="https://terragraph.com/docs/developer/Driver_Stack"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Driver Stack | Terragraph"><meta data-rh="true" name="description" content="This document briefly describes Terragraph&#x27;s driver stack."><meta data-rh="true" property="og:description" content="This document briefly describes Terragraph&#x27;s driver stack."><link data-rh="true" rel="icon" href="/logo/terragraph-logo-favicon-32x32-full-RGB.png"><link data-rh="true" rel="canonical" href="https://terragraph.com/docs/developer/Driver_Stack"><link data-rh="true" rel="alternate" href="https://terragraph.com/docs/developer/Driver_Stack" hreflang="en"><link data-rh="true" rel="alternate" href="https://terragraph.com/docs/developer/Driver_Stack" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TB9T0CGM6Y-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.48218837.css">
<link rel="preload" href="/assets/js/runtime~main.ee1b3ecd.js" as="script">
<link rel="preload" href="/assets/js/main.feb34f19.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo/terragraph-logo-favicon-32x32-full-RGB.svg" alt="Terragraph Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/logo/terragraph-logo-favicon-32x32-white-RGB.svg" alt="Terragraph Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/terragraph/meta-terragraph" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link githubButton navbarIconButton" title="GitHub"></a><a href="https://discord.gg/HQaxCevzus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link discordButton navbarIconButton" title="Discord"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/runbook">Runbook</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/developer">Developer Manual</a></li><li><a class="dropdown__link" href="/docs/whitepapers">Whitepapers</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/developer">Developer Manual</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developer Manual&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/developer/Communication_Protocol">Architecture</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Communication_Protocol">Communication Protocol</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Routing_Layer">Routing Layer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Driver_Interface">Driver Interface</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/developer/Driver_Stack">Driver Stack</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/VPP_Implementation">VPP Implementation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Timing_Synchronization">Timing and Synchronization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/PTP_SyncE">PTP &amp; SyncE</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/WiFi">Wi-Fi</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Beamforming_Link_Adaptation">Firmware Layer</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Topology_Management">End-to-End (E2E) Service</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Stats_Events_Logs">Application Layer Modules</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Service_Scripts">System Management</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Release_Conventions">Version Control</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/developer"><span itemprop="name">Developer Manual</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Architecture</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Driver Stack</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Driver Stack</h1><p>This document briefly describes Terragraph&#x27;s driver stack.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="architecture">Architecture<a class="hash-link" href="#architecture" title="Direct link to heading">​</a></h2><p>The driver stack consists of the Terragraph driver and a wireless (&quot;backhaul&quot;)
driver. Terragraph implements its datapath using <a href="https://www.dpdk.org/" target="_blank" rel="noopener noreferrer">DPDK</a>, a framework for fast
packet processing in user space, along with its own implementation of a
<code>wil6210</code> Poll Mode Driver (PMD). These components are described below.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="kernel-modules">Kernel Modules<a class="hash-link" href="#kernel-modules" title="Direct link to heading">​</a></h3><p>The Terragraph driver communicates with underlying hardware using a particular
type of interface, and compiles into a corresponding kernel object file:</p><ul><li><strong>dhd:</strong> <code>terragraph-dhd.ko</code> using the BCM20130 API (&quot;dongle host driver&quot;)</li><li><strong>qwilvendor:</strong> <code>terragraph-qca.ko</code> using the wil6210 API</li></ul><p>Similarly, there are several wireless drivers available:</p><ul><li><code>wil6210.ko</code> - Wilocity wil6210 kernel driver</li><li><code>bcmdhd.ko</code> - Broadcom BCM20130 driver</li><li><code>dpdk-dhd.ko</code> - DPDK driver (with <code>wil6210</code> PMD, described below)</li></ul><p>The kernel modules loaded for each Terragraph hardware type are listed below:</p><ul><li><strong>Rev5:</strong> <code>terragraph-dhd.ko</code>+<code>bcmdhd.ko</code></li><li><strong>Puma:</strong><code>terragraph-qca.ko</code>+<code>wil6210.ko</code> (Linux kernel-based datapath) <em>OR</em><code>terragraph-dhd.ko</code>+<code>dpdk-dhd.ko</code> (DPDK-based datapath)</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="poll-mode-driver-pmd">Poll Mode Driver (PMD)<a class="hash-link" href="#poll-mode-driver-pmd" title="Direct link to heading">​</a></h3><p>DPDK utilizes Poll Mode Drivers (PMD), which run in the user-space DPDK
environment and continuously poll for data packets.</p><p>Terragraph has its own PMD implementation, <code>wil6210</code>, for the Talyn2 chip
(wil6436) used by Puma. This is a partial port of the corresponding Linux kernel
driver <code>wil6210.ko</code>, and only implements features that are strictly needed.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-applications">DPDK Applications<a class="hash-link" href="#dpdk-applications" title="Direct link to heading">​</a></h3><p>DPDK relies on user-space applications to link with its libraries and the
<code>wil6210</code> PMD. For production, Terragraph uses <a href="https://wiki.fd.io/view/VPP" target="_blank" rel="noopener noreferrer">VPP</a> (Vector Packet Processing
framework). For more details, see <a href="/docs/developer/VPP_Implementation">VPP Implementation</a>.</p><p>Other DPDK applications include:</p><ul><li><strong><a href="https://pktgen-dpdk.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">Pktgen</a>:</strong> Traffic generator</li><li><strong><a href="https://doc.dpdk.org/guides/testpmd_app_ug/" target="_blank" rel="noopener noreferrer">Testpmd</a>:</strong> Reference application that forwards packets between Ethernet
ports</li><li><strong>wiltest:</strong> Test application that forwards packets from Linux <code>terraX</code> netdev
interfaces to the appropriate wireless link and back</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="code-structure">Code Structure<a class="hash-link" href="#code-structure" title="Direct link to heading">​</a></h2><p>The sections below provide an overview of the driver stack&#x27;s code structure.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="kernel-modules-1">Kernel Modules<a class="hash-link" href="#kernel-modules-1" title="Direct link to heading">​</a></h3><p>The Terragraph driver sources are located in
<code>recipes-radio/wireless-mod/files/fb_terragraph/</code>. These are installed as
follows:</p><ul><li><code>terragraph-qca.ko</code> via
<code>recipes-radio/wireless-mod/kernel-module-terragraph-qca_0.1.bb</code></li><li><code>terragraph-dhd.ko</code> via
<code>recipes-radio/wireless-mod/kernel-module-terragraph-dhd_0.1.bb</code></li></ul><p>The API between the Terragraph and wireless drivers is defined in the header
file <code>recipes-radio/wireless-mod/files/nl-driver-if-hdr/fb_tg_backhaul_if.h</code>.</p><p>The wireless drivers are installed as follows:</p><ul><li><code>wil6210.ko</code> via
<code>meta-qca/recipes-radio/wigig-utils-oss/kernel-module-wil6210.bb</code></li><li><code>bcmdhd.ko</code> via <code>recipes-radio/broadcom-dhd/kernel-module-bcmdhd_0.1.bb</code></li></ul><p>The <code>dpdk-dhd.ko</code> module sources are fetched with the PMD sources and are
located the in the directory <code>dpdk/modules/dpdk-dhd/</code>. The module is installed
along with the <code>wil6210</code> PMD.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="poll-mode-driver-pmd-1">Poll Mode Driver (PMD)<a class="hash-link" href="#poll-mode-driver-pmd-1" title="Direct link to heading">​</a></h3><p>The <code>wil6210</code> PMD sources are fetched from the same upstream repository as the
<code>wil6210.ko</code> kernel driver. PMD sources are in the directory
<code>dpdk/drivers/wil6210/</code> while kernel driver sources are in the directory
<code>wil6210/</code>. PMD sources are compiled into <code>librte_pmd_wil6210.a</code> and installed
via <code>meta-qca/recipes-radio/wigig-dpdk/wigig-dpdk_git.bb</code>.</p><p>The source files for the PMD are prefixed with <code>wil6210_</code>, many of which
are modified copies of similarly-named files (without the prefix) in the
original <code>wil6210.ko</code> Linux kernel driver. A compatibility layer,
<code>wil6210_compat.h</code>, provides implementations for some Linux-specific APIs since
the PMD runs in a non-Linux environment; this makes it possible to take the
upstream kernel driver code with minimal changes.</p><p>A subdirectory, <code>dpdk-dhd-ctrl/</code>, contains code to send <code>ioctl</code> commands to
<code>/dev/dhd</code>, and also to set up <code>AF_PACKET</code> queues and required machinery to
exchange requests between kernel and user space.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-applications-1">DPDK Applications<a class="hash-link" href="#dpdk-applications-1" title="Direct link to heading">​</a></h3><p>The DPDK user-space applications are installed as follows:</p><ul><li><strong><a href="https://wiki.fd.io/view/VPP" target="_blank" rel="noopener noreferrer">VPP</a>:</strong> Installed via <code>meta-qoriq/recipes-extended/vpp/vpp_19.01-lsdk.bb</code>.
For more details, see <a href="/docs/developer/VPP_Implementation">VPP Implementation</a>.</li><li><strong><a href="https://pktgen-dpdk.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">Pktgen</a>:</strong> Installed as <code>dpdk-pktgen</code> via
<code>meta-qca/recipes-extended/pktgen-dpdk/pktgen-dpdk_git.bb</code>.</li><li><strong><a href="https://doc.dpdk.org/guides/testpmd_app_ug/" target="_blank" rel="noopener noreferrer">Testpmd</a>:</strong> Not installed by default; part of <code>dpdk-utils</code> (see
<code>meta-qoriq/recipes-extended/dpdk/dpdk_19.09-lsdk.bb</code>).</li><li><strong>wiltest:</strong> Installed via
<code>meta-qca/recipes-radio/wigig-dpdk/wigig-dpdk_git.bb</code>. The sources are located
in <code>src/dpdk/examples/wil6210-test/</code>.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dpdk-device-arguments">DPDK Device Arguments<a class="hash-link" href="#dpdk-device-arguments" title="Direct link to heading">​</a></h2><p>The <code>wil6210</code> PMD exposes a set of DPDK device arguments (or &quot;devargs&quot;) for
configuration, defined in <code>wil6210_pcidev.c</code>. These are described in the table
below. Note that flags are set/enabled with a value of <code>1</code> and unset/disabled
with a value of <code>0</code>.</p><table><thead><tr><th>Name</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td><code>crash-on-fw-err</code></td><td>0*</td><td>Flag to crash if a firmware error occurs. Note that this is <em>enabled</em> by default in the driver, but is <em>disabled</em> in Terragraph&#x27;s VPP configuration.</td></tr><tr><td><code>fw-core-dump-path</code></td><td><code>/var/volatile/cores/wil6210_fw_core</code></td><td>File path prefix to write core dump to after a firmware crash. The PCI ID and date are appended to the provided path.</td></tr><tr><td><code>fw-log-level</code></td><td>0</td><td>Log level of both firmware and microcode logs (0: ERROR+WARN+INFO, 1: ERROR, 2: +WARN, 3: +INFO, 4: +VERBOSE).</td></tr><tr><td><code>fw-log-path</code></td><td>null</td><td>File path to write logs to while device runs (enables PMD log polling thread).</td></tr><tr><td><code>fw-strings</code></td><td><code>/data/firmware/wil6210/fw_image_trace_string_load.bin</code></td><td>File path of firmware binary strings file to read logs.</td></tr><tr><td><code>mac-address</code></td><td>null</td><td>The MAC address to be used by the device, overriding the MAC address <a href="#driver-stack-mac-address-assignment">read from OTP</a>.</td></tr><tr><td><code>mtu-max</code></td><td>1986</td><td>Maximum MTU. The default value is computed as <code>TXRX_BUF_LEN_DEFAULT</code> (2048) - <code>WIL_MAX_MPDU_OVERHEAD</code> (62).</td></tr><tr><td><code>no-fw-recovery</code></td><td>1*</td><td>Flag to disable firmware recovery. Recovery is currently supported only in VPP, and not in other DPDK applications. Note that this is <em>disabled</em> by default in the driver (i.e. enabling recovery), but is <em>enabled</em> in Terragraph&#x27;s VPP configuration (i.e. disabling recovery).</td></tr><tr><td><code>non-commercial-rf</code></td><td>1*</td><td>Flag to determine if non-commercial RF is attached to the device. Note that this is <em>disabled</em> by default in the driver, but is <em>enabled</em> in Terragraph&#x27;s VPP configuration.</td></tr><tr><td><code>opaque-log</code></td><td>0</td><td>Flag to enable collection of opaque logs without binary strings file (requires <code>fw-log-path</code>/<code>ucode-log-path</code>).</td></tr><tr><td><code>p2mp-capable</code></td><td>1</td><td>Flag to enable sending a particular WMI command to firmware for P2MP-capable devices.</td></tr><tr><td><code>pcie-expected-gen</code></td><td>0</td><td>Expected PCIe gen value. If it is nonzero and does not match the value read from the device PCIe link status, the driver will retrain the PCIe link before rereading and sending PCIe information to firmware as usual.</td></tr><tr><td><code>pcie-expected-lanes</code></td><td>0</td><td>Expected PCIe lane count. If it is nonzero and does not match the value read from the device PCIe link status, the driver will retrain the PCIe link before rereading and sending PCIe information to firmware as usual.</td></tr><tr><td><code>pmc-ext-host</code></td><td>1*</td><td>Flag to enable firmware logging to go into the host buffer from the very beginning of firmware initialization. Otherwise the firmware will use device memory for logging initially until the host configures it to use the ring buffer in host memory. Ensures early boot logs are fully captured. Note that this is <em>disabled</em> by default in the driver, but is <em>enabled</em> in Terragraph&#x27;s VPP configuration.</td></tr><tr><td><code>pmc-ext-ring-order</code></td><td>10</td><td>Determines the size of the ring in host memory used for recording logs (in 2^order units).</td></tr><tr><td><code>ucode-log-path</code></td><td>null</td><td>File path to write microcode logs to while device runs (enables PMD log polling thread).</td></tr><tr><td><code>ucode-strings</code></td><td><code>/data/firmware/wil6210/ucode_image_trace_string_load.bin</code></td><td>File path of microcode binary strings file to read logs.</td></tr></tbody></table><p>To manually set devargs when running VPP, add them under the VPP configuration
option <code>dpdk dev &lt;pci_id&gt; devargs</code> in the VPP startup configuration file
(<code>/var/run/vpp/startup.conf</code>). Multiple devargs can be provided as a
comma-separated list. Example:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dpdk {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dev 0000:01:00.0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    devargs fw-core-dump-path=/tmp/fw_dump.core,fw-strings=/data/fw_string.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When using other DPDK applications (e.g. pktgen, wiltest), devargs can be passed
as part of the &quot;PCI whitelist&quot; (<code>--pci-whitelist</code> or <code>-w</code>) EAL argument, also in
a comma-separated list. Example:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ wiltest -w 0001:01:00.0,fw-log-path=/tmp/fw_logs,opaque-log=1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="initialization-procedure">Initialization Procedure<a class="hash-link" href="#initialization-procedure" title="Direct link to heading">​</a></h2><p>The sections below summarize the driver stack initialization and shutdown
processes using DPDK and the <code>wil6210</code> PMD.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="initialization">Initialization<a class="hash-link" href="#initialization" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-load-kernel-modules">1. Load kernel modules<a class="hash-link" href="#1-load-kernel-modules" title="Direct link to heading">​</a></h4><p>Initially, the <code>terragraph-dhd.ko</code> and <code>dpdk-dhd.ko</code> kernel modules are loaded:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ modprobe terragraph-dhd </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> modprobe dpdk-dhd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>dpdk-dhd.ko</code> registers <code>/dev/dhd</code>, a miscellaneous device instance, during
startup (in <code>dhd_init()</code>). It then waits for a user-space DPDK application to
open <code>/dev/dhd</code> and issue <code>ioctl</code> commands (handled in <code>dhd_ioctl()</code>).</p><p>The <code>pci_order</code> module parameter can be used to specify indexing of PCI devices
for bringing up <code>dhdX</code> and <code>terraX</code> devices (the first device gets <code>dhd0</code>, next
<code>dhd1</code>, etc.). When no ordering is specified, naming follows PCI enumeration
order. The parameter value should be comma-separated
<code>domain:bus:device.function</code> PCI addresses passed as a string and include all
PCI devices being used. For Puma, the default is:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ modprobe dpdk-dhd </span><span class="token assign-left variable" style="color:#36acaa">pci_order</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;0000:01:00.0,0001:01:00.0,0002:03:00.0,0002:04:00.0&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-configure-hugepages">2. Configure hugepages<a class="hash-link" href="#2-configure-hugepages" title="Direct link to heading">​</a></h4><p>DPDK requires <a href="https://www.kernel.org/doc/Documentation/vm/hugetlbpage.txt" target="_blank" rel="noopener noreferrer">hugepages</a> for the large memory pool allocation used for packet
buffers.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /mnt/hugepages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">mount</span><span class="token plain"> -t hugetlbfs none /mnt/hugepages</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-bind-wireless-devices-via-dpdk-devbind">3. Bind wireless devices via dpdk-devbind<a class="hash-link" href="#3-bind-wireless-devices-via-dpdk-devbind" title="Direct link to heading">​</a></h4><p>DPDK requires the wireless devices (i.e. baseband cards) to be made available in
user space (and unbound from the Linux kernel), by binding them to either the
<a href="https://www.kernel.org/doc/Documentation/vfio.txt" target="_blank" rel="noopener noreferrer">VFIO</a> or <a href="https://www.kernel.org/doc/html/latest/_sources/driver-api/uio-howto.rst.txt" target="_blank" rel="noopener noreferrer">UIO</a> kernel driver. The baseband cards are PCIe devices, so they are
bound to the <code>vfio-pci</code> driver:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;vfio-pci&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/sys/bus/pci/devices/&lt;pci_id&gt;/driver_override&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;pci_id&gt;&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/sys/bus/pci/drivers/vfio-pci/bind&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The role of <code>vfio-pci</code> is to provide the necessary kernel support to drive the
hardware from a user-space process safely and efficiently. Specifically,
<code>vfio-pci</code> puts the device behind IOMMU (I/O Memory Management Unit) so that it
cannot use DMA to access arbitrary physical memory, and provides <code>ioctl</code>
commands to reflect interrupts from the kernel into the DPDK process. This is
well abstracted by DPDK libraries.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-start-the-dpdk-application">4. Start the DPDK application<a class="hash-link" href="#4-start-the-dpdk-application" title="Direct link to heading">​</a></h4><p>At this point, a DPDK application is started and loads the <code>wil6210</code> PMD, which
looks for all available Talyn PCI devices. The PMD defines the <code>net_wil6210</code> PCI
device in <code>wil6210_pcidev.c</code>, containing the PCI ID table along with
probe/remove routines.</p><p>During the probe, the PMD invokes <code>wil6210_dev_init()</code> (resembling
<code>wil_pcie_probe()</code> from the <code>wil6210.ko</code> kernel driver). Among other tasks, this
loads the firmware, performs other low-level initialization, and invokes
<code>wil_register_slave()</code> in <code>wil6210_slave.c</code> to expose the <code>qwilvendor</code> platform
device. The PMD implements its own <code>platform_device_*</code> functions (declared in
the Linux API compatibility layer, <code>wil6210_compat.h</code>) in <code>wil6210_control.c</code> to
use on this <code>qwilvendor</code> device (instead of having it attached to
<code>terragraph-qca.ko</code>).</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-invoke-dpdk_dhd_attach">5. Invoke <code>DPDK_DHD_ATTACH</code><a class="hash-link" href="#5-invoke-dpdk_dhd_attach" title="Direct link to heading">​</a></h4><p>Next, the PMD opens <code>/dev/dhd</code> and invokes the <code>ioctl</code> command <code>DPDK_DHD_ATTACH</code>
(using <code>dhd_attach()</code> in <code>dpdk-dhd-ctrl.c</code>). In response, <code>dpdk-dhd.ko</code> creates
a Linux network interface (<code>dhd0</code>, <code>dhd1</code>, <code>dhd2</code>, or <code>dhd3</code>) and returns this
information back to user space. The PMD uses this information to set up
<code>AF_PACKET</code> queues for the interface.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="6-invoke-dpdk_dhd_start">6. Invoke <code>DPDK_DHD_START</code><a class="hash-link" href="#6-invoke-dpdk_dhd_start" title="Direct link to heading">​</a></h4><p>The PMD then invokes the <code>ioctl</code> command <code>DPDK_DHD_START</code> (using <code>dhd_start()</code>
in <code>dpdk-dhd-ctrl.c</code>). In response, <code>dpdk-dhd.ko</code> registers the <code>terragraph_bh</code>
platform device, which gets attached to <code>terragraph-dhd.ko</code> (via <code>tg_bh_probe()</code>
in <code>fb_tgd_terragraph_linux.c</code>).</p><p>Upon attach, the Terragraph driver creates all of the <code>terraX</code> devices, and
registers itself with the Netlink subsystem to handle Terragraph-specific
requests targeting the backhaul device instance. The Terragraph driver also uses
an API defined in <code>fb_tg_backhaul_if.h</code> to request services, and <code>dpdk-dhd.ko</code>
converts these function calls into control request packets with codes
<code>DHD_CMDOP_REGISTER</code> and <code>DHD_CMDOP_IOCTL</code> and sends them back to the DPDK
application. The PMD spawns a separate thread to handle these control messages.</p><p>This concludes the startup process. The driver stack is ready to accept Netlink
requests from <code>driver-if</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="shutdown">Shutdown<a class="hash-link" href="#shutdown" title="Direct link to heading">​</a></h3><p>The <code>ioctl</code> command <code>DPDK_DHD_STOP</code> undoes <code>DPDK_DHD_START</code> by unregistering the
<code>terragraph_bh</code> platform device. This in turn causes <code>terragraph-dhd.ko</code> to
detach from it, shutting down and destroying all <code>terraX</code> interfaces and
deregistering from Netlink.</p><p>The last <code>close()</code> on the <code>/dev/dhd</code> file handle undoes <code>DPDK_DHD_ATTACH</code> (there
is no special &quot;detach&quot; <code>ioctl</code> command).</p><a id="driver-stack-mac-address-assignment"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="mac-address-assignment">MAC Address Assignment<a class="hash-link" href="#mac-address-assignment" title="Direct link to heading">​</a></h2><p>When using the PMD, the default MAC address of each baseband card will be the
MAC address read from its one-time-programmable (OTP) memory. This is a unique
MAC address assigned during manufacturing. It is also possible to assign a
different MAC address by passing in a value to the devarg <code>mac-address</code> when
starting DPDK applications. To do this for VPP using the MAC address
<a href="/docs/developer/Service_Scripts#service-scripts-environment-variables">read from EEPROM</a>,
set the node configuration flag <code>envParams.VPP_USE_EEPROM_MACS</code>.</p><p>When using the Linux kernel driver, the default MAC address assigned to each
baseband card is the MAC address read from EEPROM.</p><a id="driver-stack-example-message-path"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="example-message-path">Example Message Path<a class="hash-link" href="#example-message-path" title="Direct link to heading">​</a></h2><p>The example below highlights the message path for a user-initiated command, e.g.
from the <code>r2d2</code> CLI or <code>e2e_minion</code>.</p><p align="center"><img loading="lazy" src="/figures/driver_stack_ioctl.svg" width="850" class="img_ev3q"></p><ol><li><code>driver-if</code> receives a message and uses Netlink to send it to the kernel.</li><li>The <code>terragraph-dhd.ko</code> Netlink handler receives the request, extracts the
firmware parameter blob, and uses an <code>ioctl</code> command to send it to
<code>dpdk-dhd.ko</code>.</li><li><code>dpdk-dhd.ko</code> wraps the request into a control packet and puts it on the
<code>AF_PACKET</code> queue for the PMD.</li><li>The PMD event handler thread wakes up, reads the packet data, and hands the
<code>DHD_CMDOP_IOCTL</code> message to <code>wil_sync_handler()</code> in <code>wil6210_control.c</code>.
This will invoke the <code>ioctl</code> method as implemented by the driver, which uses
a WMI (Wireless Module Interface) control queue to hand the data to the
firmware.</li><li>Eventually, firmware responds with the results, and the reverse process
occurs: the response is placed into the PMD&#x27;s TX <code>AF_PACKET</code> queue, then
<code>dpdk-dhd.ko</code> receives it and returns from the <code>ioctl</code> call, and finally
<code>terragraph-dhd.ko</code> sends the associated response back to <code>driver-if</code> over
Netlink.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="debugging">Debugging<a class="hash-link" href="#debugging" title="Direct link to heading">​</a></h2><p>The following sections outline how to obtain logs and crash dumps, specifically
with QTI firmware (where applicable).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="driver-logs">Driver Logs<a class="hash-link" href="#driver-logs" title="Direct link to heading">​</a></h3><p>Logs from the Terragraph driver can be found in syslog files
(<code>/var/log/kern.log</code>) or via the <code>dmesg</code> command. Logging verbosity is
controlled by the node configuration field <code>envParams.FB_DRIVER_VERBOSE</code> (see
<code>E_DBG_ENABLE_VALUE</code> in <code>fb_tgd_debug.h</code>). This bitmask can be viewed and set
dynamically with the following commands, respectively:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /sys/module/terragraph_</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">dhd,qca</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/parameters/dbg_mask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">echo</span><span class="token plain"> 0x10001 </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /sys/module/terragraph_</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">dhd,qca</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/parameters/dbg_mask</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="poll-mode-driver-pmd-logs">Poll Mode Driver (PMD) Logs<a class="hash-link" href="#poll-mode-driver-pmd-logs" title="Direct link to heading">​</a></h3><p>Logs from the PMD are contained within the DPDK application logs. For example,
when using VPP, the PMD logs captured by VPP are extracted from syslog and
written to <code>/var/log/vpp/vnet.log</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="firmwaremicrocode-logs">Firmware/Microcode Logs<a class="hash-link" href="#firmwaremicrocode-logs" title="Direct link to heading">​</a></h3><p>There are several methods for collecting firmware and microcode logs:</p><ul><li><code>host_manager_11ad</code> - This service runs automatically and writes logs to
<code>/var/log/wil6210/</code> when the <code>envParams.FW_LOGGING_ENABLED</code> node configuration
field is set. This is done through <code>start_host_manager_fw_log.sh</code>, which uses
the <code>shell_11ad</code> CLI to configure the <code>host_manager_11ad</code> daemon. Logs are
rotated and compressed, with retention set by the node configuration fields
<code>envParams.FW_LOGGING_FILE_COUNT</code> and <code>envParams.FW_LOGGING_FILESIZE_MB</code>.</li><li>PMD thread - When using VPP, a separate log polling thread can be enabled in
the PMD by passing the devargs <code>fw-log-path</code> and <code>ucode-log-path</code> for firmware
and microcode logs, respectively.</li><li><code>wil_fw_trace</code> - An alternative logging utility. To collect logs for <em>all</em>
Talyn devices, use the script <code>run_wil_fw_trace.sh</code>. Example usage:</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ wil_fw_trace -d 0001:01:00.0 -s /data/firmware/wil6210/fw_image_trace_string_load.bin -v VERBOSE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When no strings file is present, logs can be collected in opaque/binary form
instead, then decoded later using a matching strings file. To enable collection
of opaque logs, either omit the strings parameter (<code>-s</code>) to <code>wil_fw_trace</code>, or
pass the devarg <code>opaque-log=1</code> (along with <code>fw-log-path</code>) when using the PMD log
polling thread. Decode the opaque logs using the <code>-O</code> flag to <code>wil_fw_trace</code>:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ wil_fw_trace -m /path/to/opaque_logs -s /data/firmware/wil6210/fw_image_trace_string_load.bin -O</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Separate settings control the verbosity of QTI firmware logs and Facebook
firmware logs (categorized as <code>FW_3P</code>):</p><ul><li>QTI firmware verbosity is set statically using the &quot;DefaultVerbosity&quot;
parameter in <code>shell_11ad</code>, or the <code>--verbosity</code> flag in <code>wil_fw_trace</code>. When
using <code>envParams.FW_LOGGING_ENABLED</code>, the <code>host_manager_11ad</code> service sets the
verbosity according to the node configuration field
<code>envParams.FW_LOG_VERBOSE</code>.</li><li>Facebook firmware verbosity can be changed during runtime via the
<code>FW_SET_LOG_CONFIG</code> command, e.g. using the CLI command
<code>tg2 minion fw_set_log_config</code>.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="firmware-core-dumps">Firmware Core Dumps<a class="hash-link" href="#firmware-core-dumps" title="Direct link to heading">​</a></h3><p>When using the PMD, core dumps are automatically written to
<code>/var/volatile/cores/wil6210_fw_core_&lt;pci&gt;_&lt;date&gt;</code> after a firmware crash
occurs. This path is configurable via the devarg <code>fw-core-dump-path</code>.</p><p>Firmware logs will automatically be read from the core dump, if possible, into
the file <code>&lt;core-name&gt;_trace.log</code>. This uses the default strings file
<code>/data/firmware/wil6210/fw_image_trace_string_load.bin</code>, which can be changed
via the devarg <code>fw-strings</code>. Microcode logs cannot be read from the core dump.
To manually read firmware logs from a core dump, use the following
<code>wil_fw_trace</code> command:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ wil_fw_trace -m /path/to/core -s /data/firmware/wil6210/fw_image_trace_string_load.bin -o 0x1a01c0 -l </span><span class="token number" style="color:#36acaa">2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When using the kernel driver, firmware core dumps must be manually generated by
running the script <code>wil6210_core_dump.sh</code> after a firmware crash is observed.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="kernel-crashes">Kernel Crashes<a class="hash-link" href="#kernel-crashes" title="Direct link to heading">​</a></h3><p>Terragraph handles kernel crashes (panics) by saving the kernel message log
(dmesg) to log files and rebooting. The logs are saved under
<code>/data/kernel_crashes/vmcore.&lt;date&gt;</code> (configured via
<code>meta-qoriq/recipes-kernel/kexec/files/kdump.conf</code>).</p><p>This works using kexec/kdump as follows. As part of a normal startup sequence,
the <code>/etc/init.d/kdump</code> script is executed. It registers a dump kernel (also
called <code>crashkernel</code>, located at <code>/boot/Image-&lt;version&gt;-kdump</code>) with the running
(original/regular) kernel to be executed in case of a crash. When a crash
happens, the original kernel executes the registered crashkernel using kexec,
without rebooting, which means that the memory contents of the original kernel
remains available to the crashkernel. The crashkernel runs a regular userspace,
including the <code>/etc/init.d/kdump</code> script. The script notices that it&#x27;s running
as part of a crashkernel (by the presence of a <code>/proc/vmcore</code> file), gets the
original kernel messages (dmesg) from memory, saves them to
<code>/data/kernel_crashes</code> and reboots. This time, it&#x27;s a regular reboot that goes
through the boot loader (rather than kexec), and loads the original kernel as
usual.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a class="hash-link" href="#resources" title="Direct link to heading">​</a></h2><ul><li><a href="https://www.dpdk.org/" target="_blank" rel="noopener noreferrer">DPDK</a> - Data Plane Development Kit</li><li><a href="https://wiki.fd.io/view/VPP" target="_blank" rel="noopener noreferrer">VPP</a> - Vector Packet Processing</li><li><a href="https://pktgen-dpdk.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">Pktgen</a> - DPDK Packet Generator</li><li><a href="https://doc.dpdk.org/guides/testpmd_app_ug/" target="_blank" rel="noopener noreferrer">Testpmd</a> - DPDK Testpmd Application</li><li><a href="https://www.kernel.org/doc/Documentation/vm/hugetlbpage.txt" target="_blank" rel="noopener noreferrer">hugepages</a> - Linux hugetlbpage support</li><li><a href="https://www.kernel.org/doc/Documentation/vfio.txt" target="_blank" rel="noopener noreferrer">VFIO</a> - Virtual Function I/O</li><li><a href="https://www.kernel.org/doc/html/latest/_sources/driver-api/uio-howto.rst.txt" target="_blank" rel="noopener noreferrer">UIO</a> - Userspace I/O</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/terragraph/meta-terragraph/edit/main/docs/../docs/developer/Driver_Stack.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/developer/Driver_Interface"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Driver Interface</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/developer/VPP_Implementation"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">VPP Implementation</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#architecture" class="table-of-contents__link toc-highlight">Architecture</a><ul><li><a href="#kernel-modules" class="table-of-contents__link toc-highlight">Kernel Modules</a></li><li><a href="#poll-mode-driver-pmd" class="table-of-contents__link toc-highlight">Poll Mode Driver (PMD)</a></li><li><a href="#dpdk-applications" class="table-of-contents__link toc-highlight">DPDK Applications</a></li></ul></li><li><a href="#code-structure" class="table-of-contents__link toc-highlight">Code Structure</a><ul><li><a href="#kernel-modules-1" class="table-of-contents__link toc-highlight">Kernel Modules</a></li><li><a href="#poll-mode-driver-pmd-1" class="table-of-contents__link toc-highlight">Poll Mode Driver (PMD)</a></li><li><a href="#dpdk-applications-1" class="table-of-contents__link toc-highlight">DPDK Applications</a></li></ul></li><li><a href="#dpdk-device-arguments" class="table-of-contents__link toc-highlight">DPDK Device Arguments</a></li><li><a href="#initialization-procedure" class="table-of-contents__link toc-highlight">Initialization Procedure</a><ul><li><a href="#initialization" class="table-of-contents__link toc-highlight">Initialization</a></li><li><a href="#shutdown" class="table-of-contents__link toc-highlight">Shutdown</a></li></ul></li><li><a href="#mac-address-assignment" class="table-of-contents__link toc-highlight">MAC Address Assignment</a></li><li><a href="#example-message-path" class="table-of-contents__link toc-highlight">Example Message Path</a></li><li><a href="#debugging" class="table-of-contents__link toc-highlight">Debugging</a><ul><li><a href="#driver-logs" class="table-of-contents__link toc-highlight">Driver Logs</a></li><li><a href="#poll-mode-driver-pmd-logs" class="table-of-contents__link toc-highlight">Poll Mode Driver (PMD) Logs</a></li><li><a href="#firmwaremicrocode-logs" class="table-of-contents__link toc-highlight">Firmware/Microcode Logs</a></li><li><a href="#firmware-core-dumps" class="table-of-contents__link toc-highlight">Firmware Core Dumps</a></li><li><a href="#kernel-crashes" class="table-of-contents__link toc-highlight">Kernel Crashes</a></li></ul></li><li><a href="#resources" class="table-of-contents__link toc-highlight">Resources</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Terragraph</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/runbook/Overview">Overview</a></li><li class="footer__item"><a href="https://www.facebook.com/connectivity" target="_blank" rel="noopener noreferrer" class="footer__link-item">Meta Connectivity<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/terragraph" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/HQaxCevzus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.ee1b3ecd.js"></script>
<script src="/assets/js/main.feb34f19.js"></script>
</body>
</html>