<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-developer/VPP_Implementation">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="search" type="application/opensearchdescription+xml" title="Terragraph" href="/opensearch.xml">
<link rel="stylesheet" href="/katex/katex.min.css"><title data-rh="true">VPP Implementation | Terragraph</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://terragraph.com/logo/terragraph-logo-full-RGB.png"><meta data-rh="true" name="twitter:image" content="https://terragraph.com/logo/terragraph-logo-full-RGB.png"><meta data-rh="true" property="og:url" content="https://terragraph.com/docs/developer/VPP_Implementation"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="VPP Implementation | Terragraph"><meta data-rh="true" name="description" content="This document describes Terragraph&#x27;s datapath implementation using VPP."><meta data-rh="true" property="og:description" content="This document describes Terragraph&#x27;s datapath implementation using VPP."><link data-rh="true" rel="icon" href="/logo/terragraph-logo-favicon-32x32-full-RGB.png"><link data-rh="true" rel="canonical" href="https://terragraph.com/docs/developer/VPP_Implementation"><link data-rh="true" rel="alternate" href="https://terragraph.com/docs/developer/VPP_Implementation" hreflang="en"><link data-rh="true" rel="alternate" href="https://terragraph.com/docs/developer/VPP_Implementation" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TB9T0CGM6Y-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.48218837.css">
<link rel="preload" href="/assets/js/runtime~main.ee1b3ecd.js" as="script">
<link rel="preload" href="/assets/js/main.feb34f19.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo/terragraph-logo-favicon-32x32-full-RGB.svg" alt="Terragraph Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/logo/terragraph-logo-favicon-32x32-white-RGB.svg" alt="Terragraph Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/terragraph/meta-terragraph" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link githubButton navbarIconButton" title="GitHub"></a><a href="https://discord.gg/HQaxCevzus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link discordButton navbarIconButton" title="Discord"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/runbook">Runbook</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/developer">Developer Manual</a></li><li><a class="dropdown__link" href="/docs/whitepapers">Whitepapers</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/developer">Developer Manual</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developer Manual&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/developer/Communication_Protocol">Architecture</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Communication_Protocol">Communication Protocol</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Routing_Layer">Routing Layer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Driver_Interface">Driver Interface</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Driver_Stack">Driver Stack</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/developer/VPP_Implementation">VPP Implementation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Timing_Synchronization">Timing and Synchronization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/PTP_SyncE">PTP &amp; SyncE</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/WiFi">Wi-Fi</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Beamforming_Link_Adaptation">Firmware Layer</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Topology_Management">End-to-End (E2E) Service</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Stats_Events_Logs">Application Layer Modules</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Service_Scripts">System Management</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Release_Conventions">Version Control</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/developer"><span itemprop="name">Developer Manual</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Architecture</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">VPP Implementation</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>VPP Implementation</h1><p>This document describes Terragraph&#x27;s datapath implementation using VPP.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a class="hash-link" href="#overview" title="Direct link to heading">​</a></h2><p>Terragraph uses <a href="https://wiki.fd.io/view/VPP" target="_blank" rel="noopener noreferrer">VPP</a> (Vector Packet Processing framework), along with <a href="https://www.dpdk.org/" target="_blank" rel="noopener noreferrer">DPDK</a>
and a custom wil6210 PMD, to implement its datapath.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="versioning">Versioning<a class="hash-link" href="#versioning" title="Direct link to heading">​</a></h3><p>Terragraph uses the NXP fork of standard VPP, with a large number of
Terragraph-specific patches applied on top. The current version is NXP release
21.08-LSDK, corresponding to DPDK 20.11.2 and VPP 21.01.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="code-structure">Code Structure<a class="hash-link" href="#code-structure" title="Direct link to heading">​</a></h3><p>VPP is installed via <code>meta-qoriq/recipes-extended/vpp/vpp_21.08-lsdk.bb</code>. There
are also some scripts related to VPP service management and startup
configuration installed via <code>meta-qoriq/recipes-facebook/tg-vpp/tg-vpp_0.1.bb</code>.</p><p>Terragraph builds additional features on top of VPP, summarized below:</p><table><thead><tr><th>Name</th><th>Type</th><th>Source Location</th><th>Description</th></tr></thead><tbody><tr><td><code>vpp-tgcfg</code></td><td>plugin</td><td><code>src/vpp_plugins/tgcfg/</code></td><td>Configures the Terragraph-specific slow datapath.</td></tr><tr><td><code>vpp-chaperone</code></td><td>application</td><td><code>src/vpp_plugins/vpp-chaperone/</code></td><td>Applies user configs to VPP (e.g. POP, CPE, SR) over the shared memory API.</td></tr><tr><td><code>openr-fib-vpp</code></td><td>application</td><td><code>src/vpp_plugins/openr-fib-vpp/</code></td><td>The <a href="https://github.com/facebook/openr" target="_blank" rel="noopener noreferrer">Open/R</a> FIB (forwarding information base) implementation for VPP.</td></tr><tr><td><code>vpp-ptptc</code></td><td>plugin</td><td><code>src/vpp_plugins/ptptc/</code></td><td>Configures PTP-TC (Precision Timing Protocol Transparent Clock) timestamping in VPP.</td></tr><tr><td><code>vpp-esmc</code></td><td>plugin</td><td><code>src/vpp_plugins/esmc/</code></td><td>Configures SyncE (Synchronous Ethernet) ESMC (Ethernet Synchronization Messaging Channel) operation in VPP.</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="vpp-services">VPP Services<a class="hash-link" href="#vpp-services" title="Direct link to heading">​</a></h3><p>The following VPP services are managed by runit: <code>vpp</code>, <code>fib_vpp</code>, and
<code>vpp_chaperone</code>. Logs for each service are written to
<code>/var/log/&lt;service&gt;/current</code> by svlogd. Additionally, DPDK/PMD logs captured by
VPP are extracted from syslog and written to <code>/var/log/vpp/vnet.log</code>. For more
details, see <a href="/docs/developer/Service_Scripts#service-scripts-node-services">Node Services</a>.</p><p>The lifetimes of certain services are tied together:</p><ul><li>Restarting <code>e2e_minion</code> will also restart <code>vpp</code> (since the entire driver stack
gets unloaded)</li><li>Restarting <code>vpp</code> will also forcibly restart <code>fib_vpp</code> (since it uses VPP&#x27;s SHM
API)</li><li>Restarting <code>fib_vpp</code> <em>may</em> re-run <code>vpp_chaperone</code> (on POP nodes)</li></ul><p>Startup configuration for VPP is generated at boot time by
<code>src/terragraph-e2e/lua/update_vpp_startup_conf.lua</code> using parameters read from
the node configuration and node info files.</p><p>A separate <code>coop</code> service monitors the Linux loopback prefix for changes and
reconfigures the VPP loopback prefix if necessary by running <code>vpp_chaperone</code>.</p><p>Some VPP stats are scraped by the <code>stats_agent</code> process and published on a
ZMQ port (see <a href="/docs/developer/Stats_Events_Logs">Stats, Events, Logs</a> for details).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="vpp-packet-processing-graph">VPP Packet Processing Graph<a class="hash-link" href="#vpp-packet-processing-graph" title="Direct link to heading">​</a></h3><p>The flowchart below demonstrates the path that data packets take through VPP and
special hooks established in the VPP packet processing graph by the <code>vpp-tgcfg</code>
plugin. This is explained in detail in subsequent sections.</p><p align="center"><img loading="lazy" src="/figures/tgcfg.svg" width="1000" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="stock-vpp-datapath-overview">Stock VPP Datapath Overview<a class="hash-link" href="#stock-vpp-datapath-overview" title="Direct link to heading">​</a></h2><p>All data packets received from hardware enter VPP through the <code>dpdk-input</code> node.
This node normally passes data to the <code>ethernet-input</code> node, which then
classifies packets as IPv4, IPv6, WPA, and so on. This document will focus on
IPv6 packets, which are the primary data packet type being dealt with.</p><p>Each IPv6 packet ends up in the <code>ip6-input</code> node, which is mostly responsible
for determining if the packet is supposed to transit out of the node. This
involves somewhat complex logic that is covered by the &quot;Local?&quot; decision node,
without going into details on how this is actually implemented. For example, all
unicast packets get their destination address looked up in the IPv6 FIB. All
link-local addresses will hit an entry in the FIB that will redirect them to the
<code>ip6-link-local</code> node, which in turn will perform a lookup in a separate FIB to
find out if the destination address matches one of the interfaces that VPP
recognizes. If it does, the packet gets forwarded into the <code>ip6-local</code> node to
be handled on the node. Otherwise, the packet is for an invalid address and gets
dropped.</p><p>The FIB entry to redirect all link-local packets to <code>ip6-link-local</code> looks like
this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">fe80::/10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unicast-ip6-chain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[@0]: dpo-load-balance: [proto:ip6 index:7 buckets:1 uRPF:6 to:[162:22458]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0] [@15]: ip6-link-local</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The following trace fragment demonstrates the handling of link-local packets in
VPP by this path:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">00:53:14:979091: ip6-lookup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fib 0 dpo-idx 0 flow hash: 0x00000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ICMP6: fe80::6ce:14ff:feff:4281 -&gt; fe80::6ce:14ff:feff:428b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tos 0x00, flow label 0xb271e, hop limit 64, payload length 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ICMP echo_request checksum 0xfd87</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00:53:14:979102: ip6-link-local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sw_if_index:14 fib_index:10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00:53:14:979106: ip6-lookup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fib 10 dpo-idx 14 flow hash: 0x00000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ICMP6: fe80::6ce:14ff:feff:4281 -&gt; fe80::6ce:14ff:feff:428b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tos 0x00, flow label 0xb271e, hop limit 64, payload length 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ICMP echo_request checksum 0xfd87</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00:53:14:979110: ip6-local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ICMP6: fe80::6ce:14ff:feff:4281 -&gt; fe80::6ce:14ff:feff:428b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tos 0x00, flow label 0xb271e, hop limit 64, payload length 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ICMP echo_request checksum 0xfd87</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Similarly, all multicast addresses are looked up in the <code>ip6-mfib</code> FIB table and
either get dropped or get forwarded to <code>ip6-local</code> to be handled on the node:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">00:52:58:405106: ethernet-input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  IP6: 04:ce:14:ff:42:81 -&gt; 04:ce:14:ff:42:8b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00:52:58:405118: ip6-input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UDP: fe80::6ce:14ff:feff:4281 -&gt; ff02::1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tos 0xc0, flow label 0x5d69e, hop limit 255, payload length 171</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UDP: 6666 -&gt; 6666</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    length 171, checksum 0x63e7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00:52:58:405128: ip6-mfib-forward-lookup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fib 0 entry 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00:52:58:405136: ip6-mfib-forward-rpf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  entry 4 itf 14 flags Accept,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00:52:58:405144: ip6-replicate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicate: 2 via [@1]: dpo-receive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00:52:58:405153: ip6-local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UDP: fe80::6ce:14ff:feff:4281 -&gt; ff02::1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tos 0xc0, flow label 0x5d69e, hop limit 255, payload length 171</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UDP: 6666 -&gt; 6666</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      length 171, checksum 0x63e7</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>All known unicast addresses for existing interfaces in VPP will get an entry in
the IPv6 FIB, similar to this one, which will redirect matching packets to the
<code>ip6-local</code> node as well:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">71::3/128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unicast-ip6-chain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [@0]: dpo-load-balance: [proto:ip6 index:66 buckets:1 uRPF:71 to:[3:312]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [0] [@2]: dpo-receive: 71::3 on loop1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A sample trace fragment is given below:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">01:21:15:353214: ethernet-input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  IP6: 04:ce:14:ff:42:81 -&gt; 04:ce:14:ff:42:8b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">01:21:15:353224: ip6-input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ICMP6: 2801:b8:fb:fb9c::1 -&gt; 71::3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tos 0x00, flow label 0x27108, hop limit 63, payload length 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ICMP echo_request checksum 0xbd02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">01:21:15:353233: ip6-lookup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fib 0 dpo-idx 5 flow hash: 0x00000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ICMP6: 2801:b8:fb:fb9c::1 -&gt; 71::3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tos 0x00, flow label 0x27108, hop limit 63, payload length 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ICMP echo_request checksum 0xbd02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">01:21:15:353243: ip6-local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ICMP6: 2801:b8:fb:fb9c::1 -&gt; 71::3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tos 0x00, flow label 0x27108, hop limit 63, payload length 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ICMP echo_request checksum 0xbd02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">01:21:15:353252: tg-slowpath-terra-rx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The important takeaway from the above examples is as follows: any packet that is
to be handled on the node itself eventually goes though a FIB lookup that
returns a <code>dpo-receive</code> object. This tells VPP that the packet should be handled
by the <code>ip6-local</code> node as the next step. The DPO (&quot;data-path object&quot;) also
encodes the interface for which the packet is received, so upon entry
<code>ip6-local</code> knows the interface that has received the packet and the interface
for which the packet was sent.</p><p>All other packets either match a valid entry in the FIB and are forwarded to the
appropriate interface to be sent out, or they are dropped as invalid.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="terragraph-config-plugin-vpp-tgcfg">Terragraph Config Plugin (vpp-tgcfg)<a class="hash-link" href="#terragraph-config-plugin-vpp-tgcfg" title="Direct link to heading">​</a></h2><p>The <code>vpp-tgcfg</code> plugin installs several hooks into the VPP packet graph and
configures certain interfaces and their properties on startup. The primary goal
for these is to handle the Terragraph-specific slow datapath, where some traffic
is handled entirely in VPP (fast path) and some gets forwarded to the Linux
kernel to be handled there (slow path).</p><p>The slow path is enabled by default.  It can be switched off by adding the
&quot;slowpath&quot; directive in the &quot;terragraph&quot; section of VPP&#x27;s startup
configuration:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">terragraph {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  slowpath off</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="interfaces">Interfaces<a class="hash-link" href="#interfaces" title="Direct link to heading">​</a></h3><p>VPP maintains several &quot;split-level&quot; interfaces:</p><ul><li><code>vpp-terraX</code> interfaces, representing Terragraph links. Each instance of a
<code>vpp-terraX</code> interface has a corresponding <code>terraX</code> interface on the Linux
side. The plugin uses a side-channel interface with the wil6210 PMD and
<code>dpdk-dhd.ko</code> kernel module to receive packets from the kernel and to inject
packets into the kernel on behalf of <code>terraX</code>.</li><li><code>vpp-nicX</code> tap interfaces, and corresponding <code>nicX</code> endpoints on the Linux
side. These represent wired Ethernet interfaces and use VPP&#x27;s built-in
<code>tapcli</code> module to read and inject packets.</li><li><code>vpp-vnet0</code> tap interfaces, and corresponding <code>vnet0</code> endpoints on the Linux
side. This pair is used for L3-routable connection between vpp and the Linux
kernel. Namely, DNs and CNs will have a default route pointing to <code>vnet0</code>.</li><li><code>loop0</code>, a VPP interface that serves as a pure VPP-only L3-routable endpoint.
It gets assigned a <code>::2</code> address from the node&#x27;s prefix for that interface by
another process (<code>vpp_chaperone</code>). The only useful function of this interface
at the time of this writing is to serve its global IPv6 address to the ICMPv6
error source address selection algorithm.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration">Configuration<a class="hash-link" href="#configuration" title="Direct link to heading">​</a></h3><p>The VPP plugin identifies all Wigig interfaces at startup time, establishes a
side-channel API connection to corresponding PMD and consequently <code>dpdk-dhd.ko</code>
running in the kernel automatically. This auto-probe can be switched off by
adding the &quot;auto-probe off&quot; directive in the &quot;terragraph&quot; section of VPP&#x27;s
startup configuration:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">terragraph {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  auto-probe off</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>VPP creation of the <code>vpp-vnet0</code>/<code>vnet0</code> tap interface pair is enabled by the
following directive in the startup configuration:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">terragraph {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  host interface vnet0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>vpp-nic0</code>/<code>nic0</code> tap interface pair is created by the following directive
in the startup configuration:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">terragraph {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  interface TenGigabitEthernet0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tap nic0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The directive example above will create <code>nic0</code> on the kernel side and <code>vpp-nic0</code>
in VPP, and arrange for slow path processing similar to processing done for
Wigig/<code>vpp-terra0</code>/<code>terra0</code>. The MAC address of the <code>nic0</code> interface in the
kernel will match the MAC address of the corresponding <code>TenGigabitEthernet0</code>
interface in VPP.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="graph-nodes">Graph Nodes<a class="hash-link" href="#graph-nodes" title="Direct link to heading">​</a></h3><p>The following section lists the graph nodes that <code>vpp-tgcfg</code> implements, their
functions, and where they are connected into the packet processing graph.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tg-link-input">tg-link-input<a class="hash-link" href="#tg-link-input" title="Direct link to heading">​</a></h4><p>This node intercepts all packets received from <code>WigigX/Y/Z/0</code> interfaces and
examines packet metadata to find out what <code>vpp-terraX</code> interface should be
marked as the receiving interface for the packet. The packet metadata is stored
in the <code>rte_mbuf</code> structure using a custom dynamic field (or <code>dynfield</code>). It
then forwards the packets to the normal VPP data processing path, namely the
<code>ethernet-input</code> node. As far as VPP is concerned, the packets are received by
proper <code>vpp-terraX</code> interfaces from now on.</p><p>The node is inserted into the graph by a call in the <code>tg_interface_enable()</code>
function:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  /* Let incoming traffic to be assigned to correct link interface */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vnet_feature_enable_disable (&quot;device-input&quot;, &quot;tg-link-input&quot;, sw_if_index,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               enable_disable, 0, 0);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tg-slowpath-wired-rx-tg-slowpath-terra-rx">tg-slowpath-wired-rx, tg-slowpath-terra-rx<a class="hash-link" href="#tg-slowpath-wired-rx-tg-slowpath-terra-rx" title="Direct link to heading">​</a></h4><p>These two nodes intercept all packets from <code>vpp-terraX</code> and slow path-enabled
wired ports hitting the <code>ip6-local</code> node, before any processing has been done
for them. These nodes examine the interface addressed by the packet and if it
happens to belong to any slow path-enabled interface, the packet is forwarded to
<code>tg-link-local-tx</code> or <code>tg-wired-local-tx</code> nodes for packets received over Wigig
or over wired ports, respectively. The packet will then be forwarded to the
kernel and inserted into the Linux stack as appropriate.</p><p>Packets addressed to any other interface are processed by VPP locally. Packets
addressing <code>loop0</code> fall into this category.</p><p>Instantiated as features on the <code>ip6-local</code> arc in the
<code>tg_wired_interface_enable()</code> and <code>tg_interface_enable()</code> functions.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tg-link-local-tx">tg-link-local-tx<a class="hash-link" href="#tg-link-local-tx" title="Direct link to heading">​</a></h4><p>This node accepts packets and calls into the PMD/dpdk-dhd to get them delivered
to the kernel. The kernel module then injects packets onto the Linux networking
stack using <code>netif_rx</code> on behalf of the proper <code>terraX</code> interface. The node is
scheduled as the next node explicitly by <code>tg-slowpath-terra-rx</code> when necessary.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tg-wired-local-tx">tg-wired-local-tx<a class="hash-link" href="#tg-wired-local-tx" title="Direct link to heading">​</a></h4><p>This node accepts packets that came from a slow path-enabled wired port (e.g.
<code>TenGigabitEthernet0</code>), and forwards them to the interface output of the
corresponding <code>vpp-nicX</code> interface. This in turn will make <code>tapcli-tx</code> send
packets over to the Linux side and be inserted into the Linux kernel stack on
behalf of the matching <code>nicX</code> interface. The node is scheduled as the next node
explicitly by <code>tg-slowpath-wired-rx</code> when necessary.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="vpp-terra-tx">vpp-terra-tx<a class="hash-link" href="#vpp-terra-tx" title="Direct link to heading">​</a></h4><p>This node accepts all packets that VPP wants to be sent over the air using one
of the <code>vpp-terraX</code> interfaces as the source. Since <code>vpp-terraX</code> are virtual
interfaces representing the link, the node performs a function logically
opposite to that of the <code>tg-link-input</code> node: it uses <code>vpp-terraX</code> information
to mark the packet with the desired link to be used and then forwards the packet
to <code>WigigX/Y/Z/0</code> for actual transmission.</p><p>This is not an actual node, but rather a TX function <code>tg_link_interface_tx()</code>
registered as the output handler of the <code>vpp-terraX</code> interface class. VPP
creates <code>vpp-terraX-tx</code> nodes with this function as the handler automatically.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">VNET_DEVICE_CLASS (tg_link_interface_device_class) = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .name = &quot;TGLink&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .format_device_name = format_tg_link_name,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .format_tx_trace = format_tg_link_tx_trace,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .tx_function = tg_link_interface_tx,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .admin_up_down_function = tg_link_interface_admin_up_down,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tg-link-local-rx">tg-link-local-rx<a class="hash-link" href="#tg-link-local-rx" title="Direct link to heading">​</a></h4><p>This node gets scheduled every time the kernel wants to send packets over any
<code>terraX</code> interface. The <code>dpdk-dhd.ko</code> will relay them into the <code>AF_PACKET</code> queue
and make the queue socket FD readable, and that eventually results in VPP
invoking the node&#x27;s <code>tg_link_local_rx()</code> function. It will fetch all packets
from the kernel, convert them into VPP buffers, mark them with the proper link
interface, and invoke TX on the real Wigig interface.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">      clib_file_main_t *fm = &amp;file_main;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      clib_file_t template = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      template.read_function = tg_link_local_rx_fd_read_ready;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      template.file_descriptor = wi.data_fd;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      template.description = format (0, &quot;%s&quot;, &quot;wigig-local-rx&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      template.private_data = vec_len (tm-&gt;wigig_devs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      wdev.clib_file_index = clib_file_add (fm, &amp;template);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tg-wired-local-rx">tg-wired-local-rx<a class="hash-link" href="#tg-wired-local-rx" title="Direct link to heading">​</a></h4><p>This node intercepts packets received from the <code>nicX</code> tap interface and sends
them directly over the corresponding wired port. It is similar in function to
<code>tg-link-local-rx</code>, but for wired interfaces.</p><p>Instantiated in the <code>tg_wired_interface_enable()</code> function in the plugin.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hqos-scheduler-tghqos">HQoS Scheduler (TGHQoS)<a class="hash-link" href="#hqos-scheduler-tghqos" title="Direct link to heading">​</a></h2><p>Terragraph uses a custom Hierarchical Quality-of-Service (HQoS) scheduler on
traffic transmitted out of Wigig interfaces for managing prioritization of
different traffic types. The implementation is originally based on <a href="https://wiki.fd.io/view/VPP" target="_blank" rel="noopener noreferrer">VPP</a>&#x27;s
now-deprecated HQoS functionality that used the <a href="http://doc.dpdk.org/guides/prog_guide/qos_framework.html" target="_blank" rel="noopener noreferrer">DPDK QoS framework</a> implemented
in DPDK&#x27;s <code>librte_sched</code> library.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="code-structure-1">Code Structure<a class="hash-link" href="#code-structure-1" title="Direct link to heading">​</a></h3><p>The HQoS implementation exists as a separate module within VPP&#x27;s DPDK plugin. It
is included as a series of patches in
<code>meta-qoriq/recipes-extended/vpp/vpp_19.09-lsdk.bb</code>, with code added into the
directory <code>vpp/src/plugins/dpdk/tghqos</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hierarchy">Hierarchy<a class="hash-link" href="#hierarchy" title="Direct link to heading">​</a></h3><p>The HQoS scheduler has 4 hierarchical levels, consisting of (1) port, (2) pipe,
(3) traffic class, (4) queue. A port is a Wigig device, and a pipe is a Wigig
peer. Packet IPv6 DSCP headers are used to classify packets into different
traffic classes with 3 different colors. Currently Terragraph uses 4 traffic
classes with 1 queue per traffic class. The color is coded as the drop
precedence of the packet in accordance with RFC 2597.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="red-dropper">RED Dropper<a class="hash-link" href="#red-dropper" title="Direct link to heading">​</a></h3><p>To avoid congestion, packets arriving at the scheduler go through a dropper that
supports Random Early Detection (RED), Weighted Random Early Detection (WRED),
and tail drop algorithms. The RED dropper is the same as the original one in
<code>librte_sched</code>, ported into VPP to decouple the HQoS implementation from any
specific DPDK libraries.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cli-commands">CLI Commands<a class="hash-link" href="#cli-commands" title="Direct link to heading">​</a></h3><p>The HQoS scheduler has many associated CLI commands for configuration, testing,
and stat collection purposes. The HQoS-specific CLI commands are provided in and
documented in <code>tghqos_cli.c</code>, including example command invocations and outputs.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hqos-operation">HQoS Operation<a class="hash-link" href="#hqos-operation" title="Direct link to heading">​</a></h3><p>The HQoS scheduler is logically part of the VPP Wigig output interface. When a
packet is directed to a Wigig interface for tx (<code>WigigX/Y/Z/0-tx</code>), it will
first go through the HQoS scheduler before being passsed to the driver for
transmission.</p><p>The HQoS scheduler performs classification, enqueue, and dequeue operations on
each packet. For classification, the scheduler reads the mbuf&#x27;s link id metadata
stored in a <code>dynfield</code> of the mbuf to determine the pipe to which the packet is
assigned, and it maps the DSCP value to the appropriate traffic class, queue,
and color. This information gets stored in the mbuf&#x27;s <code>sched</code> field. The enqueue
operation uses this information to store the packet in the appropriate queue,
dropping the packet as the RED dropper algorithm deems necessary or if the queue
is full. The dequeue operation currently uses strict priority scheduling by
default, where packets are dequeued from the HQoS scheduler in strict priority
order according to traffic class. Since the Wigig driver has separate transmit
rings for each peer, the HQoS scheduler uses feedback from the driver about each
transmit ring&#x27;s occupancy to determine how many packets to dequeue for each
pipe. Note that the traffic class prioritization is thus applied within each
pipe independently, and not across all pipes at once. After packets are dequeued
from the HQoS scheduler, they are passed to the driver for transmission.</p><p>Weighted round robin scheduling with priority levels is also provided as an
option. Traffic classes are assigned a priority level and a weight. Traffic
classes at a higher priority level are served before traffic classes at a lower
priority level. Traffic classes at the same priority level are served in
accordance to assigned weight. Each traffic class must have a non-zero weight
in one priority level. Besides that requirement, weights can be arbitrary
non-negative integers; for each traffic class the scheduler will use the
proportion of its weight to the sum of weights in that priority level to
determine the proportion of packet segments that traffic class can send during
each transmission period.</p><p>By default, the HQoS operations for a Wigig device run in the VPP node graph on
the same worker thread used for its rx processing, but it can also be configured
to use separate threads (see
<a href="#vpp-implementation-interface-thread-assignment">Interface Thread Assignment</a>).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="wigig-jumbo-frame-support">Wigig Jumbo Frame Support<a class="hash-link" href="#wigig-jumbo-frame-support" title="Direct link to heading">​</a></h2><p>The Wigig device software has an MTU of 4000 bytes, so any packets of length
greater than 4000 are considered jumbo frames that must be segmented before
being transmitted across a Wigig link.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="vpp-and-dpdk-buffers">VPP and DPDK Buffers<a class="hash-link" href="#vpp-and-dpdk-buffers" title="Direct link to heading">​</a></h3><p>Packets are represented as DPDK <code>rte_mbuf</code> structs, and each <code>rte_mbuf</code> has 2176
bytes of data space in VPP. Packets of total packet length greater than 2176 are
represented as a chain of <code>rte_mbuf</code> segments. Multi-segment packets are also
chained with <code>vlib_buffer_t</code> linkage for processing in VPP.</p><p align="center"><img loading="lazy" src="/figures/vpp_buffers.png" width="1000" class="img_ev3q"></p><p>After VPP receives packets via <code>dpdk-input</code>, the vlib buffer&#x27;s <code>current_data</code>
offset pointer, which is used as the start of data to be processed in VPP, is
set to <code>mbuf-&gt;data_off - 128</code>
(<code>RTE_PKTMBUF_HEADROOM = VLIB_BUFFER_PRE_DATA_SIZE = 128</code>):</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  b[0]-&gt;current_data = mb[0]-&gt;data_off - RTE_PKTMBUF_HEADROOM;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This refers to the same address as <code>mbuf-&gt;buf_addr + mbuf-&gt;data_off</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="jumbo-frame-segmentation">Jumbo Frame Segmentation<a class="hash-link" href="#jumbo-frame-segmentation" title="Direct link to heading">​</a></h3><p>Jumbo frames can be easily segmented by cutting the mbuf linkage along the mbuf
chain. After inserting a custom header, these segments can be enqueued for
transmission as individual packets.</p><p align="center"><img loading="lazy" src="/figures/vpp_seg_header.png" width="1000" class="img_ev3q"></p><p>Segmented Terragraph jumbo frame packets are identified by the custom Ethernet
type <code>0xFF71</code> (<code>TG_JUMBO</code>). Since segmented Terragraph packets exist only on a
Wigig segment between two TG nodes, the value of the Ethernet type itself is not
important. The combination of the custom fields <code>packet_id</code>, <code>seg_index</code>, and
<code>last_seg</code> are used in segmentation and reassembly. A <code>protocol_version</code> field
is included for futureproofing.</p><p>The current maximum supported jumbo frame packet size in VPP is about 18KB. This
is determined by the number of segments that can be stored according to
<code>TG_JUMBO_FRAME_SEG_ARRAY_LEN</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="transmitting--segmentation">Transmitting / Segmentation<a class="hash-link" href="#transmitting--segmentation" title="Direct link to heading">​</a></h4><p>Segmentation is done prior to the input of the HQoS transmit queue in the DPDK
plugin. Jumbo frames are identified by packet length and are segmented by
breaking the mbuf chain. Custom segmentation headers are prepended to each
segment&#x27;s packet data.</p><p>There is no guarantee that each segment has sufficient headroom to fit the
segmentation header, so packet data must be shifted to allow for enough space
for the header. Each <code>rte_mbuf</code> would typically be allocated
<code>RTE_PKTMBUF_HEADROOM</code> (128) bytes of headroom, but drivers may choose to leave
0 bytes of headroom for noninitial segments (e.g. DPAA2 driver). Accordingly,
segments that require data shifting will likely not have enough tailroom, and
will require the tail end of its packet data to be copied to the next segment.</p><p>After cutting segment chains, shifting and copying data, and inserting headers,
segments are enqueued to the HQoS transmit queue as individual packets. No
further VPP node processing will occur so there is no need to address
<code>vlib_buffer_t</code> linkage.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="receiving--reassembly">Receiving / Reassembly<a class="hash-link" href="#receiving--reassembly" title="Direct link to heading">​</a></h4><p>Reassembly is done as soon as packets are received from the driver in the DPDK
plugin, prior to injecting the packet into the rest of the VPP node graph. Only
one fragmented packet can be in flight at a time, per flow. Since the Wigig has
no concept of traffic class, there is a maximum of one fragmented packet per
peer per sector.</p><p>After an array of mbufs is received from the driver, jumbo frame segment packets
are identified by their Ethernet type and removed from the mbuf processing
array. They are stored in an array per device according to the link id found in
a <code>dynfield</code> of the mbuf and its <code>seg_index</code> field. After a segment with the
<code>last_seg</code> field set is received, reassembly is attempted by first checking that
there is a segment for every prior index, and verifying all stored segments have
the same <code>packet_id</code>. Then, create the linkage for the packet by chaining the
mbufs, and increment each mbuf segment&#x27;s data_off field to skip over the custom
segmentation header.</p><p>The reassembled single packet is then passed on to <code>dpdk_process_rx_burst</code> for
further processing, including creating <code>vlib_buffer_t</code> linkage.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="vpp-threads--core-allocation">VPP Threads &amp; Core Allocation<a class="hash-link" href="#vpp-threads--core-allocation" title="Direct link to heading">​</a></h2><p>The table below lists all VPP and PMD threads along with their CPU core
allocation on Puma hardware (4 cores).</p><table><thead><tr><th>Thread Name</th><th>Core #</th><th>Purpose</th></tr></thead><tbody><tr><td><code>vpp_main</code></td><td>1</td><td>Handles CLI, Wigig, and network events, etc.</td></tr><tr><td><code>vpp_wk_X</code></td><td>2-3</td><td>Datapath workers (one per CPU core)</td></tr><tr><td><code>eal-intr-thread</code></td><td>0</td><td>Primary PCI interrupt dispatcher</td></tr><tr><td><code>wil6210_wmiX</code></td><td>1</td><td>Interrupt handlers (one per Wigig card)</td></tr><tr><td><code>poll-dhdX</code></td><td>1</td><td><code>ioctl</code> dispatcher (one per Wigig card)</td></tr><tr><td><code>wil-fw-log-poll</code></td><td>1</td><td>Firmware/ucode log polling (one per Wigig card)</td></tr><tr><td><code>nl60g-poll</code></td><td>1</td><td>Communicate with <code>host_manager_11ad</code> utility (one per Wigig card)</td></tr></tbody></table><p>The core allocation is set by <code>update_vpp_startup_conf.lua</code> using the VPP
configuration options <code>cpu skip-cores</code>, <code>cpu workers</code>, and
<code>dpdk dev &lt;pci_id&gt; workers</code>. Threads created by the PMD are set to use the
master lcore (&quot;logical core&quot;) for DPDK, i.e. the core used for <code>vpp_main</code>.</p><p>On Puma, CPU cores 2 and 3 are reserved for the datapath, enforced by passing
<code>isolcpus=2,3</code> in the Linux kernel configuration. Most user processes are
expected to run on CPU core 1, configured by runit via <code>taskset</code> (refer to
<a href="/docs/developer/Service_Scripts#service-scripts-runit-scripts">runit scripts</a> for more
details). However, the remaining core is <em>not</em> used for the datapath, as several
firmware crashes have been observed when reserving three datapath cores.</p><a id="vpp-implementation-interface-thread-assignment"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="interface-thread-assignment">Interface Thread Assignment<a class="hash-link" href="#interface-thread-assignment" title="Direct link to heading">​</a></h3><p>When an interface is assigned to a worker thread, its rx processing begins on
that thread, and packets received on that interface continue through the VPP
node graph on that thread. When these packets are directed to tx interfaces
without HQoS enabled, they are sent to the driver of the tx interface on the
same thread as it was received.</p><p>When these packets are directed to tx interfaces with HQoS enabled, packets are
not immediately sent to the driver, and the next immediate step is determined
by whether there are separate HQoS threads enabled:</p><ul><li><strong>No HQoS thread enabled</strong> - Packets are enqueued into HQoS queues. Packets
are dequeued from HQoS queues and sent to the device driver during the
execution of the <code>dpdk-input</code> polling node associated with the tx interface.
This happens on the worker thread to which its rx processing was assigned,
not the worker thread on which the packet was originally received.</li><li><strong>HQoS thread enabled</strong> - Packets are passed to the HQoS thread via a software
queue in VPP. The separate HQoS thread will receive these packets and handle
enqueuing into HQoS queues, dequeueing from HQoS queues, and sending to device
drivers.</li></ul><p>The current default configuration has HQoS enabled on Wigig devices and no HQoS
threads enabled. HQoS threads can be enabled by using the
<code>cpu corelist-tghqos-threads</code> option in VPP&#x27;s startup configuration and moving
all interface rx processing onto one worker thread. Enabling HQoS threads may be
beneficial for certain types of traffic, particularly with small packet sizes on
nodes with 1 or 2 Wigig sectors, but performance suffers when passing traffic at
maximum throughput on 3 or 4 sectors.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="firmware-message-paths">Firmware Message Paths<a class="hash-link" href="#firmware-message-paths" title="Direct link to heading">​</a></h2><p>This section describes the flow of firmware <code>ioctl</code> calls (initiated by
user-space programs) and firmware events (initiated by firmware) within VPP. For
a system-level view of these message paths, refer to
<a href="/docs/developer/Driver_Stack#driver-stack-example-message-path">Driver Stack</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="firmware-ioctl">Firmware <code>ioctl</code><a class="hash-link" href="#firmware-ioctl" title="Direct link to heading">​</a></h3><p>Firmware <code>ioctl</code> calls are initiated from user-space programs (e.g. e2e_minion)
and require a completion notification from firmware. The path is as follows:</p><table><thead><tr><th>Sequence</th><th>Entity</th><th>Actions</th></tr></thead><tbody><tr><td>1</td><td><code>poll-dhdX</code></td><td>Wake on <code>dhdX</code> network interface <code>wmi_send()</code><br>Write <code>ioctl</code> message to PCI</td></tr><tr><td>2</td><td>Wigig firmware</td><td>Process <code>ioctl</code> and generate completion event</td></tr><tr><td>3</td><td><code>eal-intr-thread</code></td><td>Wake on <code>VFIO_MSI</code> interrupt<br>Read firmware message from PCI<br>Dispatch to per-interface work thread</td></tr><tr><td>4</td><td><code>wil6210_wmiX</code></td><td>Wake on Linux futex (<code>pthread_cond_wait()</code>)<br>Read firmware message from work queue<br>Process completion event</td></tr><tr><td>5</td><td><code>poll-dhdX</code></td><td>Wake on Linux futex (<code>pthread_cond_wait()</code>)<br>Send completion event to driver</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="firmware-event">Firmware Event<a class="hash-link" href="#firmware-event" title="Direct link to heading">​</a></h3><p>Firmware events are initiated by firmware and do <em>not</em> require a completion
notification. The path is as follows:</p><table><thead><tr><th>Sequence</th><th>Entity</th><th>Actions</th></tr></thead><tbody><tr><td>1</td><td>Wigig firmware</td><td>Generate event</td></tr><tr><td>2</td><td><code>eal-intr-thread</code></td><td>Wake on <code>VFIO_MSI</code> interrupt<br>Read firmware message from PCI<br>Dispatch to per-interface work thread</td></tr><tr><td>3</td><td><code>wil6210_wmiX</code></td><td>Wake on Linux futex (<code>pthread_cond_wait()</code>)<br>Read firmware message from work queue<br>Send event to driver</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="debugging">Debugging<a class="hash-link" href="#debugging" title="Direct link to heading">​</a></h2><p>This section briefly describes possible debugging options for VPP.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="use-debug-builds">Use Debug Builds<a class="hash-link" href="#use-debug-builds" title="Direct link to heading">​</a></h3><p>Recompile VPP and any plugins (ex. <code>vpp-tgcfg</code>) with debug information by adding
these lines to <code>conf/local.conf</code>:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DEBUG_BUILD_pn-vpp = &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DEBUG_BUILD_pn-vpp-tgcfg = &quot;1&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="enable-core-dumps">Enable Core Dumps<a class="hash-link" href="#enable-core-dumps" title="Direct link to heading">​</a></h3><p>VPP core dumps can be enabled via the node configuration field
<code>envParams.VPP_COREDUMP_ENABLED</code> (enabled by default). Core dumps are written to
<code>/var/volatile/cores/</code> and can be loaded into <code>gdb</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="collect-packet-traces">Collect Packet Traces<a class="hash-link" href="#collect-packet-traces" title="Direct link to heading">​</a></h3><p>VPP allows collecting packet traces at different points of the datapath using
the &quot;trace&quot; commands (e.g. <code>trace add &lt;node&gt;</code>, <code>show trace</code>, <code>clear trace</code>).
Some important graph nodes include:</p><ul><li><code>dpdk-input</code>: All traffic arriving into VPP from wired or wigig interfaces</li><li><code>tg-link-local-rx</code>: All traffic arriving into VPP from <code>terraX</code> interfaces on
the Linux side</li><li><code>tapcli-rx</code>: All traffic arriving into VPP from the <code>vnet0</code> interface on the
Linux side</li><li><code>vpp-terraX-tx</code>: All traffic generated in VPP for <code>vpp-terraX</code> interfaces
(replace X with the actual index)</li><li><code>pg-trace</code>: All traffic generated by VPP&#x27;s packet generator</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a class="hash-link" href="#resources" title="Direct link to heading">​</a></h2><ul><li><a href="https://www.dpdk.org/" target="_blank" rel="noopener noreferrer">DPDK</a> - Data Plane Development Kit</li><li><a href="http://doc.dpdk.org/guides/prog_guide/qos_framework.html" target="_blank" rel="noopener noreferrer">DPDK QoS Framework</a> - DPDK QoS Framework implemented in <code>librte_sched</code></li><li><a href="https://wiki.fd.io/view/VPP" target="_blank" rel="noopener noreferrer">VPP</a> - Vector Packet Processing</li><li><a href="https://github.com/facebook/openr" target="_blank" rel="noopener noreferrer">Open/R</a> - Meta&#x27;s routing platform</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/terragraph/meta-terragraph/edit/main/docs/../docs/developer/VPP_Implementation.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/developer/Driver_Stack"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Driver Stack</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/developer/Timing_Synchronization"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Timing and Synchronization</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a><ul><li><a href="#versioning" class="table-of-contents__link toc-highlight">Versioning</a></li><li><a href="#code-structure" class="table-of-contents__link toc-highlight">Code Structure</a></li><li><a href="#vpp-services" class="table-of-contents__link toc-highlight">VPP Services</a></li><li><a href="#vpp-packet-processing-graph" class="table-of-contents__link toc-highlight">VPP Packet Processing Graph</a></li></ul></li><li><a href="#stock-vpp-datapath-overview" class="table-of-contents__link toc-highlight">Stock VPP Datapath Overview</a></li><li><a href="#terragraph-config-plugin-vpp-tgcfg" class="table-of-contents__link toc-highlight">Terragraph Config Plugin (vpp-tgcfg)</a><ul><li><a href="#interfaces" class="table-of-contents__link toc-highlight">Interfaces</a></li><li><a href="#configuration" class="table-of-contents__link toc-highlight">Configuration</a></li><li><a href="#graph-nodes" class="table-of-contents__link toc-highlight">Graph Nodes</a></li></ul></li><li><a href="#hqos-scheduler-tghqos" class="table-of-contents__link toc-highlight">HQoS Scheduler (TGHQoS)</a><ul><li><a href="#code-structure-1" class="table-of-contents__link toc-highlight">Code Structure</a></li><li><a href="#hierarchy" class="table-of-contents__link toc-highlight">Hierarchy</a></li><li><a href="#red-dropper" class="table-of-contents__link toc-highlight">RED Dropper</a></li><li><a href="#cli-commands" class="table-of-contents__link toc-highlight">CLI Commands</a></li><li><a href="#hqos-operation" class="table-of-contents__link toc-highlight">HQoS Operation</a></li></ul></li><li><a href="#wigig-jumbo-frame-support" class="table-of-contents__link toc-highlight">Wigig Jumbo Frame Support</a><ul><li><a href="#vpp-and-dpdk-buffers" class="table-of-contents__link toc-highlight">VPP and DPDK Buffers</a></li><li><a href="#jumbo-frame-segmentation" class="table-of-contents__link toc-highlight">Jumbo Frame Segmentation</a></li></ul></li><li><a href="#vpp-threads--core-allocation" class="table-of-contents__link toc-highlight">VPP Threads &amp; Core Allocation</a><ul><li><a href="#interface-thread-assignment" class="table-of-contents__link toc-highlight">Interface Thread Assignment</a></li></ul></li><li><a href="#firmware-message-paths" class="table-of-contents__link toc-highlight">Firmware Message Paths</a><ul><li><a href="#firmware-ioctl" class="table-of-contents__link toc-highlight">Firmware <code>ioctl</code></a></li><li><a href="#firmware-event" class="table-of-contents__link toc-highlight">Firmware Event</a></li></ul></li><li><a href="#debugging" class="table-of-contents__link toc-highlight">Debugging</a><ul><li><a href="#use-debug-builds" class="table-of-contents__link toc-highlight">Use Debug Builds</a></li><li><a href="#enable-core-dumps" class="table-of-contents__link toc-highlight">Enable Core Dumps</a></li><li><a href="#collect-packet-traces" class="table-of-contents__link toc-highlight">Collect Packet Traces</a></li></ul></li><li><a href="#resources" class="table-of-contents__link toc-highlight">Resources</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Terragraph</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/runbook/Overview">Overview</a></li><li class="footer__item"><a href="https://www.facebook.com/connectivity" target="_blank" rel="noopener noreferrer" class="footer__link-item">Meta Connectivity<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/terragraph" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/HQaxCevzus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.ee1b3ecd.js"></script>
<script src="/assets/js/main.feb34f19.js"></script>
</body>
</html>