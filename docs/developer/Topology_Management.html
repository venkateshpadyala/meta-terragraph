<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-developer/Topology_Management">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="search" type="application/opensearchdescription+xml" title="Terragraph" href="/opensearch.xml">
<link rel="stylesheet" href="/katex/katex.min.css"><title data-rh="true">Topology Management | Terragraph</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://terragraph.com/logo/terragraph-logo-full-RGB.png"><meta data-rh="true" name="twitter:image" content="https://terragraph.com/logo/terragraph-logo-full-RGB.png"><meta data-rh="true" property="og:url" content="https://terragraph.com/docs/developer/Topology_Management"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Topology Management | Terragraph"><meta data-rh="true" name="description" content="This document describes the management of the network topology."><meta data-rh="true" property="og:description" content="This document describes the management of the network topology."><link data-rh="true" rel="icon" href="/logo/terragraph-logo-favicon-32x32-full-RGB.png"><link data-rh="true" rel="canonical" href="https://terragraph.com/docs/developer/Topology_Management"><link data-rh="true" rel="alternate" href="https://terragraph.com/docs/developer/Topology_Management" hreflang="en"><link data-rh="true" rel="alternate" href="https://terragraph.com/docs/developer/Topology_Management" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TB9T0CGM6Y-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.48218837.css">
<link rel="preload" href="/assets/js/runtime~main.ee1b3ecd.js" as="script">
<link rel="preload" href="/assets/js/main.feb34f19.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo/terragraph-logo-favicon-32x32-full-RGB.svg" alt="Terragraph Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/logo/terragraph-logo-favicon-32x32-white-RGB.svg" alt="Terragraph Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/terragraph/meta-terragraph" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link githubButton navbarIconButton" title="GitHub"></a><a href="https://discord.gg/HQaxCevzus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link discordButton navbarIconButton" title="Discord"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/runbook">Runbook</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/developer">Developer Manual</a></li><li><a class="dropdown__link" href="/docs/whitepapers">Whitepapers</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/developer">Developer Manual</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developer Manual&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Communication_Protocol">Architecture</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Beamforming_Link_Adaptation">Firmware Layer</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/developer/Topology_Management">End-to-End (E2E) Service</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/developer/Topology_Management">Topology Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Network_Ignition">Network Ignition</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Software_Upgrade">Software Upgrade</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Configuration_Management">Configuration Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Scans">Scans</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Network_Measurements">Network Measurements</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Prefix_Allocation">Prefix Allocation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Topology_Discovery">Topology Discovery</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Stats_Events_Logs">Application Layer Modules</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Service_Scripts">System Management</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Release_Conventions">Version Control</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/developer"><span itemprop="name">Developer Manual</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">End-to-End (E2E) Service</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Topology Management</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Topology Management</h1><p>This document describes the management of the network topology.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="network-elements">Network Elements<a class="hash-link" href="#network-elements" title="Direct link to heading">​</a></h2><p>This section briefly describes the elements of a Terragraph network topology in
the context of the E2E service.</p><p>The three basic topology elements are listed below:</p><ul><li><strong>Node</strong> - A general purpose compute unit that controls one or more sectors
(wireless baseband cards).</li><li><strong>Site</strong> - A collection of one or more nodes installed at the same physical
location.</li><li><strong>Link</strong> - A connection between two sectors or nodes.</li></ul><p><em>Nodes</em> have several distinct properties:</p><ul><li><strong>DN/CN</strong> - Each node is either a <em>Distribution Node (DN)</em> or <em>Client Node
(CN)</em>. DNs form the backbone of the Terragraph mesh network, while CNs act as
the termination point where service delivery takes place.</li><li><strong>POP</strong> - Any primary DN which is interconnected via fiber to a carrier&#x27;s
network is known as a <em>Fiber Point-of-Presence (POP)</em>. These POP nodes serve
as the demarcation between the Terragraph network and the provider&#x27;s backbone
network.</li><li><strong>Sectors</strong> - Nodes control one or more sectors, which are identified by their
MAC addresses (also referred to as &quot;radio MACs&quot; or &quot;WLAN MACs&quot;). Puma hardware
supports up to 4 sectors.</li></ul><p><em>Links</em> have the following properties:</p><ul><li><strong>Wired/Wireless</strong> - Each link is either <em>wired</em> (Ethernet) or <em>wireless</em>
(RF). Wired links are used mainly between primary and secondary DNs.</li><li><strong>Primary/Backup</strong> <em>(DN-to-CN links only)</em> - CNs can only form one link, but
additional <em>backup links</em> can be provided for use when the <em>primary link</em> is
unavailable.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="topology-structure">Topology Structure<a class="hash-link" href="#topology-structure" title="Direct link to heading">​</a></h2><p>All topology structures are defined in <code>Topology.thrift</code>, and are contained
within the parent structure <code>thrift::Topology</code>.</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">Topology</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> list</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Node</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> nodes</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">3</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> list</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Link</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> links</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> list</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Site</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> sites</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">5</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Config config</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Currently, the properties captured by the <code>thrift::Topology</code> structure can be
categorized as follows:</p><table><thead><tr><th>Category</th><th>Examples</th></tr></thead><tbody><tr><td>Network Graph</td><td>Nodes, links, sites</td></tr><tr><td>Controller Configuration</td><td>Deterministic Prefix Allocation config</td></tr><tr><td>Network State</td><td>Node status, link liveness, link-up counters</td></tr><tr><td>Installation/Inventory/Assets</td><td>Antenna azimuth, elevation</td></tr></tbody></table><p>Most of these properties are persistent. However, the network state properties
are non-persistent and get updated dynamically by the controller.</p><p>The full topology is stored only on the controller and is not propagated to
nodes, with the exception of node configuration. In particular, the controller
adds some topology information to the node&#x27;s <code>topologyInfo</code> configuration
structure, which includes the node&#x27;s &quot;name&quot; and neighboring nodes&#x27; properties,
among other details.</p><p>Lastly, a node&#x27;s MAC address (or &quot;node ID&quot;) is currently overloaded in several
ways:</p><ul><li><em>ZMQ Identity</em> - Nodes use their MAC address as their ZMQ socket identity.
Refer to <a href="/docs/developer/Communication_Protocol">Communication Protocol</a> for
further details.</li><li><em>Routing</em> - The Open/R identity of each node is its MAC address. Refer to
<a href="/docs/developer/Routing_Layer">Routing Layer</a> for further details.</li><li><em>Radio MAC</em> - The node MAC is usually not equivalent to the radio MAC(s),
particularly on hardware providing multiple sectors.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="topology-changes">Topology Changes<a class="hash-link" href="#topology-changes" title="Direct link to heading">​</a></h2><p>The network topology is provided to the controller as a file during startup, and
can be modified during runtime through <code>TopologyApp</code>. All requested topology
changes are validated, and the controller will automatically assign any
additional parameters to a new node or link as necessary (discussed later). Most
of the logic for topology changes resides in <code>TopologyWrapper</code>.</p><p><code>TopologyApp</code> accepts the following <em>user operations</em> on the topology:</p><table><thead><tr><th>User Operation</th><th>Commands</th></tr></thead><tbody><tr><td>Modify Network Graph</td><td><code>ADD_NODE</code>, <code>DEL_NODE</code>, <code>EDIT_NODE</code> <br> <code>ADD_LINK</code>, <code>DEL_LINK</code> <br> <code>ADD_SITE</code>, <code>DEL_SITE</code>, <code>EDIT_SITE</code> <br> <code>BULK_ADD</code></td></tr><tr><td>Set MAC Address</td><td><code>SET_NODE_MAC</code>, <code>SET_NODE_MAC_LIST</code>, <code>ADD_NODE_WLAN_MACS</code>, <code>DEL_NODE_WLAN_MACS</code>, <code>CHANGE_NODE_WLAN_MAC</code></td></tr><tr><td>Set Network Parameters</td><td><code>SET_NETWORK_PARAMS_REQ</code></td></tr><tr><td>Set Topology Name</td><td><code>SET_TOPOLOGY_NAME</code></td></tr><tr><td>Reset Link-Up Counters</td><td><code>RESET_TOPOLOGY_STATE</code></td></tr><tr><td>Reallocate Node Prefixes</td><td><code>ALLOCATE_PREFIXES</code></td></tr></tbody></table><p>The topology is also modified upon receiving the following commands from other
apps:</p><ul><li><code>SET_NODE_STATUS</code> - When a previously offline node sends a status report,
<code>StatusApp</code> requests that <code>TopologyApp</code> mark the node as &quot;online&quot;.</li><li><code>SET_NODE_PARAMS_REQ</code> - When a previously offline node sends a status report,
<code>StatusApp</code> requests that <code>TopologyApp</code> send configuration to the node.</li><li><code>BUMP_LINKUP_ATTEMPTS</code> - When attempting to ignite a link, <code>IgnitionApp</code>
requests that <code>TopologyApp</code> increment the corresponding link-up counter.</li><li><code>LINK_STATUS</code> - When a link&#x27;s state changes, the <em>minion&#x27;s</em> <code>IgnitionApp</code>
requests that <code>TopologyApp</code> update the corresponding link&#x27;s liveness state.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="parameter-assignment-and-validation">Parameter Assignment and Validation<a class="hash-link" href="#parameter-assignment-and-validation" title="Direct link to heading">​</a></h2><p>On startup and before any topology change, the controller performs thorough
validation of all relevant topology parameters. Additionally, when new elements
are added, the controller automatically assigns node and link parameters. These
processes are summarized in the following table, with additional details in the
sections below.</p><table><thead><tr><th>Parameter</th><th>Element</th><th>Dynamic Changes?</th><th>Automatic?</th><th>Key(s)</th><th>Values</th></tr></thead><tbody><tr><td>Polarity</td><td>radio</td><td>yes (synchronized)</td><td>yes</td><td><code>radioParamsOverrides.[radioMac].fwParams.polarity</code></td><td>1 (odd), 2 (even), 3 (hybrid-odd), 4 (hybrid-even)</td></tr><tr><td>Channel</td><td>radio</td><td>no</td><td>yes</td><td><code>radioParamsOverrides.[radioMac].fwParams.channel</code></td><td>1-4</td></tr><tr><td>Golay Index</td><td>link</td><td>yes (synchronized)</td><td>yes</td><td><code>linkParamsOverrides.[responderMac].fwParams.txGolayIdx</code><br><code>linkParamsOverrides.[responderMac].fwParams.rxGolayIdx</code></td><td>0-3, 4-7 (copies)</td></tr><tr><td>Control Superframe</td><td>link</td><td>no</td><td>yes</td><td><code>linkParamsOverrides.[responderMac].fwParams.controlSuperframe</code></td><td>0, 1, 255</td></tr><tr><td>Airtime</td><td>link</td><td>yes</td><td>no</td><td><code>linkParamsOverrides.[responderMac].airtimeConfig.*</code></td><td>-</td></tr></tbody></table><p>Controller-assigned parameters are stored in the automatic node overrides layer
of the node configuration (can be overridden by user configuration if required),
and are accessed and modified via <code>ConfigHelper</code> (refer to
<a href="/docs/developer/Configuration_Management">Configuration Management</a> for further details).</p><p>For firmware parameters which cannot be dynamically changed (i.e. post-config
action is <code>RELOAD_FIRMWARE</code>), any update to live radios or links will trigger a
firmware reload. If dynamic changes must be synchronized across affected links
(i.e. post-config action is <code>SET_FW_PARAMS_SYNC_OR_RELOAD_FIRMWARE</code>), then the
change will be scheduled at a specific BWGD index as determined by the
controller&#x27;s <code>GpsClock</code> time plus a default delay of 5.12 seconds (controller
flag <code>--firmware_parameter_update_delay</code>), with an additional firmware
constraint that no more than 2 parameter updates can be scheduled simultaneously
(otherwise firmware will be reloaded to apply all changes).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="polarity">Polarity<a class="hash-link" href="#polarity" title="Direct link to heading">​</a></h3><p>Polarity validation and assignment is handled by <code>PolarityHelper</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="background">Background<a class="hash-link" href="#background" title="Direct link to heading">​</a></h4><p>Sectors on both ends of a wireless link alternate between transmitting and
receiving in complementary time slots. This dramatically reduces interference,
as nodes only receive very weak interfering signals from at least three hops
away. To achieve this, each sector is assigned a <em>polarity</em> of <code>ODD</code> or
<code>EVEN</code>.</p><p align="center"><img loading="lazy" src="/figures/polarity.svg" width="400" class="img_ev3q"></p><p>This simple assignment scheme requires neighbors in the network graph to have
opposite polarities, and only works if the graph can be bipartitioned. To
support topologies with odd cycles, <em>hybrid polarities</em> can be used in two
distinct ways:</p><ul><li><em>Hardware hybrid</em> - A site can contain sectors with different polarities.
These are &quot;hardware&quot; hybrids, which use hardware solutions to avoid inter-node
transmit and receive interference. However, in a small fraction of cases (on
the order of 1%), sectors in close proximity on the same site may still cause
significant self-interference.</li><li><em>Software hybrid</em> - When hardware hybrid solutions are not possible, sectors
can instead use time-division multiplexing to alternate between odd and even
polarities. These &quot;software&quot; hybrids are tagged in E2E as <code>HYBRID_ODD</code> or
<code>HYBRID_EVEN</code>, and require special handling by the controller (discussed
below). Software hybrid sectors on a site will access the medium orthogonally,
resulting in a 50% loss in bandwidth.</li></ul><p>In the sections below, &quot;hybrid&quot; will refer to software hybrids unless otherwise
noted, since hardware hybrids are not treated differently from regular
polarities in E2E.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="validation">Validation<a class="hash-link" href="#validation" title="Direct link to heading">​</a></h4><p>Constraints:</p><ul><li>Nodes on the same site must all be non-hybrid (<code>ODD</code>, <code>EVEN</code>) or hybrid
(<code>HYBRID_ODD</code>, <code>HYBRID_EVEN</code>).</li><li>Wireless links must have different polarity on both ends (<code>ODD</code>, <code>HYBRID_ODD</code>
to <code>EVEN</code>, <code>HYBRID_EVEN</code>).</li><li>A wireless link cannot have hybrid nodes on both ends.</li><li>P2MP (point to multi-point) nodes, such as Y-street nodes, cannot be hybrid.
In other words, hybrid-polarity DNs support only a single DN to DN link.</li></ul><p>Polarity is only relevant when links are formed. Thus, unspecified polarities
are allowed on nodes until a link is added.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="assignment">Assignment<a class="hash-link" href="#assignment" title="Direct link to heading">​</a></h4><p>When adding a link:</p><ul><li>If validation succeeds with the given values, do nothing.</li><li>If both nodes had unspecified polarity, forcibly set one of them (to a site
polarity if one exists, otherwise arbitrarily).</li><li>If one node has no other links, set its polarity to the opposite of the other
node.</li></ul><p>Currently, the controller will not automatically assign a hybrid polarity.
Hybrid polarity must be explicitly set by the user.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="network-wide-reassignment">Network-Wide Reassignment<a class="hash-link" href="#network-wide-reassignment" title="Direct link to heading">​</a></h4><p>The controller provides a mechanism to perform a network-wide polarity
optimization, using the <em>odd cycle cover (OCC)</em> algorithm in <code>OccSolver</code> to find
the minimum set of hardware hybrid sites required to achieve a bipartite graph.
This operation is triggered manually via the <code>TRIGGER_POLARITY_OPTIMIZATION</code>
command.</p><p>The polarity optimization process has the following features:</p><ul><li>It respects all user-configured polarities, and will fail if any changes to
user overrides are required. This can be overridden by setting the
<code>clearUserPolarityConfig</code> flag, informing the algorithm to reset all user
overrides before attempting a polarity optimization.</li><li>It tries to avoid allocating sites with P2MP radios as hybrids, reducing the
chance of misconfiguration.</li><li>It tries to honor existing polarity assignments as much as possible, reducing
disruption to the network. Currently, changing polarity requires breaking
links.</li><li>It does not allocate any software hybrids unless configured by the user.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="golay-index">Golay Index<a class="hash-link" href="#golay-index" title="Direct link to heading">​</a></h3><p>Golay index validation and assignment is handled by <code>GolayHelper</code>. Note that the
controller will only assign Golay indexes 1 and 2 by default.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="background-1">Background<a class="hash-link" href="#background-1" title="Direct link to heading">​</a></h4><p>Every packet transmitted over the air in a Terragraph network contains a PHY
layer preamble consisting of a <em>Short Training Field</em> (STF) and a <em>Channel
Estimation Field</em> (CEF), as defined in the <a href="https://standards.ieee.org/findstds/standard/802.11-2016.html" target="_blank" rel="noopener noreferrer">IEEE 802.11-2016</a> standard. The
receiver uses the STF to detect the presence of a packet in the air and thus
start the remainder of the packet acquisition process. Since the same preamble
is used, irrespective of the Modulation and Coding Set (MCS) used for the data
payload, the STF is designed to be detectable even at very low signal to noise
ratios (SNR). As a consequence, a weak interfering packet will trigger packet
acquisition, and any desired packet arriving while the receiver is busy
attempting to decode the interfering packet will be missed. This is known as
<em>early weak interference</em> and is especially apparent in Terragraph&#x27;s current
TDMA network design.</p><p>Both the STF and CEF are derived from a 128-bit <em>Golay Code Sequence</em>. To
minimize the extent of early weak interference, different Golay Code Sequences
can be applied to interfering links so that the receiver will only begin the
packet acquisition process when it receives the expected preamble.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="validation-1">Validation<a class="hash-link" href="#validation-1" title="Direct link to heading">​</a></h4><p>Constraints:</p><ul><li>Golay codes on both ends of a link must be identical.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="assignment-1">Assignment<a class="hash-link" href="#assignment-1" title="Direct link to heading">​</a></h4><p>The procedure for assigning Golay codes to new links is detailed in
<a href="#topology-management-channel-golay-assignment">Algorithms for Channel and Golay Assignment</a>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="network-wide-reassignment-1">Network-Wide Reassignment<a class="hash-link" href="#network-wide-reassignment-1" title="Direct link to heading">​</a></h4><p>The controller provides a mechanism to perform a network-wide Golay reassignment
to resolve any misconfiguration. This operation is triggered manually via the
<code>TRIGGER_GOLAY_OPTIMIZATION</code> command.</p><p>The reassignment process implements the network-wide reassignment
procedure detailed in
<a href="#topology-management-channel-golay-assignment">Algorithms for Channel and Golay Assignment</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="channel">Channel<a class="hash-link" href="#channel" title="Direct link to heading">​</a></h3><p>Channel allocation is handled by <code>ChannelHelper</code>. Note that the controller will
only use channel 2 unless otherwise configured by the user (via controller
configuration field <code>topologyParams.enabledChannels</code>).</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="background-2">Background<a class="hash-link" href="#background-2" title="Direct link to heading">​</a></h4><p>Terragraph networks utilize the 60GHz (V-Band) spectrum. In many countries,
V-Band is unlicensed and allows for multiple GHz of RF bandwidth. The amount of
available spectrum for use by Terragraph varies depending on local wireless
regulations. Terragraph supports channels 1, 2, 3, and 4 in the 60GHz band. Each
channel, as per the 802.11ad specification, is 2.16GHz wide as shown below.</p><p align="center"><img loading="lazy" src="/figures/spectrum.png" width="800" class="img_ev3q"><br><em>60GHz band allocation</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="validation-2">Validation<a class="hash-link" href="#validation-2" title="Direct link to heading">​</a></h4><p>Constraints:</p><ul><li>Channels on all links at a node in point-to-multipoint must be identical.</li><li>Receiver and transmitter channels must be identical.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="assignment-2">Assignment<a class="hash-link" href="#assignment-2" title="Direct link to heading">​</a></h4><p>The procedure for assigning channels to new links is detailed in
<a href="#topology-management-channel-golay-assignment">Algorithms for Channel and Golay Assignment</a>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="network-wide-reassignment-2">Network-Wide Reassignment<a class="hash-link" href="#network-wide-reassignment-2" title="Direct link to heading">​</a></h4><p>The controller provides a mechanism to perform a network-wide channel
reassignment to resolve any misconfiguration. This operation is triggered
manually via the <code>TRIGGER_CHANNEL_OPTIMIZATION</code> command.</p><p>The reassignment process implements the network-wide reassignment
procedure detailed in
<a href="#topology-management-channel-golay-assignment">Algorithms for Channel and Golay Assignment</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="control-superframe">Control Superframe<a class="hash-link" href="#control-superframe" title="Direct link to heading">​</a></h3><p>Control superframe validation and assignment is handled by
<code>ControlSuperframeHelper</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="background-3">Background<a class="hash-link" href="#background-3" title="Direct link to heading">​</a></h4><p>The control superframe defines the time slot at which both ends of a link
exchange control information (i.e. keep-alive messages). For context, each
superframe is 1.6ms long and consists of 4 TDD frames. The control superframe is
an integer that can take values <code>0</code>, <code>1</code>, or <code>255</code> (equivalent to unspecified).
In order to transmit control information at non-conflicting time slots, a DN
sector must use a different control superframe on all of its wireless links to
other DN sectors. For DN to CN links, the control superframe should be left
unspecified.</p><p>Normally, in the P2P (point to point) scenario, the control superframe can be
left unspecified and will be handled automatically by the firmware; this is
equivalent to using the value <code>0</code>. However, with P2MP (point to multi-point),
the nodes at the opposite ends of the two links have no way to automatically
pick non-conflicting control superframes. The primary role of E2E is to assign
non-conflicting values (i.e. <code>0</code> and <code>1</code>) across these links.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="validation-3">Validation<a class="hash-link" href="#validation-3" title="Direct link to heading">​</a></h4><p>Constraints:</p><ul><li>All DN to DN links from a sector must have different (i.e. non-conflicting)
superframes. An unspecified value is considered a conflict if multiple DN to
DN links exist.</li><li>DN to CN links may all have unspecified control superframes (<code>255</code>).</li><li>Hybrid polarity DNs have pre-defined control superframe values. Links with
<code>HYBRID_EVEN</code> polarity must use <code>0</code> and links with <code>HYBRID_ODD</code> must use <code>1</code>.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="assignment-3">Assignment<a class="hash-link" href="#assignment-3" title="Direct link to heading">​</a></h4><p>When adding a link:</p><ul><li>If control superframe is unspecified on a DN to DN link, set it to <code>0</code>.</li><li>If validation succeeds with the given values, take no other actions (excluding
the one above).</li><li>Attempt reassignment to all acceptable values remaining (<code>0</code> and <code>1</code> for DN to
DN links; <code>255</code> for DN to CN links).</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="network-wide-reassignment-3">Network-Wide Reassignment<a class="hash-link" href="#network-wide-reassignment-3" title="Direct link to heading">​</a></h4><p>The controller provides a mechanism to perform a network-wide control superframe
reassignment to resolve any misconfiguration. This operation is triggered
manually via the <code>TRIGGER_CONTROL_SUPERFRAME_OPTIMIZATION</code> command.</p><p>The reassignment process has the following features:</p><ul><li>It respects all user-configured values, and will fail if any changes to
user overrides are required. This can be overridden by setting the
<code>clearUserConfig</code> flag, informing the controller to reset all user
overrides before attempting a reassignment.</li><li>It tries to honor existing control superframe assignments as much as possible,
reducing disruption to the network. Currently, changing control superframe
requires breaking links.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="airtime">Airtime<a class="hash-link" href="#airtime" title="Direct link to heading">​</a></h3><p>Airtime allocation is handled by <code>BandwidthAllocationHelper</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="background-4">Background<a class="hash-link" href="#background-4" title="Direct link to heading">​</a></h4><p>The default airtime allocation on each node can be overridden through the
<code>thrift::NetworkAirtime</code> structure, which defines a per-link map of the minimum,
maximum, and ideal transmit/receive percentages. This can be used, for instance,
to enforce fair resource allocation across the network topology.</p><p>This feature is a work in progress and is not currently enabled.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="allocation">Allocation<a class="hash-link" href="#allocation" title="Direct link to heading">​</a></h4><p>If automatic airtime allocation is enabled, <code>TopologyApp</code> will recompute the
fair airtime allocation map on startup and whenever the topology is modified.
The controller sends any airtime changes to nodes using the <code>SET_NODE_PARAMS</code>
(<code>NETWORK</code>) command.</p><p>The airtime computations currently consider only the network graph and perform
simple shortest-paths computations to POP nodes. The algorithm does not yet take
routing into account.</p><a id="topology-management-channel-golay-assignment"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="algorithms-for-channel-and-golay-assignment">Algorithms for Channel and Golay Assignment<a class="hash-link" href="#algorithms-for-channel-and-golay-assignment" title="Direct link to heading">​</a></h3><p>The algorithms for assigning channel and Golay codes
based on interference estimates are handled by <code>InterferenceHelper</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="assignment-for-new-links">Assignment for New Links<a class="hash-link" href="#assignment-for-new-links" title="Direct link to heading">​</a></h4><p>There are 4 observed heuristics that affect interference which the
new link assignment algorithm attempts to mitigate:</p><ol><li>Adjacent links with &lt; 20 degree angles may have interference, regardless of
polarity.</li><li>Adjacent links with &gt; 50 degree angles do not show much interference.</li><li>Links with &gt; 2 links in between do not have interference.</li><li>Two links with one link in between will have interference (between the
initial sector of the first link and last sector of the last link). Thus,
there should not be three consecutive links with the same Golay code
or channel. Additionally, the Golay/channels must not take the form <code>a-b-a</code>;
their form should be either <code>a-a-b</code> or <code>a-b-b</code>.</li></ol><p>When adding a link:</p><ul><li>Generate a directed graph of all wireless links in the topology and their
angular differences. Each vertex represents a link in the original network
graph, and an edge represents links connected to the same site. Edges also
track the angular difference between a link and its adjacencies.</li><li>Assign the link&#x27;s Golay code or channel by applying the four heuristics above.</li><li>If, after applying the heuristics, there are no valid options left, simply
assign one at random.</li></ul><p>Currently, only link adjacencies and angle differences are used to assign Golay
codes and channels for a new link.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="network-wide-reassignment-4">Network-Wide Reassignment<a class="hash-link" href="#network-wide-reassignment-4" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="identify-all-link-groups">Identify all link groups<a class="hash-link" href="#identify-all-link-groups" title="Direct link to heading">​</a></h5><p>A set of links belongs to the same <em>link group</em> if they must all share the same
Golay code/channel assignment. Links originating from or terminating at the same
radio are part of the same group. For example, all links forming a z-street
setup are part of the same group. The figure below illustrates this concept.</p><p align="center"><img loading="lazy" src="/figures/golay_groups.png" width="750" class="img_ev3q"></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="estimate-group-interference-matrix">Estimate group interference matrix<a class="hash-link" href="#estimate-group-interference-matrix" title="Direct link to heading">​</a></h5><p>The <em>group-to-group interference estimate</em> is the sum of the estimated
interference between all links within each group. The controller uses a
topology-based approach to estimate the interference between any two nodes. In
this approach, distance between nodes, Angle-of-Departure (AoD), and
Angle-of-Arrival (AoA) are used to estimate the interference experienced by both
ends of a link caused by transmission on another link.</p><p>For this purpose, the controller assumes perfect alignment between the radio
and its corresponding link under consideration. Constant transmission power is
also assumed across all links. When assigning Golay codes, the controller
assumes zero interference between links on different channels.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="build-the-group-interference-graph">Build the group interference graph<a class="hash-link" href="#build-the-group-interference-graph" title="Direct link to heading">​</a></h5><p>Next, the controller constructs a graph in which the vertices are the
previously-identified link groups. An edge is added between any two groups with
a non-zero interference estimate.</p><p>The resultant graph is the <em>group interference graph</em>. The task of assigning
Golay codes/channels to different groups is equivalent to solving the graph
coloring problem using a number of colors that is equal to the number of
available Golay codes or channels.</p><p>Since only two orthogonal Golay codes are available for allocation
the <em>odd cycle cover (OCC)</em> algorithm is used to convert the graph into a
bipartite graph by removing the least number of groups while minimizing the
overall network interference. This uses the same OCC algorithm as the one for
polarity optimization. Channel assignment also uses this algorithm to attempt
to minimize the number of channel allocations that add to the overall
network interference.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="allocate-golay-codes-or-channels">Allocate Golay codes or channels<a class="hash-link" href="#allocate-golay-codes-or-channels" title="Direct link to heading">​</a></h5><p>Any predetermined Golay codes/channels within the node configuration overrides
are assigned first. These manual configurations can be ignored and overridden by
setting the <code>clearUserConfig</code> flag.</p><p>Next, Golay codes/channels are assigned for all groups not identified
for exclusion by the OCC algorithm. These groups will form a bipartite graph and
can be allocated Golay codes/channels that avoid all interference between them.</p><p>Finally, Golay codes/channels are assigned for the groups identified by the OCC
algorithm. In this case, the Golay code/channel that minimizes the overall
interference experienced by the link group is selected.</p><p><strong>Note</strong>: The recommended order of optimizations is polarity, then channel,
then Golay. This is because the channel assignments depend on polarity, and the
Golay assignments depend on both polarity and channel.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="network-state">Network State<a class="hash-link" href="#network-state" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="node-status">Node Status<a class="hash-link" href="#node-status" title="Direct link to heading">​</a></h3><p>Node state is managed by <code>StatusApp</code> on the controller and minion. The minion
sends <code>STATUS_REPORT</code> heartbeats at regular intervals to the controller, and
includes details such as its ignition/configuration/upgrade state and
software/hardware versions in these heartbeats. The controller replies with
<code>STATUS_REPORT_ACK</code> acknowledgements. If the minion does not receive any
acknowledgements or other messages from the controller within a specified
timeout period, it will attempt to tear down the current network socket to the
controller and reconnect (refer to
<a href="/docs/developer/Communication_Protocol">Communication Protocol</a> for further details).
Meanwhile, <code>TopologyApp</code> periodically computes all node liveness states based on
the last time a heartbeat was received from each node.</p><p>A node&#x27;s liveness is derived from its ignition state. The ignition state
lifecycle differs for DNs and CNs:</p><ul><li><strong>DN</strong> - <code>OFFLINE</code> → <code>ONLINE</code> → <code>ONLINE_INITIATOR</code></li><li><strong>CN</strong> - <code>OFFLINE</code> → <code>ONLINE</code></li></ul><p>All nodes initially boot into the <code>OFFLINE</code> status. For each radio, the minion&#x27;s
<code>StatusApp</code> sends a <code>NODE_INIT</code> message to its <code>DriverApp</code> containing initial
firmware parameters, then starts sending heartbeats to the controller upon
receiving any <code>NODE_INIT_NOTIFY</code> success notification from <code>DriverApp</code>. The
minion then sends a <code>FW_SET_NODE_PARAMS</code> message to the driver with polarity,
channel, and airtime parameters from its node configuration (if present), and
also a <code>GPS_ENABLE_REQ</code> message to enable GPS (if applicable; read below).</p><p>When the controller&#x27;s <code>StatusApp</code> receives a heartbeat from a node with an
<code>OFFLINE</code> status, it sends a <code>SET_NODE_PARAMS_REQ</code> request to <code>TopologyApp</code>,
which then sends <code>SET_NODE_PARAMS</code> (<code>INIT</code>) message(s) to the minion&#x27;s
<code>StatusApp</code> (one message per WLAN MAC address). Upon receipt, the minion marks
itself as <code>ONLINE</code> (if GPS is disabled) or <code>ONLINE_INITIATOR</code> (if GPS was
already enabled). If the node had not already configured its polarity, channel,
etc. during initialization (i.e. the parameters are not in the node&#x27;s local
configuration file), it does so now with the parameters sent from the
controller. The controller&#x27;s <code>StatusApp</code> will also request the status of the
node&#x27;s wireless links at this time.</p><p>For DNs, transitioning to <code>ONLINE_INITIATOR</code> requires enabling GPS to achieve
time synchronization. This requires knowledge of the node&#x27;s physical site
location. Periodically, <code>TopologyApp</code> looks for DNs that are <code>ONLINE</code> and does
the following:</p><ul><li>If the node&#x27;s site location accuracy is within 50 meters
(<code>E2EConsts::kGpsAccuracyThresh</code>, required for GPS time estimation within
500ns) <em>or</em> the <code>forceGpsDisable</code> firmware config flag is set, the controller
sends a <code>SET_NODE_PARAMS</code> (<code>GPS</code>) message to the minion&#x27;s <code>StatusApp</code>. Upon
receipt, the minion sends a <code>GPS_ENABLE_REQ</code> to the driver, and marks itself
as <code>ONLINE_INITIATOR</code> after receiving a <code>FW_ACK</code> (<code>GPS_ENABLE_REQ</code>)
acknowledgement that the GPS was successfully enabled.</li><li>If the node&#x27;s location is too inaccurate, the controller sends a
<code>GPS_GET_POS_REQ</code> message to the minion&#x27;s <code>StatusApp</code>, which forwards it to
the driver. The minion responds with its current GPS position
(<code>GPS_GET_POS_RESP</code>), and the controller uses this to update its topology
information only if the newly-reported location is more accurate than the
existing one.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="link-status">Link Status<a class="hash-link" href="#link-status" title="Direct link to heading">​</a></h3><p>Wireless link state is managed by <code>IgnitionApp</code> on the controller and minion.
Every time the status of a wireless link changes, the minion sends a
<code>LINK_STATUS</code> message to <code>TopologyApp</code>. In some cases, the controller&#x27;s
<code>TopologyApp</code>, <code>IgnitionApp</code>, or <code>StatusApp</code> will actively request a link status
by sending a <code>GET_LINK_STATUS</code> message. If the controller receives a <code>LINK_UP</code>
event for a link which does not exist in the current topology, it will
forcefully disassociate the link. When the controller receives a <code>LINK_DOWN</code>
event for a DN-to-DN link where either side is a P2MP DN with other active
links, it will disable BF responder mode to avoid throughput loss on these
links. Refer to <a href="/docs/developer/Network_Ignition">Network Ignition</a> for further details
about the link ignition process.</p><p>Wired intra-site link state is maintained by <code>StatusApp</code> on the controller and
minion. Each minion&#x27;s status report contains status of its wired connections.
When this status changes, the controller&#x27;s <code>StatusApp</code> sends a
<code>SET_WIRED_LINK_STATUS</code> message to <code>TopologyApp</code>. Wired inter-site link state is
not checked, and these links will always appear as alive.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="gps-time-synchronization">GPS Time Synchronization<a class="hash-link" href="#gps-time-synchronization" title="Direct link to heading">​</a></h3><p>The controller uses its local clock for scheduling (e.g. scan commands, firmware
configuration changes). To ensure its clock is synchronized with GPS-based node
clocks, the controller updates its clock based on GPS timestamps sent from each
node.</p><p><code>GpsClock</code> is a custom clock used to hold GPS time. It is designed to receive
periodic updates from an accurate GPS source, and fill in the remaining
intervals using a <code>std::chrono::steady_clock</code> delta since the last GPS time was
received.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="minion-procedure">Minion Procedure<a class="hash-link" href="#minion-procedure" title="Direct link to heading">​</a></h4><p>The node firmware attaches the current GPS timestamp to periodic <code>FW_HEALTHY</code>
messages sent to minion. The minion&#x27;s <code>StatusApp</code> uses this timestamp to update
its <code>GpsClock</code> instance directly (assuming no significant latency on message
passing), and sends GPS time to the controller in periodic status reports
(<code>STATUS_REPORT</code> messages).</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="controller-procedure">Controller Procedure<a class="hash-link" href="#controller-procedure" title="Direct link to heading">​</a></h4><p>Upon receipt of a GPS timestamp, the controller&#x27;s <code>StatusApp</code> uses
<a href="https://en.wikipedia.org/wiki/Cristian%27s_algorithm" target="_blank" rel="noopener noreferrer">Cristian&#x27;s algorithm</a> to address network latency. Nodes are considered the time
servers, and the controller is considered the client. The latency in both
directions is assumed to be symmetric. The latency correction algorithm is
described below.</p><ol><li>The controller records the GPS time of the last status report received from
each node (as <em>t1</em>), then sends an acknowledgement to the minion.</li><li>The minion records the GPS timestamp of the latest status report
acknowledgement it received from the controller (as <em>t2</em>).</li><li>When sending a status report to the controller, the minion includes its
current GPS time (as <em>t3</em>) as well as the GPS timestamp of the latest status
report acknowledgement it received (<em>t2</em>). The controller subtracts out the
time delay between <em>t2</em> and <em>t3</em> when computing the round-trip time.</li><li>On receipt of a status report, the controller records its current GPS time
(as <em>t4</em>). Then, it uses the recorded timestamp values to add a latency
correction to the GPS timestamp reported by the node (<em>t3</em>) as follows:</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Round-trip time = rtt = (t4 - t1) - (t3 - t2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Latency of response = latency = rtt / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Latency-corrected GPS time = t3 + latency</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As the controller collects a series of timestamps from nodes, it uses
<a href="https://en.wikipedia.org/wiki/Chauvenet%27s_criterion" target="_blank" rel="noopener noreferrer">Chauvenet&#x27;s criterion</a> to determine if incoming timestamps are outliers. The
algorithm used to determine if a timestamp is an outlier is described below.</p><ol><li>On receipt of a GPS timestamp, calculate the delta between the timestamp
(after applying Cristian&#x27;s algorithm to correct for latency) and the
controller&#x27;s GPS clock.</li><li>Calculate the mean and standard deviation of the list of existing timestamps
that the controller has stored.</li><li>Use a normal distribution to calculate the probability of seeing the
timestamp that just arrived, based off of the mean and standard deviation
calculated above.</li><li>Apply Chauvenet&#x27;s criterion to determine if the timestamp is an outlier.
Multiply the probability of seeing the timestamp by the number of past
timestamps the controller is tracking. If this value is less than 0.5, the
timestamp is considered an outlier.</li><li>Add the timestamp to the list of timestamps stored on the controller.</li><li>If the new timestamp is not an outlier, use it to set the controller&#x27;s
<code>GpsClock</code> epoch.</li></ol><p>Chauvenet&#x27;s criterion is not applied until at least 6 timestamps have arrived
(<code>FLAGS_min_gps_timestamp_queue_size</code>). The controller only tracks the last 20
timestamps (<code>FLAGS_max_gps_timestamp_queue_size</code>).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a class="hash-link" href="#references" title="Direct link to heading">​</a></h2><ul><li><a href="https://standards.ieee.org/findstds/standard/802.11-2016.html" target="_blank" rel="noopener noreferrer">IEEE 802.11-2016</a> - IEEE 802.11-2016 standard</li><li><a href="https://tools.ietf.org/html/rfc4632" target="_blank" rel="noopener noreferrer">CIDR</a> - Classless Inter-domain Routing (RFC 4632)</li><li><a href="https://en.wikipedia.org/wiki/Cristian%27s_algorithm" target="_blank" rel="noopener noreferrer">Cristian&#x27;s algorithm</a> - Clock synchronization algorithm</li><li><a href="https://en.wikipedia.org/wiki/Chauvenet%27s_criterion" target="_blank" rel="noopener noreferrer">Chauvenet&#x27;s criterion</a> - Outlier detection criterion</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/terragraph/meta-terragraph/edit/main/docs/../docs/developer/Topology_Management.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/developer/Firmware_Stats"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Firmware Stats</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/developer/Network_Ignition"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Network Ignition</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#network-elements" class="table-of-contents__link toc-highlight">Network Elements</a></li><li><a href="#topology-structure" class="table-of-contents__link toc-highlight">Topology Structure</a></li><li><a href="#topology-changes" class="table-of-contents__link toc-highlight">Topology Changes</a></li><li><a href="#parameter-assignment-and-validation" class="table-of-contents__link toc-highlight">Parameter Assignment and Validation</a><ul><li><a href="#polarity" class="table-of-contents__link toc-highlight">Polarity</a></li><li><a href="#golay-index" class="table-of-contents__link toc-highlight">Golay Index</a></li><li><a href="#channel" class="table-of-contents__link toc-highlight">Channel</a></li><li><a href="#control-superframe" class="table-of-contents__link toc-highlight">Control Superframe</a></li><li><a href="#airtime" class="table-of-contents__link toc-highlight">Airtime</a></li><li><a href="#algorithms-for-channel-and-golay-assignment" class="table-of-contents__link toc-highlight">Algorithms for Channel and Golay Assignment</a></li></ul></li><li><a href="#network-state" class="table-of-contents__link toc-highlight">Network State</a><ul><li><a href="#node-status" class="table-of-contents__link toc-highlight">Node Status</a></li><li><a href="#link-status" class="table-of-contents__link toc-highlight">Link Status</a></li><li><a href="#gps-time-synchronization" class="table-of-contents__link toc-highlight">GPS Time Synchronization</a></li></ul></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Terragraph</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/runbook/Overview">Overview</a></li><li class="footer__item"><a href="https://www.facebook.com/connectivity" target="_blank" rel="noopener noreferrer" class="footer__link-item">Meta Connectivity<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/terragraph" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/HQaxCevzus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.ee1b3ecd.js"></script>
<script src="/assets/js/main.feb34f19.js"></script>
</body>
</html>