<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-developer/High_Availability">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="search" type="application/opensearchdescription+xml" title="Terragraph" href="/opensearch.xml">
<link rel="stylesheet" href="/katex/katex.min.css"><title data-rh="true">High Availability | Terragraph</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://terragraph.com/logo/terragraph-logo-full-RGB.png"><meta data-rh="true" name="twitter:image" content="https://terragraph.com/logo/terragraph-logo-full-RGB.png"><meta data-rh="true" property="og:url" content="https://terragraph.com/docs/developer/High_Availability"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="High Availability | Terragraph"><meta data-rh="true" name="description" content="This document describes the high-availability protocol used by the E2E"><meta data-rh="true" property="og:description" content="This document describes the high-availability protocol used by the E2E"><link data-rh="true" rel="icon" href="/logo/terragraph-logo-favicon-32x32-full-RGB.png"><link data-rh="true" rel="canonical" href="https://terragraph.com/docs/developer/High_Availability"><link data-rh="true" rel="alternate" href="https://terragraph.com/docs/developer/High_Availability" hreflang="en"><link data-rh="true" rel="alternate" href="https://terragraph.com/docs/developer/High_Availability" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TB9T0CGM6Y-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.48218837.css">
<link rel="preload" href="/assets/js/runtime~main.ee1b3ecd.js" as="script">
<link rel="preload" href="/assets/js/main.feb34f19.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo/terragraph-logo-favicon-32x32-full-RGB.svg" alt="Terragraph Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/logo/terragraph-logo-favicon-32x32-white-RGB.svg" alt="Terragraph Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/terragraph/meta-terragraph" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link githubButton navbarIconButton" title="GitHub"></a><a href="https://discord.gg/HQaxCevzus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link discordButton navbarIconButton" title="Discord"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/runbook">Runbook</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/developer">Developer Manual</a></li><li><a class="dropdown__link" href="/docs/whitepapers">Whitepapers</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/developer">Developer Manual</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developer Manual&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Communication_Protocol">Architecture</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Beamforming_Link_Adaptation">Firmware Layer</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Topology_Management">End-to-End (E2E) Service</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Stats_Events_Logs">Application Layer Modules</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/developer/Service_Scripts">System Management</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Service_Scripts">Service Scripts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Watchdog">Watchdog</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/developer/High_Availability">High Availability</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Security">Security</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Release_Conventions">Version Control</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/developer"><span itemprop="name">Developer Manual</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">System Management</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">High Availability</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>High Availability</h1><p>This document describes the high-availability protocol used by the E2E
controller.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a class="hash-link" href="#overview" title="Direct link to heading">​</a></h2><p>The controller supports a high-availability configuration using a primary-backup
protocol, loosely based on the <a href="http://zguide.zeromq.org/php:chapter4#High-Availability-Pair-Binary-Star-Pattern" target="_blank" rel="noopener noreferrer">Binary Star Pattern</a>. In this setup, two
controllers (or &quot;peers&quot;) are run on separate machines, and are designated as
either &quot;primary&quot; or &quot;backup&quot;. If the primary catastrophically fails (e.g. power
outage, network failure, hardware failure), the backup will assume control of
the Terragraph network.</p><p>These are the major components:</p><ul><li>The underlying <em>finite state machine (FSM)</em>, determining each controller&#x27;s
state in response to events (either receiving the peer&#x27;s state or a client
request). This state machine is defined within <code>BinaryStarFsm</code>.</li><li>The <em>FSM driver</em> for heartbeating between peers and passing events to the
state machine. This is done jointly by <code>BinaryStarApp</code> and the controller&#x27;s
<code>Broker</code>.</li><li>The <em>data synchronization layer</em>, which syncs persistent controller data
(e.g. node configuration, network topology) from the active to passive
controller. This is done in <code>BinaryStarApp</code>, with handlers in the associated
apps.</li><li>The <em>client layer</em>, which switches between the primary and backup controllers
whenever its current connection times out. This logic is handled by the
minion&#x27;s <code>Broker</code>.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="protocol">Protocol<a class="hash-link" href="#protocol" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="finite-state-machine">Finite State Machine<a class="hash-link" href="#finite-state-machine" title="Direct link to heading">​</a></h3><p align="center"><img loading="lazy" src="/figures/bstar_fsm.svg" width="550" class="img_ev3q"></p><p>Each controller&#x27;s state is comprised of two pieces:</p><ul><li>The <em>initial</em> fixed configuration (<em>primary</em>, <em>backup</em>)</li><li>The <em>runtime</em> FSM state (<code>PRIMARY</code>, <code>BACKUP</code>, <code>ACTIVE</code>, <code>PASSIVE</code>)</li></ul><p>Each controller stays in its initial state (<code>PRIMARY</code>/<code>BACKUP</code>) until it hears
its peer&#x27;s state, triggering the FSM state change to <code>ACTIVE</code>/<code>PASSIVE</code>. Thus,
there are two &quot;steady states&quot; for the high-availability pair:</p><ul><li><code>ACTIVE</code> <em>primary</em> &lt;--&gt; <code>PASSIVE</code> (or offline) <em>backup</em></li><li><code>ACTIVE</code> <em>backup</em> &lt;--&gt; <code>PASSIVE</code> (or offline) <em>primary</em></li></ul><p>The peers exchange periodic heartbeats to determine liveness. A controller will
consider its peer &quot;dead&quot; if a set interval elapses without receiving any
heartbeats. However, a <em>passive</em> (<code>BACKUP</code>/<code>PASSIVE</code>) controller will only
become <em>active</em> (<code>ACTIVE</code>) if two conditions are met simultaneously:</p><ul><li>Its peer is dead (<em>peer timeout</em>)</li><li>It receives a message from an E2E minion (<em>client request</em>)</li></ul><p>The E2E minion (client) only connects to one controller at any given time. If it
receives no response from the current controller for a set period
(<em>controller timeout</em>), it will disconnect and try connecting to the other
controller. This is the only way to trigger controller failover.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="split-brain">Split-Brain<a class="hash-link" href="#split-brain" title="Direct link to heading">​</a></h4><p>Split-brain (i.e. dual-actives) is avoided <strong>only</strong> if it is impossible to
partition the network such that a subset of nodes can see each controller while
the controllers cannot see each other.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="automatic-recovery">Automatic Recovery<a class="hash-link" href="#automatic-recovery" title="Direct link to heading">​</a></h4><p>The FSM additionally supports <em>automatic recovery</em> of the primary controller. If
an <code>ACTIVE</code> <em>backup</em> sees that the <em>primary</em> has come back online, it will yield
control once it deems the <code>PRIMARY</code> to be stable (i.e. it has received a set
number of consecutive heartbeats). All connected clients will be explicitly
notified to switch controller URLs to avoid timeouts.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="exceptional-states">Exceptional States<a class="hash-link" href="#exceptional-states" title="Direct link to heading">​</a></h4><p>If an exceptional FSM state occurs (ex. peers reconnecting after a network
partition to find they have split-brained), peers will attempt to recover by
reverting to their initial states (<code>PRIMARY</code>/<code>BACKUP</code>).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-synchronization">Data Synchronization<a class="hash-link" href="#data-synchronization" title="Direct link to heading">​</a></h3><p>The <code>ACTIVE</code> controller sends new <em>application data</em> to the <code>PASSIVE</code> as part of
the heartbeat message. It also attaches a <em>sequence number</em>, which the <code>PASSIVE</code>
echoes back in its heartbeat. Lastly, both controllers include their <em>software
version</em>, and will <strong>not</strong> sync data if these versions mismatch. This heartbeat
Thrift structure is shown below.</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">BinaryStarSync</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> BinaryStarFsmState state</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> i32 seqNum</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">3</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> BinaryStarAppData data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string version</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If the <code>ACTIVE</code> controller receives a heartbeat with a mismatching sequence
number, it will send a full copy of its data with the next heartbeat. Otherwise,
it will only send data that changed since the last heartbeat, if any. The
sequence number is only incremented when new data or the full data is sent, not
on every heartbeat.</p><p>When a controller becomes <code>ACTIVE</code>, it will reset its sequence number, then
request current data to be sent from all its applications. Sequence numbers are
initialized to 0, but the first heartbeat from the <code>ACTIVE</code> peer will have a
sequence number of 1 because new application data was requested.</p><p>Only a <code>PASSIVE</code> controller will update its sequence number when receiving a
heartbeat. This guarantees that the first heartbeat sent to the <code>ACTIVE</code> will
mismatch (since 0 cannot match), and thus trigger full data sync on the next
heartbeat.</p><p>Note that the data synchronization protocol is strictly best-effort; it is
<strong>not</strong> fully fault-tolerant.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="architecture">Architecture<a class="hash-link" href="#architecture" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="controller">Controller<a class="hash-link" href="#controller" title="Direct link to heading">​</a></h3><ul><li><code>BinaryStarFsm</code> - Contains a static function representing the state machine.
The actual states, events, and structs are defined in <code>Controller.thrift</code>.</li><li><code>Broker</code> - Maintains a copy of the FSM. When receiving a client request, the
FSM will indicate whether to drop the request (when <em>passive</em>), forward it
(when <em>active</em>), or trigger controller failover (to become <em>active</em>).</li><li><code>BinaryStarApp</code> - Maintains a synchronized copy of the FSM, as well as ZMQ
PUB/SUB sockets with the peer (for sending and receiving heartbeats). This is
the main driver for the FSM, and also handles data synchronization between
peers and with controller apps.</li><li>Controller apps with persistent data (e.g. <code>ConfigApp</code>, <code>TopologyApp</code>) -
Install handlers to send data (if <em>active</em>) or receive data (if <em>passive</em>)
to and from <code>BinaryStarApp</code>.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="minion">Minion<a class="hash-link" href="#minion" title="Direct link to heading">​</a></h3><ul><li><code>Broker</code> - Read the primary and backup controller URL, and switch between them
if the current connection times out.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="usage">Usage<a class="hash-link" href="#usage" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="controller-configuration">Controller Configuration<a class="hash-link" href="#controller-configuration" title="Direct link to heading">​</a></h3><p>The primary and backup controllers must know each other&#x27;s identity and initial
configuration on startup. This initial configuration is passed as flags:</p><table><thead><tr><th>Flag</th><th>Description</th></tr></thead><tbody><tr><td><code>bstar_primary</code></td><td>Whether this controller is the primary (<em>true</em>) or backup (<em>false</em>)</td></tr><tr><td><code>bstar_pub_port</code></td><td>The port that the controller publishes heartbeats on</td></tr><tr><td><code>bstar_peer_host</code></td><td>The hostname or IP address of the peer controller</td></tr><tr><td><code>bstar_peer_pub_port</code></td><td>The publisher port on the peer controller</td></tr><tr><td><code>disable_bstar</code></td><td>Whether to disable the high availability feature</td></tr></tbody></table><p>High-availability mode is only enabled if <code>bstar_peer_host</code> is explicitly set,
and <code>disable_bstar</code> is off or not set. The primary should be started <strong>before</strong>
the backup, or else the backup may become <code>ACTIVE</code>.</p><p>There are additional flags to tune timings:</p><table><thead><tr><th>Flag</th><th>Description</th></tr></thead><tbody><tr><td><code>bstar_heartbeat_period_ms</code></td><td>Heartbeat interval (in ms)</td></tr><tr><td><code>bstar_failover_missed_heartbeats</code></td><td>Number of missed heartbeats before declaring the peer &quot;dead&quot;</td></tr><tr><td><code>bstar_primary_recovery_heartbeats</code></td><td>Number of consecutive heartbeats before an <code>ACTIVE</code> <em>backup</em> performs <em>automatic recovery</em> (0 to disable)</td></tr></tbody></table><p>The backup controller URL is passed to the minion using Open/R&#x27;s <code>KvStore</code>, the
same way as the primary URL. The key is <code>e2e-ctrl-url-backup</code>, and can be added
to any node&#x27;s configuration (e.g. a POP node) as part of <code>kvstoreParams</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="viewing-runtime-state">Viewing Runtime State<a class="hash-link" href="#viewing-runtime-state" title="Direct link to heading">​</a></h3><p>The controller can be queried for the current FSM state using the
<code>BSTAR_GET_STATE</code> message. This is sent as part of the <code>tg version controller</code>
command in the TG CLI, and is returned via the <code>/api/getHighAvailabilityState</code>
endpoint in the REST API service.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="upgrade-procedure">Upgrade Procedure<a class="hash-link" href="#upgrade-procedure" title="Direct link to heading">​</a></h3><p>When performing software upgrades on both controllers, upgrade the <em>backup</em>
controller first, then the <em>primary</em> controller. Note that the controllers will
not sync data when the versions mismatch, so any changes from the <code>ACTIVE</code>
controller will <strong>not</strong> propagate to the <code>PASSIVE</code> during this time. This is
done to prevent any potential issues with configuration management between
different controller versions, especially if migration steps are required as
part of a software upgrade.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a class="hash-link" href="#resources" title="Direct link to heading">​</a></h2><ul><li><a href="http://zguide.zeromq.org/php:chapter4#High-Availability-Pair-Binary-Star-Pattern" target="_blank" rel="noopener noreferrer">Binary Star Pattern</a> - ZMQ&#x27;s primary-backup high-availability design</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/terragraph/meta-terragraph/edit/main/docs/../docs/developer/High_Availability.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/developer/Watchdog"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Watchdog</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/developer/Security"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Security</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#protocol" class="table-of-contents__link toc-highlight">Protocol</a><ul><li><a href="#finite-state-machine" class="table-of-contents__link toc-highlight">Finite State Machine</a></li><li><a href="#data-synchronization" class="table-of-contents__link toc-highlight">Data Synchronization</a></li></ul></li><li><a href="#architecture" class="table-of-contents__link toc-highlight">Architecture</a><ul><li><a href="#controller" class="table-of-contents__link toc-highlight">Controller</a></li><li><a href="#minion" class="table-of-contents__link toc-highlight">Minion</a></li></ul></li><li><a href="#usage" class="table-of-contents__link toc-highlight">Usage</a><ul><li><a href="#controller-configuration" class="table-of-contents__link toc-highlight">Controller Configuration</a></li><li><a href="#viewing-runtime-state" class="table-of-contents__link toc-highlight">Viewing Runtime State</a></li><li><a href="#upgrade-procedure" class="table-of-contents__link toc-highlight">Upgrade Procedure</a></li></ul></li><li><a href="#resources" class="table-of-contents__link toc-highlight">Resources</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Terragraph</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/runbook/Overview">Overview</a></li><li class="footer__item"><a href="https://www.facebook.com/connectivity" target="_blank" rel="noopener noreferrer" class="footer__link-item">Meta Connectivity<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/terragraph" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/HQaxCevzus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.ee1b3ecd.js"></script>
<script src="/assets/js/main.feb34f19.js"></script>
</body>
</html>