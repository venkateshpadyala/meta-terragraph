<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-developer/Topology_Discovery">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="search" type="application/opensearchdescription+xml" title="Terragraph" href="/opensearch.xml">
<link rel="stylesheet" href="/katex/katex.min.css"><title data-rh="true">Topology Discovery | Terragraph</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://terragraph.com/logo/terragraph-logo-full-RGB.png"><meta data-rh="true" name="twitter:image" content="https://terragraph.com/logo/terragraph-logo-full-RGB.png"><meta data-rh="true" property="og:url" content="https://terragraph.com/docs/developer/Topology_Discovery"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Topology Discovery | Terragraph"><meta data-rh="true" name="description" content="This document describes Terragraph&#x27;s topology discovery feature."><meta data-rh="true" property="og:description" content="This document describes Terragraph&#x27;s topology discovery feature."><link data-rh="true" rel="icon" href="/logo/terragraph-logo-favicon-32x32-full-RGB.png"><link data-rh="true" rel="canonical" href="https://terragraph.com/docs/developer/Topology_Discovery"><link data-rh="true" rel="alternate" href="https://terragraph.com/docs/developer/Topology_Discovery" hreflang="en"><link data-rh="true" rel="alternate" href="https://terragraph.com/docs/developer/Topology_Discovery" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TB9T0CGM6Y-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.48218837.css">
<link rel="preload" href="/assets/js/runtime~main.ee1b3ecd.js" as="script">
<link rel="preload" href="/assets/js/main.feb34f19.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo/terragraph-logo-favicon-32x32-full-RGB.svg" alt="Terragraph Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/logo/terragraph-logo-favicon-32x32-white-RGB.svg" alt="Terragraph Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/terragraph/meta-terragraph" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link githubButton navbarIconButton" title="GitHub"></a><a href="https://discord.gg/HQaxCevzus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link discordButton navbarIconButton" title="Discord"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/runbook">Runbook</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/developer">Developer Manual</a></li><li><a class="dropdown__link" href="/docs/whitepapers">Whitepapers</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/developer">Developer Manual</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developer Manual&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Communication_Protocol">Architecture</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Beamforming_Link_Adaptation">Firmware Layer</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/developer/Topology_Management">End-to-End (E2E) Service</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Topology_Management">Topology Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Network_Ignition">Network Ignition</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Software_Upgrade">Software Upgrade</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Configuration_Management">Configuration Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Scans">Scans</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Network_Measurements">Network Measurements</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Prefix_Allocation">Prefix Allocation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/developer/Topology_Discovery">Topology Discovery</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Stats_Events_Logs">Application Layer Modules</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Service_Scripts">System Management</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Release_Conventions">Version Control</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/developer"><span itemprop="name">Developer Manual</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">End-to-End (E2E) Service</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Topology Discovery</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Topology Discovery</h1><p>This document describes Terragraph&#x27;s topology discovery feature.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a class="hash-link" href="#overview" title="Direct link to heading">​</a></h2><p><code>TopologyBuilderApp</code> orchestrates the high-level topology discovery algorithm,
which extends the topology by incrementally adding and establishing links to
responding nodes. The main piece of the algorithm is the broadcast beamforming
protocol, or &quot;topology scan&quot; (refer to <a href="/docs/developer/Scans">Scans</a> for further details).</p><p>There are currently three actions available in <code>TopologyBuilderApp</code>:</p><ol><li>Running a single-node topology scan, and receiving results synchronously.</li><li>Coordinating a network-wide topology discovery.</li><li>Coordinating a link discovery within a search radius.</li></ol><p>These actions are outlined in the sections below.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="single-node-topology-scan">Single-Node Topology Scan<a class="hash-link" href="#single-node-topology-scan" title="Direct link to heading">​</a></h2><p>The goal of the single-node topology scan command is to provide a synchronous
wrapper over <code>ScanApp</code>&#x27;s API, along with more detailed response data.
<code>TopologyBuilderApp</code> goes through the following steps upon receiving a
<code>START_TOPOLOGY_SCAN</code> command:</p><ol><li>Send a <code>START_SCAN</code> request to <code>ScanApp</code>. If successful, <code>ScanApp</code> will reply
with a <code>START_SCAN_RESP</code> message containing a unique scan identifier (or
&quot;token&quot;) that will be used to tag the scan results.</li><li><code>ScanApp</code> forwards all topology scan results to <code>TopologyBuilderApp</code> in the
<code>TOPOLOGY_SCAN_RESULT</code> message. Process the raw scan results and return a
<code>START_TOPOLOGY_SCAN_RESP</code> response to the original sender.</li></ol><p>Scan result processing is handled within
<code>TopologyBuilder::processTopologyScanResult()</code>. For each responder, this finds
the <em>strongest beam</em> with the <em>smallest beam angle</em> using the
initiator-to-responder LQM (link quality metric) matrix. This also identifies
the nearest site in the topology via GPS distance.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="network-wide-topology-discovery">Network-Wide Topology Discovery<a class="hash-link" href="#network-wide-topology-discovery" title="Direct link to heading">​</a></h2><p>The following user operations are available for managing network-wide topology
discovery scans:</p><table><thead><tr><th>User Operation</th><th>Command</th></tr></thead><tbody><tr><td>Start Scans</td><td><code>START_NETWORK_TOPOLOGY_SCAN</code></td></tr><tr><td>Stop Scans</td><td><code>STOP_NETWORK_TOPOLOGY_SCAN</code></td></tr><tr><td>Get Status</td><td><code>GET_NETWORK_TOPOLOGY_SCAN_STATUS</code></td></tr></tbody></table><p>The <em>inputs</em> to the procedure are as follows:</p><ul><li><strong>Sites</strong> - All site locations should be added to the topology beforehand
(responding nodes are matched to the nearest site).</li><li><strong>Links between sites</strong> - Site-level link information (<code>thrift::SiteLink</code>)
provided in the request will determine which links to form.</li></ul><p>The <em>outputs</em> of the procedure are as follows:</p><ul><li><strong>Nodes</strong> - All responder nodes and adjacent nodes/radios on the same site
will be added to the topology.</li><li><strong>Links between nodes</strong> - Node-level link information will be added to the
topology.</li></ul><p>The current implementation is heavily dependent on GPS accuracy to match
responder nodes to sites in the topology, and does not run scans in parallel.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="discovery-algorithm">Discovery Algorithm<a class="hash-link" href="#discovery-algorithm" title="Direct link to heading">​</a></h3><p>The topology discovery algorithm resides in <code>TopologyBuilder</code>, which contains
three main methods for handling a network-wide topology scan:</p><ul><li><code>initNetworkTopologyScan()</code> - Queues all sites specified in the scan request.</li><li><code>networkTopologyScanLoop()</code> - Advances the algorithm.</li><li><code>handleScanResult()</code> - Stores a topology scan result.</li></ul><p>The scan loop is invoked once to initiate the scan, and then asynchronously upon
receiving new scan results or hitting a timeout. Sites are removed from the scan
queue after processing all scan results for the site. The loop terminates when
the site queue is empty.</p><p>Scan progress is recorded throughout the procedure and returned via the
<code>thrift::NetworkTopologyScanStatus</code> structure. This data persists in memory
until another scan is started.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="scan-parameters">Scan Parameters<a class="hash-link" href="#scan-parameters" title="Direct link to heading">​</a></h4><p>Scans are initiated via a <code>StartNetworkTopologyScan</code> request. The only required
parameter is the list of all <em>site links</em>, which <code>TopologyBuilder</code> uses to build
its <em>site queue</em> (of <code>SiteQueueEntry</code> entries).</p><p>The other tunable parameters are described below:</p><ul><li><strong>MAC addresses</strong> - If provided, only these specific MAC addresses may be
added to the topology, and other radios ignored. This is primarily used for
testing purposes.</li><li><strong>CN sites</strong> - All nodes added on the given sites will be labeled as CNs
(otherwise DNs).</li><li><strong>Y-street sites</strong> - DN radios on the given sites will be allowed to form two
DN-to-DN links (otherwise not allowed).</li><li><strong>Beam angle penalty</strong> - A coefficient penalizing high beam angles at the
transmitter or receiver when deciding the best link to form, because
properly-aligned P2P links should normally be close to boresight. This penalty
is not applied to P2MP sites, since the beam angle should <em>average</em> to zero
degrees across all links of a P2MP radio. The default penalty of <em>0.1</em> would
penalize a combined beam angle (i.e. sum of the absolute values of transmit
and receive angles) of 45 degrees by an SNR of 4.5dB.</li><li><strong>Distance threshold</strong> - The maximum distance, in meters, to allow between a
responder&#x27;s reported GPS position and the nearest site in order to compensate
for GPS inaccuracies. Nodes located further away are ignored. The default
distance threshold is <em>50 meters</em>.</li><li><strong>SNR threshold</strong> - The minimum signal-to-noise ratio, in decibels, to allow
on new links. The default SNR threshold of <em>6.1dB</em> is the minimum needed to
support MCS2 at a packet error rate of 1e-3.</li><li><strong>Scans per node</strong> - A scan request can be issued to each radio multiple times
to increase the likelihood of picking up all responders.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="scan-loop">Scan Loop<a class="hash-link" href="#scan-loop" title="Direct link to heading">​</a></h4><p>The scan loop determines the next action to perform based on the current site
queue state. It returns an <code>Action</code> structure encapsulating the results for
<code>TopologyBuilderApp</code> to then execute.</p><p>Starting at the site at the head of the queue, the loop proceeds as follows:</p><ul><li>Find any DN left to scan on the site. The DN must be alive; to account for
configuration-related reboots, the controller must have received a status
report at least 3 seconds after a configuration change was pushed to the node.<ul><li>If any valid DN was found, send it a topology scan request and wait for a
response.<ul><li>Upon receiving scan results, store them and invoke the loop again.</li><li>Upon a timeout, invoke the loop again.</li></ul></li><li>If no valid DN was found, check the following cases:<ul><li>If no scan results have been received so far, push the site to the
bottom of the queue and continue (a node may come online later).</li><li>If any DN left to scan on the site was recently online (within 90
seconds), wait because it may come back online soon (e.g. rebooting).</li><li>Otherwise, process the scan results for the site (see below). If all
site links have formed, remove the site from the queue; otherwise,
re-add the site to the bottom of the queue.</li></ul></li></ul></li><li>Upon reaching the end of the queue, terminate if the queue is empty, or wait
5 seconds if any sites remain.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="processing-results">Processing Results<a class="hash-link" href="#processing-results" title="Direct link to heading">​</a></h4><p>After collecting all scan results for a site, responders are filtered out
through any of the following conditions:</p><ul><li>The responder didn&#x27;t report a GPS location (possibly a transient issue).</li><li>No site link should form between the current site and the responder&#x27;s site.</li><li>The responder&#x27;s MAC address did not match the input filter, if any.</li><li>The responder does not meet distance or SNR thresholds.</li><li>The responder is already part of the topology <em>and</em> already has the maximum
number of links defined.</li><li>The responder is another radio on the node that initiated the scan.</li><li>The responder is already part of a different site (due to past or present GPS
errors).</li></ul><p>The remaining responders are grouped by their nearest site; site links are added
in a greedy manner, where <em>link quality</em> is defined as follows:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">link quality := SNR - (beam angle penalty * combined beam angle)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The chosen responders, their wired adjacencies (if applicable), and the
associated wireless links are added to the topology via a <code>BULK_ADD</code> request to
<code>TopologyApp</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="link-discovery">Link Discovery<a class="hash-link" href="#link-discovery" title="Direct link to heading">​</a></h2><p>Link discovery scans aim to find the best possible link(s) from an existing node
to a newly-installed node, issuing topology scans from each DN within a given
radius. This is implemented using most of the same logic as topology discovery
scans, but as only a single step (i.e. only the initial set of sites is
enqueued).</p><p>The following user operations are available for managing link discovery scans:</p><table><thead><tr><th>User Operation</th><th>Command</th></tr></thead><tbody><tr><td>Start Scans</td><td><code>START_LINK_DISCOVERY_SCAN</code></td></tr><tr><td>Stop Scans</td><td><code>STOP_NETWORK_TOPOLOGY_SCAN</code></td></tr><tr><td>Get Status</td><td><code>GET_LINK_DISCOVERY_SCAN_STATUS</code></td></tr></tbody></table><p>The output is a list of all possible links found; no topology changes are made
automatically.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="continuous-topology-scan">Continuous Topology Scan<a class="hash-link" href="#continuous-topology-scan" title="Direct link to heading">​</a></h2><p>Continuous topology scans can be used for physically aligning a responder node.
The purpose of the topology scan is to trigger a beamforming procedure on the
responder at a sweep rate of roughly 2 cycles per second (depending on firmware
parameters).</p><p>The &quot;continuous&quot; scan is implemented by running regular scans back-to-back,
scheduling them about 4 seconds in advance
(<code>FLAGS_continuous_topo_scan_start_time_offset_s</code>) and about 1.8s apart (as
computed with <code>ibfNumberOfBeams=31</code>, or overridden via
<code>FLAGS_continuous_topo_scan_bwgd_delta</code>). In this example, there would be a
cycle consisting of ~1.5s of sweeping followed by a ~300ms gap.</p><p>The following user operations are available for managing continuous topology
scans:</p><table><thead><tr><th>User Operation</th><th>Command</th></tr></thead><tbody><tr><td>Start/Stop Scans</td><td><code>START_CONTINUOUS_TOPO_SCAN</code></td></tr></tbody></table><p>An ongoing scan can be interrupted by sending another request with a duration of
zero.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="radio-alignment-using-continuous-topology-scans">Radio Alignment Using Continuous Topology Scans<a class="hash-link" href="#radio-alignment-using-continuous-topology-scans" title="Direct link to heading">​</a></h3><p>A continuous topology scan will continuously sweep through all (Tx, Rx) beam
combinations between the topology scan initiator (Tx beam sweep) and topology
scan responder(s) (Rx beam sweep). The beamforming stats (<code>TGF_STATS_BF</code>) at the
responder(s) can then be inspected to give quick alignment feedback, providing
higher layers with SNR/RSSI measurements for every packet detected. Note that
only a few of the (Tx, Rx) beam combinations detected at the responder(s) are
sent back to the initiator, so in general the information available at the
initiator is not enough to use for a robust alignment procedure.</p><p>Beamforming stats at each responder node contain the full heatmap of (Tx, Rx)
beam combinations, which can be used to determine the current angle of arrival
at the responder. As a simple example, if the (Tx, Rx) beam combination with
highest SNR at the responder corresponds to an Rx angle of +10 degrees relative
boresight, an installer could be instructed to rotate the responder node by +10
degrees so that the responder&#x27;s boresight is aligned to the line-of-sight path
to the initiator node. The beamforming stats can optionally be post-processed to
improve robustness, for example by averaging across packets in the time and/or
spatial domain, or by adding logic to distinguish reflections from the
line-of-sight path.</p><p>Note that the host processor and software stack must be able to consume the high
volume of <code>TGF_STATS_BF</code> stats generated by firmware to avoid loss. This can be
on the order of thousands of samples per second. Refer to
<a href="/docs/developer/Firmware_Stats">Firmware Stats</a> for a full list of available beamforming
stats.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/terragraph/meta-terragraph/edit/main/docs/../docs/developer/Topology_Discovery.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/developer/Prefix_Allocation"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Prefix Allocation</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/developer/Stats_Events_Logs"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Stats, Events, Logs</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#single-node-topology-scan" class="table-of-contents__link toc-highlight">Single-Node Topology Scan</a></li><li><a href="#network-wide-topology-discovery" class="table-of-contents__link toc-highlight">Network-Wide Topology Discovery</a><ul><li><a href="#discovery-algorithm" class="table-of-contents__link toc-highlight">Discovery Algorithm</a></li></ul></li><li><a href="#link-discovery" class="table-of-contents__link toc-highlight">Link Discovery</a></li><li><a href="#continuous-topology-scan" class="table-of-contents__link toc-highlight">Continuous Topology Scan</a><ul><li><a href="#radio-alignment-using-continuous-topology-scans" class="table-of-contents__link toc-highlight">Radio Alignment Using Continuous Topology Scans</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Terragraph</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/runbook/Overview">Overview</a></li><li class="footer__item"><a href="https://www.facebook.com/connectivity" target="_blank" rel="noopener noreferrer" class="footer__link-item">Meta Connectivity<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/terragraph" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/HQaxCevzus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.ee1b3ecd.js"></script>
<script src="/assets/js/main.feb34f19.js"></script>
</body>
</html>